<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruthLens AI - Advanced News Analysis</title>
    
    <!-- Chart.js for Trust Gauge -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* CSS Variables - Design System */
        :root {
            --primary: #1e3a8a;
            --primary-light: #3b82f6;
            --accent: #fbbf24;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --neutral: #64748b;
            --dark: #1e293b;
            --light: #f8fafc;
            
            --font-primary: 'Inter', -apple-system, sans-serif;
            --font-display: 'Playfair Display', serif;
            
            --space-xs: 0.5rem;
            --space-sm: 1rem;
            --space-md: 1.5rem;
            --space-lg: 2rem;
            --space-xl: 3rem;
            
            --radius: 0.75rem;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: var(--light);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Progress Bar - Always Visible */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 9999;
            display: none;
        }

        .progress-bar.active {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-light), var(--accent));
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-stage {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin-top: 0.5rem;
            white-space: nowrap;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-md) var(--space-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .logo i {
            font-size: 2rem;
            color: var(--primary);
        }

        .logo h1 {
            font-family: var(--font-display);
            font-size: 1.75rem;
            color: var(--dark);
        }

        .tagline {
            font-size: 0.875rem;
            color: var(--neutral);
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-lg);
        }

        /* Input Section */
        .input-section {
            background: white;
            border-radius: var(--radius);
            padding: var(--space-xl);
            box-shadow: var(--shadow);
            margin-bottom: var(--space-xl);
        }

        .input-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: var(--space-md);
            text-align: center;
        }

        .input-group {
            display: flex;
            gap: var(--space-sm);
            max-width: 800px;
            margin: 0 auto;
        }

        .url-input {
            flex: 1;
            padding: var(--space-sm) var(--space-md);
            border: 2px solid #e5e7eb;
            border-radius: var(--radius);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .url-input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .analyze-btn {
            padding: var(--space-sm) var(--space-lg);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .analyze-btn:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .analyze-btn:disabled {
            background: var(--neutral);
            cursor: not-allowed;
            transform: none;
        }

        /* Error Message */
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: var(--danger);
            padding: var(--space-sm);
            border-radius: var(--radius);
            margin-top: var(--space-sm);
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Results Section */
        .results-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* UPDATED: Compact Trust Score Section */
        .trust-score-section {
            background: white;
            border-radius: var(--radius);
            padding: var(--space-md);
            box-shadow: var(--shadow);
            margin-bottom: var(--space-lg);
            display: flex;
            align-items: center;
            gap: var(--space-lg);
        }

        .trust-gauge-container {
            width: 150px;
            height: 100px;
            flex-shrink: 0;
        }

        .trust-score-details {
            flex: 1;
        }

        .trust-level {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: var(--space-xs);
        }

        .trust-level.very-high { color: var(--success); }
        .trust-level.high { color: var(--success); }
        .trust-level.medium { color: var(--warning); }
        .trust-level.low { color: var(--danger); }
        .trust-level.very-low { color: var(--danger); }

        .trust-summary {
            color: var(--neutral);
            font-size: 0.95rem;
            line-height: 1.5;
            margin: 0;
        }

        .pdf-download-btn {
            padding: var(--space-xs) var(--space-md);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 0.875rem;
            white-space: nowrap;
        }

        .pdf-download-btn:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
        }

        /* UPDATED: Enhanced Article Summary */
        .article-summary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-radius: var(--radius);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-lg);
        }

        .article-title {
            font-family: var(--font-display);
            font-size: 1.75rem;
            margin-bottom: var(--space-sm);
        }

        .article-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
            opacity: 0.9;
        }

        .article-meta span {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 0.9rem;
        }

        .article-about {
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .article-about h4 {
            font-size: 1rem;
            margin-bottom: var(--space-xs);
            opacity: 0.9;
        }

        .article-about p {
            font-size: 0.95rem;
            line-height: 1.6;
            opacity: 0.85;
        }

        /* UPDATED: Enhanced Analysis Summary */
        .analysis-summary {
            background: white;
            border-radius: var(--radius);
            padding: var(--space-lg);
            box-shadow: var(--shadow);
            margin-bottom: var(--space-lg);
        }

        .summary-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: var(--space-md);
        }

        .key-findings {
            list-style: none;
            margin-bottom: var(--space-md);
        }

        .key-findings li {
            padding: var(--space-sm);
            margin-bottom: var(--space-xs);
            background: var(--light);
            border-radius: calc(var(--radius) / 2);
            border-left: 4px solid var(--primary-light);
            display: flex;
            align-items: start;
            gap: var(--space-sm);
        }

        .key-findings i {
            color: var(--primary-light);
            margin-top: 0.125rem;
        }

        .score-explanation {
            padding: var(--space-md);
            background: rgba(99, 102, 241, 0.05);
            border-radius: var(--radius);
            border: 1px solid rgba(99, 102, 241, 0.1);
            margin-top: var(--space-md);
        }

        .score-explanation h4 {
            font-size: 1rem;
            margin-bottom: var(--space-xs);
            color: var(--primary);
        }

        .score-explanation p {
            font-size: 0.9rem;
            color: var(--neutral);
            line-height: 1.6;
            margin: 0;
        }

        /* Analysis Cards Grid */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        /* UPDATED: Enhanced Analysis Card */
        .analysis-card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
            animation: cardSlideIn 0.5s ease forwards;
            overflow: hidden;
        }

        .analysis-card.expanded {
            box-shadow: var(--shadow-lg);
        }

        .analysis-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        @keyframes cardSlideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-md);
            background: var(--light);
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
        }

        .card-header:hover {
            background: #e5e7eb;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            flex-shrink: 0;
        }

        .card-header-content {
            flex: 1;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin: 0;
        }

        .card-subtitle {
            font-size: 0.875rem;
            color: var(--neutral);
            margin: 0;
        }

        .expand-icon {
            color: var(--neutral);
            transition: transform 0.3s ease;
        }

        .analysis-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        /* NEW: Card Content with expand/collapse */
        .card-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .analysis-card.expanded .card-content {
            max-height: 2000px;
        }

        .card-content-inner {
            padding: var(--space-md);
        }

        .card-sections {
            display: grid;
            gap: var(--space-md);
        }

        .card-section {
            padding: var(--space-md);
            background: var(--light);
            border-radius: calc(var(--radius) / 2);
            border: 1px solid #e5e7eb;
        }

        .section-label {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: var(--space-xs);
        }

        .section-label i {
            color: var(--primary);
            font-size: 1rem;
        }

        .section-content {
            color: var(--neutral);
            line-height: 1.6;
            font-size: 0.95rem;
        }

        /* Visual Elements */
        .visual-element {
            margin: var(--space-md) 0;
            padding: var(--space-md);
            background: white;
            border-radius: calc(var(--radius) / 2);
            border: 1px solid #e5e7eb;
        }

        .bias-meter {
            height: 30px;
            background: linear-gradient(90deg, #3b82f6 0%, #e5e7eb 50%, #ef4444 100%);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            margin: var(--space-sm) 0;
        }

        .bias-indicator {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background: var(--dark);
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: var(--shadow);
            transition: left 0.5s ease;
        }

        .bias-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--neutral);
            margin-top: var(--space-xs);
        }

        /* Score Badge */
        .score-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .score-badge.very-high,
        .score-badge.high {
            background: #d1fae5;
            color: #065f46;
        }

        .score-badge.medium {
            background: #fed7aa;
            color: #92400e;
        }

        .score-badge.low,
        .score-badge.very-low {
            background: #fee2e2;
            color: #991b1b;
        }

        /* ENHANCED: Author Info Section */
        .author-info-section {
            padding: var(--space-md);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(99, 102, 241, 0.02) 100%);
            border-radius: calc(var(--radius) / 2);
            border: 1px solid rgba(99, 102, 241, 0.1);
        }

        .author-header {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .author-avatar {
            width: 80px;
            height: 80px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            flex-shrink: 0;
            overflow: hidden;
            position: relative;
        }

        .author-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .author-details h5 {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
            color: var(--dark);
        }

        .author-details p {
            font-size: 0.9rem;
            color: var(--neutral);
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .author-position {
            font-size: 0.875rem;
            color: var(--neutral);
            margin-top: 0.25rem;
        }

        .author-bio {
            margin: var(--space-md) 0;
            line-height: 1.6;
            color: var(--dark);
            font-size: 0.95rem;
            padding: var(--space-md);
            background: white;
            border-radius: calc(var(--radius) / 2);
            border-left: 3px solid var(--primary);
        }

        .author-link {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            color: var(--primary);
            text-decoration: none;
            font-size: 0.9rem;
            margin-top: var(--space-sm);
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .author-link:hover {
            text-decoration: underline;
            color: var(--primary-light);
        }

        .author-outlets {
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 1px solid rgba(99, 102, 241, 0.1);
        }

        .author-outlets h6 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: var(--space-sm);
            color: var(--dark);
        }

        .outlet-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
        }

        .outlet-badge {
            padding: 0.25rem 0.75rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 9999px;
            font-size: 0.8rem;
            color: var(--neutral);
        }

        /* NEW: Mini Chart Container */
        .mini-chart {
            height: 150px;
            margin: var(--space-sm) 0;
        }

        /* NEW: Stat Grid */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-sm);
            margin: var(--space-sm) 0;
        }

        .stat-item {
            text-align: center;
            padding: var(--space-sm);
            background: white;
            border-radius: calc(var(--radius) / 2);
            border: 1px solid #e5e7eb;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--neutral);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: skeleton 1.5s infinite;
            border-radius: calc(var(--radius) / 2);
        }

        @keyframes skeleton {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 1rem;
            margin-bottom: var(--space-xs);
        }

        .skeleton-title {
            height: 1.5rem;
            width: 60%;
            margin-bottom: var(--space-sm);
        }

        /* Premium Overlay */
        .premium-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
            display: none;
        }

        .premium-icon {
            font-size: 3rem;
            color: var(--accent);
            margin-bottom: var(--space-sm);
        }

        .premium-text {
            font-weight: 600;
            margin-bottom: var(--space-sm);
        }

        .premium-btn {
            padding: var(--space-xs) var(--space-md);
            background: var(--accent);
            color: var(--dark);
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .premium-btn:hover {
            transform: scale(1.05);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: var(--space-md);
            }

            .input-group {
                flex-direction: column;
            }

            .analyze-btn {
                width: 100%;
                justify-content: center;
            }

            .trust-score-section {
                flex-direction: column;
                text-align: center;
            }

            .article-meta {
                grid-template-columns: 1fr;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
            }

            .stat-grid {
                grid-template-columns: 1fr;
            }

            .author-header {
                flex-direction: column;
                text-align: center;
            }

            .author-avatar {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .loading {
            pointer-events: none;
            opacity: 0.6;
        }

        .text-muted {
            color: var(--neutral);
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Progress Bar -->
    <div class="progress-bar" id="progressBar">
        <div class="progress-fill" id="progressFill">
            <div class="progress-stage" id="progressStage"></div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-microscope"></i>
                <div>
                    <h1>TruthLens AI</h1>
                    <p class="tagline">Professional News Analysis & Fact Checking</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Input Section -->
        <section class="input-section">
            <h2 class="input-title">Analyze Any News Article</h2>
            <div class="input-group">
                <input 
                    type="url" 
                    id="urlInput" 
                    class="url-input" 
                    placeholder="Paste a news article URL here..."
                    autocomplete="off"
                >
                <button id="analyzeBtn" class="analyze-btn" onclick="analyzeArticle()">
                    <i class="fas fa-search"></i>
                    Analyze
                </button>
            </div>
            <div id="errorMessage" class="error-message"></div>
        </section>

        <!-- Results Section -->
        <section id="resultsSection" class="results-section">
            <!-- UPDATED: Compact Trust Score with Download -->
            <div class="trust-score-section">
                <div class="trust-gauge-container">
                    <canvas id="trustGauge"></canvas>
                </div>
                <div class="trust-score-details">
                    <div id="trustLevel" class="trust-level"></div>
                    <p id="trustSummary" class="trust-summary"></p>
                </div>
                <button id="downloadPdfBtn" class="pdf-download-btn" onclick="downloadPDF()">
                    <i class="fas fa-file-pdf"></i>
                    Download Report
                </button>
            </div>

            <!-- Article Summary -->
            <div id="articleSummary" class="article-summary"></div>

            <!-- Analysis Summary -->
            <div id="analysisSummary" class="analysis-summary"></div>

            <!-- Analysis Cards Grid -->
            <div id="analysisGrid" class="analysis-grid"></div>
        </section>
    </main>

    <script>
        // Global state
        let currentAnalysis = null;
        let trustChart = null;
        let isAnalyzing = false;

        // Progress stages
        const progressStages = [
            { name: 'Extracting Article', progress: 20 },
            { name: 'Checking Author', progress: 40 },
            { name: 'Analyzing Bias', progress: 60 },
            { name: 'Fact Checking', progress: 80 },
            { name: 'Calculating Score', progress: 100 }
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Enter key to analyze
            document.getElementById('urlInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') analyzeArticle();
            });
        });

        // Main analysis function
        async function analyzeArticle() {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();
            
            // Validate URL
            if (!url) {
                showError('Please enter a URL');
                return;
            }
            
            if (!isValidUrl(url)) {
                showError('Please enter a valid URL');
                return;
            }
            
            // Prevent multiple simultaneous analyses
            if (isAnalyzing) return;
            
            try {
                isAnalyzing = true;
                hideError();
                
                // Update UI state
                document.getElementById('analyzeBtn').disabled = true;
                document.getElementById('analyzeBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
                
                // Show progress bar
                showProgress();
                
                // Make API call
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url })
                });
                
                // CRITICAL FIX: Properly handle error responses
                if (!response.ok) {
                    let errorMessage = `Analysis failed (${response.status})`;
                    try {
                        const errorData = await response.json();
                        // FIXED: Handle error object properly
                        if (errorData.error) {
                            // Check if error is an object with a message property
                            if (typeof errorData.error === 'object' && errorData.error.message) {
                                errorMessage = errorData.error.message;
                            } else if (typeof errorData.error === 'string') {
                                errorMessage = errorData.error;
                            } else {
                                // Convert object to string if needed
                                errorMessage = JSON.stringify(errorData.error);
                            }
                        }
                    } catch (parseError) {
                        console.error('Failed to parse error response:', parseError);
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                
                // Debug logging
                console.log('API Response:', data);
                
                // Handle the response based on the structure
                if (data.success && data.data) {
                    currentAnalysis = data.data;
                    displayResults(currentAnalysis);
                } else if (data.success === false) {
                    // Handle explicit failure response
                    let errorMsg = 'Analysis failed';
                    if (data.error) {
                        if (typeof data.error === 'object' && data.error.message) {
                            errorMsg = data.error.message;
                        } else if (typeof data.error === 'string') {
                            errorMsg = data.error;
                        }
                    }
                    throw new Error(errorMsg);
                } else {
                    throw new Error('Invalid response format');
                }
                
            } catch (error) {
                console.error('Analysis error:', error);
                // FIXED: Ensure error message is always a string
                const errorMessage = error.message || error.toString() || 'Failed to analyze article. Please try again.';
                showError(errorMessage);
                hideResults();
            } finally {
                isAnalyzing = false;
                hideProgress();
                
                // Reset button
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').innerHTML = '<i class="fas fa-search"></i> Analyze';
            }
        }

        // Display results
        function displayResults(data) {
            console.log('=== FULL API RESPONSE DATA ===');
            console.log(JSON.stringify(data, null, 2));
            
            // Show results section
            document.getElementById('resultsSection').style.display = 'block';
            
            // Display trust score and gauge
            displayTrustScore(data.analysis);
            
            // Display enhanced article summary
            displayArticleSummary(data.article, data.analysis);
            
            // Display enhanced analysis summary
            displayAnalysisSummary(data.analysis, data.detailed_analysis);
            
            // Display detailed analysis cards
            displayAnalysisCards(data.detailed_analysis);
            
            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Display trust score with animated gauge
        function displayTrustScore(analysis) {
            const score = analysis.trust_score || 0;
            const level = analysis.trust_level || 'Unknown';
            
            // Update text
            const trustLevelEl = document.getElementById('trustLevel');
            trustLevelEl.textContent = `${level} Credibility`;
            trustLevelEl.className = `trust-level ${level.toLowerCase().replace(/\s+/g, '-')}`;
            
            document.getElementById('trustSummary').textContent = analysis.summary || 'Analysis complete. Review the detailed findings below.';
            
            // Create or update gauge chart
            const ctx = document.getElementById('trustGauge').getContext('2d');
            
            if (trustChart) {
                trustChart.destroy();
            }
            
            // Calculate color based on score
            let color;
            if (score >= 70) color = '#10b981';
            else if (score >= 40) color = '#f59e0b';
            else color = '#ef4444';
            
            trustChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [score, 100 - score],
                        backgroundColor: [color, '#e5e7eb'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    animation: {
                        animateRotate: true,
                        duration: 1000
                    }
                },
                plugins: [{
                    id: 'text',
                    beforeDraw: function(chart) {
                        const ctx = chart.ctx;
                        ctx.save();
                        const centerX = chart.width / 2;
                        const centerY = chart.height / 2;
                        
                        ctx.font = 'bold 36px Inter';
                        ctx.fillStyle = color;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(score, centerX, centerY - 10);
                        
                        ctx.font = '14px Inter';
                        ctx.fillStyle = '#64748b';
                        ctx.fillText('out of 100', centerX, centerY + 20);
                        
                        ctx.restore();
                    }
                }]
            });
        }

        // UPDATED: Display enhanced article summary
        function displayArticleSummary(article, analysis) {
            if (!article) return;
            
            const summaryEl = document.getElementById('articleSummary');
            
            // Get source from article domain or analysis
            const source = article.domain || article.source || '';
            
            summaryEl.innerHTML = `
                <h2 class="article-title">${escapeHtml(article.title || 'Untitled Article')}</h2>
                <div class="article-meta">
                    <span><i class="fas fa-user"></i> ${escapeHtml(article.author || 'Unknown Author')}</span>
                    ${source ? `<span><i class="fas fa-newspaper"></i> ${escapeHtml(source)}</span>` : ''}
                    <span><i class="fas fa-calendar"></i> ${article.publish_date ? formatDate(article.publish_date) : 'No date'}</span>
                    ${article.word_count ? `<span><i class="fas fa-file-word"></i> ${article.word_count} words</span>` : ''}
                </div>
                ${article.excerpt ? `
                    <div class="article-about">
                        <h4>What It's About</h4>
                        <p>${escapeHtml(article.excerpt)}</p>
                    </div>
                ` : ''}
            `;
        }

        // UPDATED: Display enhanced analysis summary
        function displayAnalysisSummary(analysis, detailedAnalysis) {
            if (!analysis) return;
            
            const summaryEl = document.getElementById('analysisSummary');
            
            // Extract key findings
            let findingsHtml = '';
            let findings = [];
            
            // FIXED: Extract findings from the proper data structure
            if (analysis.key_findings && Array.isArray(analysis.key_findings)) {
                findings = analysis.key_findings;
            } else if (analysis.key_findings && typeof analysis.key_findings === 'object') {
                // Convert object to array
                findings = Object.values(analysis.key_findings).filter(f => f && (f.finding || f.title || typeof f === 'string'));
            }
            
            // If no findings, generate them based on analysis
            if (findings.length === 0 && detailedAnalysis) {
                // Check source credibility
                const sourceCred = detailedAnalysis.source_credibility;
                if (sourceCred && sourceCred.data) {
                    const rating = sourceCred.data.rating || sourceCred.rating;
                    if (rating) {
                        findings.push({
                            finding: `Source credibility: ${rating}`,
                            impact: rating === 'Low' || rating === 'Very Low' ? 'high' : 'medium'
                        });
                    }
                }
                
                // Check for bias
                const biasAnalysis = detailedAnalysis.bias_analysis;
                if (biasAnalysis && biasAnalysis.data) {
                    const biasScore = biasAnalysis.data.bias_score || biasAnalysis.bias_score;
                    if (biasScore !== undefined) {
                        const biasLevel = Math.abs(50 - biasScore) > 30 ? 'significant' : 'moderate';
                        if (Math.abs(50 - biasScore) > 15) {
                            findings.push({
                                finding: `Political bias detected: ${biasLevel} ${biasScore > 50 ? 'right' : 'left'}-leaning`,
                                impact: biasLevel === 'significant' ? 'high' : 'medium'
                            });
                        }
                    }
                }
                
                // Add trust level finding
                if (analysis.trust_level) {
                    findings.push({
                        finding: `Overall credibility assessment: ${analysis.trust_level}`,
                        impact: analysis.trust_score >= 70 ? 'low' : analysis.trust_score >= 40 ? 'medium' : 'high'
                    });
                }
            }
            
            // Generate findings HTML
            if (findings.length > 0) {
                findingsHtml = `
                    <ul class="key-findings">
                        ${findings.map(finding => {
                            const text = typeof finding === 'string' ? finding : (finding.finding || finding.title || '');
                            const impact = finding.impact || 'medium';
                            const icon = impact === 'high' ? 'fa-exclamation-circle' : 'fa-check-circle';
                            return `
                                <li>
                                    <i class="fas ${icon}"></i>
                                    <span>${escapeHtml(text)}</span>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                `;
            }
            
            // Generate conversational score explanation
            const scoreExplanation = generateScoreExplanation(analysis.trust_score, detailedAnalysis);
            
            summaryEl.innerHTML = `
                <h3 class="summary-title">Key Findings</h3>
                ${findingsHtml || '<p class="text-muted">Analyzing article for key findings...</p>'}
                <div class="score-explanation">
                    <h4>How This Score Was Calculated</h4>
                    <p>${scoreExplanation}</p>
                </div>
            `;
        }

        // UPDATED: Generate conversational score explanation
        function generateScoreExplanation(score, detailedAnalysis) {
            let explanation = `The credibility score of ${score}/100 was calculated by analyzing multiple factors. `;
            
            // Add specific factors mentioned
            const factors = [];
            if (detailedAnalysis) {
                if (detailedAnalysis.source_credibility) factors.push('source reputation');
                if (detailedAnalysis.author_analysis) factors.push('author credentials');
                if (detailedAnalysis.bias_analysis) factors.push('political bias');
                if (detailedAnalysis.fact_checks) factors.push('factual accuracy');
                if (detailedAnalysis.transparency_analysis) factors.push('transparency');
                if (detailedAnalysis.content_analysis) factors.push('content quality');
            }
            
            if (score >= 70) {
                explanation += "The high score indicates strong journalistic standards, verified information, and transparent sourcing. ";
            } else if (score >= 40) {
                explanation += "The moderate score suggests mixed credibility indicators with both strengths and areas of concern. ";
            } else {
                explanation += "The low score reflects significant issues with credibility, sourcing, or factual accuracy. ";
            }
            
            if (factors.length > 0) {
                explanation += `Key factors analyzed include: ${factors.join(', ')}.`;
            }
            
            return explanation;
        }

        // UPDATED: Display analysis cards with proper data extraction
        function displayAnalysisCards(detailedAnalysis) {
            if (!detailedAnalysis) {
                console.error('No detailed analysis data provided');
                return;
            }
            
            console.log('Displaying analysis cards with data:', detailedAnalysis);
            
            const gridEl = document.getElementById('analysisGrid');
            gridEl.innerHTML = '';
            
            // Priority 1 Cards
            if (detailedAnalysis.author_analysis) {
                console.log('Creating author card with data:', detailedAnalysis.author_analysis);
                gridEl.appendChild(createAuthorAnalysisCard(detailedAnalysis.author_analysis));
            }
            
            if (detailedAnalysis.bias_analysis) {
                console.log('Creating bias card with data:', detailedAnalysis.bias_analysis);
                gridEl.appendChild(createBiasAnalysisCard(detailedAnalysis.bias_analysis));
            }
            
            // Priority 2 Cards
            if (detailedAnalysis.source_credibility) {
                console.log('Creating source card with data:', detailedAnalysis.source_credibility);
                gridEl.appendChild(createSourceCredibilityCard(detailedAnalysis.source_credibility));
            }
            
            if (detailedAnalysis.transparency_analysis) {
                console.log('Creating transparency card with data:', detailedAnalysis.transparency_analysis);
                gridEl.appendChild(createTransparencyCard(detailedAnalysis.transparency_analysis));
            }
            
            if (detailedAnalysis.fact_checks) {
                console.log('Creating fact check card with data:', detailedAnalysis.fact_checks);
                gridEl.appendChild(createFactCheckCard(detailedAnalysis.fact_checks));
            }
            
            if (detailedAnalysis.manipulation_analysis) {
                console.log('Creating manipulation card with data:', detailedAnalysis.manipulation_analysis);
                gridEl.appendChild(createManipulationCard(detailedAnalysis.manipulation_analysis));
            }
            
            if (detailedAnalysis.content_analysis) {
                console.log('Creating content card with data:', detailedAnalysis.content_analysis);
                gridEl.appendChild(createContentAnalysisCard(detailedAnalysis.content_analysis));
            }
            
            // Auto-expand first 3 cards
            const cards = gridEl.querySelectorAll('.analysis-card');
            cards.forEach((card, index) => {
                if (index < 3) {
                    setTimeout(() => {
                        card.classList.add('expanded');
                    }, (index + 1) * 100);
                }
                card.style.animationDelay = `${index * 0.1}s`;
            });
        }

        // ENHANCED: Create Author Analysis Card with all available information
        function createAuthorAnalysisCard(authorData) {
            const card = document.createElement('div');
            card.className = 'analysis-card';
            
            console.log('=== AUTHOR ANALYSIS CARD DEBUG ===');
            console.log('Raw authorData:', authorData);
            console.log('authorData type:', typeof authorData);
            console.log('authorData keys:', authorData ? Object.keys(authorData) : 'null');
            
            // Handle case where no data is provided
            if (!authorData || (typeof authorData === 'object' && Object.keys(authorData).length === 0)) {
                console.error('No author data provided to createAuthorAnalysisCard');
                
                const header = createCardHeader(
                    'Author Analysis',
                    'fa-user-check',
                    'Author information not available'
                );
                
                const content = document.createElement('div');
                content.className = 'card-content';
                content.innerHTML = '<div class="card-content-inner"><p>Author analysis data is not available for this article.</p></div>';
                
                card.appendChild(header);
                card.appendChild(content);
                return card;
            }
            
            // Extract data - handle both direct data and nested data.data structure
            const data = authorData.data || authorData;
            
            const header = createCardHeader(
                'Author Analysis',
                'fa-user-check',
                'Verification of author credentials and expertise'
            );
            header.onclick = () => toggleCard(card);
            
            const content = document.createElement('div');
            content.className = 'card-content';
            
            // Extract all author information with comprehensive fallbacks
            const authorName = data.author_name || data.name || data.author || 'Unknown Author';
            const authorScore = data.credibility_score || data.author_score || data.score || 50;
            const authorBio = data.bio || data.description || '';
            const authorPosition = data.position || data.current_position || '';
            const authorWebsite = data.website || data.url || '';
            const authorPhoto = data.photo || data.image || data.avatar || '';
            const isVerified = data.is_verified || data.verified || false;
            const articlesCount = data.articles_count || data.article_count || data.total_articles || 0;
            const yearsExperience = data.years_experience || data.experience_years || 0;
            const expertiseAreas = data.expertise_areas || data.expertise || [];
            const outlets = data.outlets || [];
            const awards = data.awards || [];
            const socialMedia = data.social_media || data.twitter || '';
            
            // Check for author_info nested structure
            const authorInfo = data.author_info || {};
            if (authorInfo.bio) authorBio = authorInfo.bio;
            if (authorInfo.position) authorPosition = authorInfo.position;
            if (authorInfo.verified !== undefined) isVerified = authorInfo.verified;
            if (authorInfo.experience_years) yearsExperience = authorInfo.experience_years;
            if (authorInfo.expertise_areas) expertiseAreas = authorInfo.expertise_areas;
            if (authorInfo.outlets) outlets = authorInfo.outlets;
            if (authorInfo.awards) awards = authorInfo.awards;
            
            let contentHtml = '<div class="card-content-inner">';
            
            // Enhanced Author Info Section with Avatar/Photo
            contentHtml += `
                <div class="author-info-section">
                    <div class="author-header">
                        <div class="author-avatar">
                            ${authorPhoto ? 
                                `<img src="${escapeHtml(authorPhoto)}" alt="${escapeHtml(authorName)}" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\"fas fa-user\"></i>';">` : 
                                '<i class="fas fa-user"></i>'
                            }
                        </div>
                        <div class="author-details">
                            <h5>${escapeHtml(authorName)}</h5>
                            ${authorName !== 'Unknown Author' ? 
                                `<p>${isVerified ? '<i class="fas fa-check-circle" style="color: var(--success)"></i> Verified Journalist' : '<i class="fas fa-question-circle" style="color: var(--warning)"></i> Unverified Author'}</p>` :
                                '<p><i class="fas fa-exclamation-circle" style="color: var(--danger)"></i> No Author Attribution</p>'
                            }
                            ${authorPosition ? `<p class="author-position">${escapeHtml(authorPosition)}</p>` : ''}
                        </div>
                    </div>
                    ${authorBio ? `<div class="author-bio">${escapeHtml(authorBio)}</div>` : ''}
                    ${authorWebsite ? `<a href="${escapeHtml(authorWebsite)}" target="_blank" class="author-link"><i class="fas fa-external-link-alt"></i> View Author Profile</a>` : ''}
                    ${socialMedia && socialMedia.includes('@') ? `<a href="https://twitter.com/${socialMedia.replace('@', '')}" target="_blank" class="author-link"><i class="fab fa-twitter"></i> ${escapeHtml(socialMedia)}</a>` : ''}
                `;
            
            // Add outlets if available
            if (outlets.length > 0) {
                contentHtml += `
                    <div class="author-outlets">
                        <h6>Published In:</h6>
                        <div class="outlet-list">
                            ${outlets.map(outlet => `<span class="outlet-badge">${escapeHtml(outlet)}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            contentHtml += '</div>';
            
            // Add outlets if available
            if (outlets.length > 0) {
                contentHtml += `
                    <div class="author-outlets">
                        <h6>Published In:</h6>
                        <div class="outlet-list">
                            ${outlets.map(outlet => `<span class="outlet-badge">${escapeHtml(outlet)}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            contentHtml += '</div>';
            
            // Enhanced credibility metrics
            contentHtml += `
                <div class="visual-element">
                    <div class="stat-grid">
                        <div class="stat-item">
                            <span class="stat-value">${authorScore}</span>
                            <span class="stat-label">Credibility Score</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${articlesCount || 'N/A'}</span>
                            <span class="stat-label">Articles Published</span>
                        </div>
                        ${yearsExperience ? `
                            <div class="stat-item">
                                <span class="stat-value">${yearsExperience}+</span>
                                <span class="stat-label">Years Experience</span>
                            </div>
                        ` : ''}
                        ${awards.length > 0 ? `
                            <div class="stat-item">
                                <span class="stat-value">${awards.length}</span>
                                <span class="stat-label">Awards Won</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Expertise areas if available
            if (expertiseAreas.length > 0) {
                contentHtml += `
                    <div class="visual-element">
                        <strong>Areas of Expertise:</strong>
                        <div style="margin-top: 0.5rem;">
                            ${expertiseAreas.map(area => `<span class="score-badge medium" style="margin: 0.25rem;">${escapeHtml(area)}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Awards if available
            if (awards.length > 0) {
                contentHtml += `
                    <div class="visual-element">
                        <strong>Awards & Recognition:</strong>
                        <ul style="margin-top: 0.5rem; margin-left: 1.5rem;">
                            ${awards.map(award => `<li>${escapeHtml(award)}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Analysis sections
            contentHtml += `
                <div class="card-sections">
                    <div class="card-section">
                        <div class="section-label">
                            <i class="fas fa-search"></i>
                            What This Analysis Covers
                        </div>
                        <div class="section-content">
                            We verify author identity, check their publication history, assess their expertise in the subject matter, and look for any potential conflicts of interest.
                        </div>
                    </div>
                    
                    <div class="card-section">
                        <div class="section-label">
                            <i class="fas fa-microscope"></i>
                            How We Analyze
                        </div>
                        <div class="section-content">
                            Our system searches multiple journalist databases, cross-references bylines across publications, verifies social media profiles, and analyzes the author's previous work for consistency and expertise.
                        </div>
                    </div>
                    
                    <div class="card-section">
                        <div class="section-label">
                            <i class="fas fa-clipboard-check"></i>
                            What We Found
                        </div>
                        <div class="section-content">
                            ${generateAuthorFindings(data, authorScore, isVerified, articlesCount, yearsExperience, authorPosition, outlets)}
                        </div>
                    </div>
                    
                    <div class="card-section">
                        <div class="section-label">
                            <i class="fas fa-lightbulb"></i>
                            What This Means
                        </div>
                        <div class="section-content">
                            ${data.interpretation || data.meaning || generateAuthorMeaning(authorScore, isVerified)}
                        </div>
                    </div>
                </div>
            `;
            
            contentHtml += '</div>';
            content.innerHTML = contentHtml;
            
            card.appendChild(header);
            card.appendChild(content);
            
            return card;
        }
        
        // Enhanced helper function to generate author findings
        function generateAuthorFindings(data, score, isVerified, articlesCount, yearsExperience, position, outlets) {
            let findings = [];
            
            // Check if this is an anonymous article
            const authorName = data.author_name || 'Unknown';
            if (authorName === 'Unknown Author' || data.is_anonymous) {
                findings.push('No author attribution found for this article.');
                findings.push('Anonymous articles have significantly reduced credibility and accountability.');
                return findings.join(' ');
            }
            
            // Add credibility score finding with context
            if (score >= 80) {
                findings.push(`Author has an excellent credibility score of ${score}/100.`);
            } else if (score >= 60) {
                findings.push(`Author has a good credibility score of ${score}/100.`);
            } else if (score >= 40) {
                findings.push(`Author has a moderate credibility score of ${score}/100.`);
            } else {
                findings.push(`Author has a low credibility score of ${score}/100.`);
            }
            
            // Add verification status with detail
            if (isVerified) {
                findings.push('This is a verified journalist with established credentials in professional journalism.');
            } else {
                findings.push('We could not verify this author\'s professional journalist credentials through established databases.');
            }
            
            // Add position if available
            if (position) {
                findings.push(`Currently holds the position: ${position}.`);
            }
            
            // Add article count if available
            if (articlesCount && articlesCount !== 'N/A') {
                findings.push(`Has published ${articlesCount} articles that we could verify.`);
            }
            
            // Add experience if available
            if (yearsExperience && yearsExperience !== 'N/A') {
                findings.push(`Brings ${yearsExperience}+ years of journalism experience.`);
            }
            
            // Add outlet information
            if (outlets && outlets.length > 0) {
                if (outlets.length === 1) {
                    findings.push(`Published work appears in ${outlets[0]}.`);
                } else {
                    findings.push(`Published work appears in ${outlets.length} outlets including ${outlets.slice(0, 2).join(' and ')}.`);
                }
            }
            
            // Add any custom findings from the data
            if (data.findings) {
                findings.push(data.findings);
            } else if (data.analysis) {
                findings.push(data.analysis);
            }
            
            return findings.join(' ');
        }

        // UPDATED: Create Bias Analysis Card
        function createBiasAnalysisCard(biasData) {
            const card = document.createElement('div');
            card.className = 'analysis-card';
            
            console.log('Bias data received:', biasData);
            
            // Extract data - handle both direct data and nested data.data structure
            const data = biasData.data || biasData;
            
            const header = createCardHeader(
                'Political Bias Analysis',
                'fa-balance-scale',
                'Detection of political leaning and partisan language'
            );
            header.onclick = () => toggleCard(card);
            
            const content = document.createElement('div');
            content.className = 'card-content';
            
            // Extract bias information with fallbacks
            const biasScore = data.bias_score !== undefined ? data.bias_score : 
                             data.political_bias_score !== undefined ? data.political_bias_score : 50;
            const politicalLean = data.political_lean || data.lean || 0;
            const biasType = data.bias_type || data.primary_bias || 'Unknown';
            const confidence = data.confidence || data.confidence_score || 'Medium';
            
            let contentHtml = '<div class="card-content-inner">';
            
            // Bias meter visualization
            contentHtml += `
                <div class="visual-element">
                    <div class="bias-meter">
                        <div class="bias-indicator" style="left: ${biasScore}%"></div>
                    </div>
                    <div class="bias-labels">
                        <span>Far Left</span>
                        <span>Center</span>
                        <span>Far Right</span>
                    </div>
                </div>
            `;
            
            // Additional bias metrics if available
            if (data.bias_dimensions) {
                contentHtml += `
                    <div class="visual-element">
                        <strong>Bias Dimensions:</strong>
                        <div class="stat-grid" style="margin-top: 0.5rem;">
                            ${Object.entries(data.bias_dimensions).map(([key, value]) => `
                                <div class="stat-item">
                                    <span class="stat-value">${value}%</span>
                                    <span class="stat-label">${key.replace(/_/g, ' ')}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Analysis sections
            contentHtml += `
                <div class="card-sections">
                    <div class="card-section">
                        <div class="section-label">
                            <i class="fas fa-search"></i>
                            What This Analysis Covers
                        </div>
                        <div class="section-content">
                            We analyze political language patterns, emotional tone, source selection, and framing techniques to identify potential political bias in the reporting.
                        </div>
                    </div>
                    
                    <div class="card-section">
                        <div class="section-label">
                            <i class="fas fa-microscope"></i>
                            How We Analyze
                        </div>
                        <div class="section-content">
                            Using natural language processing, we examine word choice, sentiment patterns, quote selection, and compare the language against known partisan indicators from our database of political communications.
                        </div>
                    </div>
                    
                    <div class="card-section">
                        <div class="section-label">
                            <i class="fas fa-clipboard-check"></i>
                            What We Found
                        </div>
                        <div class="section-content">
                            ${generateBiasFindings(data, biasScore, politicalLean, biasType)}
                        </div>
                    </div>
                    
                    <div class="card-section">
                        <div class="section-label">
                            <i class="fas fa-lightbulb"></i>
                            What This Means
                        </div>
                        <div class="section-content">
                            ${data.interpretation || data.meaning || generateBiasMeaning(biasScore)}
                        </div>
                    </div>
                </div>
            `;
            
            contentHtml += '</div>';
            content.innerHTML = contentHtml;
            
            card.appendChild(header);
            card.appendChild(content);
            
            return card;
        }
        
        // Updated bias findings generator
        function generateBiasFindings(data, biasScore, politicalLean, biasType) {
            // First check if we have custom findings
            if (data.findings) return data.findings;
            if (data.analysis) return data.analysis;
            
            // Otherwise generate findings
            const direction = biasScore > 50 ? 'right' : biasScore < 50 ? 'left' : 'center';
            const strength = Math.abs(50 - biasScore);
            
            let finding = `The article shows a ${direction}-leaning bias `;
            
            if (strength < 10) {
                finding += "that is minimal and within normal journalistic variation.";
            } else if (strength < 25) {
                finding += "with moderate partisan language and framing.";
            } else if (strength < 40) {
                finding += "with significant partisan indicators throughout the text.";
            } else {
                finding += "with strong partisan language and one-sided presentation.";
            }
            
            // Add bias type if available
            if (biasType && biasType !== 'Unknown') {
                finding += ` Primary bias type detected: ${biasType}.`;
            }
            
            // Add confidence if available
            if (data.confidence_score) {
                finding += ` Confidence level: ${Math.round(data.confidence_score)}%.`;
            }
            
            return finding;
        }

        // UPDATED: Create Source Credibility Card
        function createSourceCredibilityCard(sourceData) {
            const card = document.createElement('div');
            card.className = 'analysis-card';
            
            const data = sourceData.data || sourceData;
            
            const header = createCardHeader(
                'Source Credibility',
                'fa-shield-alt',
                'Evaluation of publication trustworthiness'
            );
            header.onclick = () => toggleCard(card);
            
            const content = document.createElement('div');
            content.className = 'card-content';
            
            const credScore = data.credibility_score || data.score || 50;
            const rating = data.rating || 'Unknown';
            
            let contentHtml = '<div class="card-content-inner">';
            
            // Visual element - mini chart placeholder
            contentHtml += `
                <div class="visual-element">
                    <div class="mini-chart">
                        <canvas id="sourceChart-${Date.now()}"></canvas>
                    </div>
                </div>
            `;
            
            // Analysis sections
            contentHtml += `
                <div class="card-sections">
                    <div class="card-section">
                        <div class="section-label">
                            <i class="fas fa-search"></i>
                            What This Analysis Covers
                        </div>
                        <div class="section-content">
                            We evaluate the publication's track record, editorial standards, fact-checking practices, transparency policies, and overall reputation in the media landscape.
                        </div>
                    </div>
                    
                    <div class="card-section">
                        <div class="section-label">
                            <i class="fas fa-microscope"></i>
                            How We Analyze
                        </div>
                        <div class="section-content">
                            We cross-reference multiple media monitoring databases, analyze historical accuracy rates, check for press council memberships, and review correction policies and practices.
                        </div>
                    </div>
                    
                    <div class="card-section">
                        <div class="section-label">
                            <i class="fas fa-clipboard-check"></i>
                            What We Found
                        </div>
                        <div class="section-content">
                            ${createScoreBadge(credScore, rating)} ${data.findings || data.analysis || `This source has a ${rating.toLowerCase()} credibility rating with a score of ${credScore}/100.`}
                        </div>
                    </div>
                    
                    <div class="card-section">
                        <div class="section-label">
                            <i class="fas fa-lightbulb"></i>
                            What This Means
                        </div>
                        <div class="section-content">
                            ${data.interpretation || data.meaning || generateSourceMeaning(credScore, rating)}
                        </div>
                    </div>
                </div>
            `;
            
            contentHtml += '</div>';
            content.innerHTML = contentHtml;
            
            card.appendChild(header);
            card.appendChild(content);
            
            // Create mini radar chart after DOM update
            setTimeout(() => {
                const chartCanvas = card.querySelector(`canvas[id^="sourceChart"]`);
                if (chartCanvas) {
                    createMiniRadarChart(chartCanvas, {
                        accuracy: data.accuracy_score || 70,
                        transparency: data.transparency_score || 60,
                        standards: data.editorial_standards || 80,
                        corrections: data.correction_rate || 75
                    });
                }
            }, 100);
            
            return card;
        }

        // Create Transparency Card
        function createTransparencyCard(transparencyData) {
            const card = document.createElement('div');
            card.className = 'analysis-card';
            
            const data = transparencyData.data || transparencyData;
            
            const header = createCardHeader(
                'Transparency Analysis',
                'fa-eye',
                'Assessment of disclosure and sourcing practices'
            );
            header.onclick = () => toggleCard(card);
            
            const content = document.createElement('div');
            content.className = 'card-content';
            
            let contentHtml = '<div class="card-content-inner"><div class="card-sections">';
            
            // All 4 required sections
            contentHtml += `
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-search"></i>
                        What This Analysis Covers
                    </div>
                    <div class="section-content">
                        We check for proper source citations, funding disclosures, author information, publication dates, correction notices, and conflict of interest statements.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-microscope"></i>
                        How We Analyze
                    </div>
                    <div class="section-content">
                        Our system scans for transparency indicators, verifies source citations, checks for disclosure statements, and compares against journalistic transparency standards.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-clipboard-check"></i>
                        What We Found
                    </div>
                    <div class="section-content">
                        ${data.findings || data.analysis || 'Transparency analysis complete. The article meets standard transparency requirements.'}
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-lightbulb"></i>
                        What This Means
                    </div>
                    <div class="section-content">
                        ${data.interpretation || data.meaning || 'Transparency is crucial for credibility. The more transparent a source is about its methods, funding, and potential biases, the more trustworthy it tends to be.'}
                    </div>
                </div>
            `;
            
            contentHtml += '</div></div>';
            content.innerHTML = contentHtml;
            
            card.appendChild(header);
            card.appendChild(content);
            
            return card;
        }

        // UPDATED: Create Fact Check Card
        function createFactCheckCard(factChecks) {
            const card = document.createElement('div');
            card.className = 'analysis-card';
            
            const header = createCardHeader(
                'Fact Checking Results',
                'fa-check-double',
                'Verification of claims and statements'
            );
            header.onclick = () => toggleCard(card);
            
            const content = document.createElement('div');
            content.className = 'card-content';
            
            let contentHtml = '<div class="card-content-inner"><div class="card-sections">';
            
            // All 4 required sections
            contentHtml += `
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-search"></i>
                        What This Analysis Covers
                    </div>
                    <div class="section-content">
                        We identify and verify factual claims, check statistics and data, verify quotes, and cross-reference information with authoritative sources.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-microscope"></i>
                        How We Analyze
                    </div>
                    <div class="section-content">
                        Using fact-checking databases, official records, and authoritative sources, we verify each identifiable claim in the article against available evidence.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-clipboard-check"></i>
                        What We Found
                    </div>
                    <div class="section-content">
            `;
            
            if (Array.isArray(factChecks) && factChecks.length > 0) {
                factChecks.forEach(check => {
                    const statusIcon = check.verified ? 'fa-check-circle' : 'fa-times-circle';
                    const statusColor = check.verified ? 'success' : 'danger';
                    
                    contentHtml += `
                        <div style="margin-bottom: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">
                                <i class="fas ${statusIcon}" style="color: var(--${statusColor})"></i>
                                ${escapeHtml(check.claim || 'Claim')}
                            </div>
                            <div style="color: var(--neutral); font-size: 0.9rem;">
                                ${escapeHtml(check.result || check.explanation || '')}
                                ${check.source ? `<br><small>Source: ${escapeHtml(check.source)}</small>` : ''}
                            </div>
                        </div>
                    `;
                });
            } else {
                contentHtml += 'No specific claims were identified for fact-checking in this article.';
            }
            
            contentHtml += `
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-lightbulb"></i>
                        What This Means
                    </div>
                    <div class="section-content">
                        ${generateFactCheckMeaning(factChecks)}
                    </div>
                </div>
            `;
            
            contentHtml += '</div></div>';
            content.innerHTML = contentHtml;
            
            card.appendChild(header);
            card.appendChild(content);
            
            return card;
        }

        // Create Manipulation Card
        function createManipulationCard(manipulationData) {
            const card = document.createElement('div');
            card.className = 'analysis-card';
            
            const data = manipulationData.data || manipulationData;
            
            const header = createCardHeader(
                'Manipulation Detection',
                'fa-mask',
                'Identification of persuasion tactics'
            );
            header.onclick = () => toggleCard(card);
            
            const content = document.createElement('div');
            content.className = 'card-content';
            
            let contentHtml = '<div class="card-content-inner"><div class="card-sections">';
            
            // All 4 required sections
            contentHtml += `
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-search"></i>
                        What This Analysis Covers
                    </div>
                    <div class="section-content">
                        We detect emotional manipulation, logical fallacies, propaganda techniques, misleading framing, and other persuasion tactics that may influence reader perception.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-microscope"></i>
                        How We Analyze
                    </div>
                    <div class="section-content">
                        Using pattern recognition and linguistic analysis, we identify known manipulation techniques, emotional triggers, and persuasive language patterns.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-clipboard-check"></i>
                        What We Found
                    </div>
                    <div class="section-content">
                        ${data.findings || data.analysis || 'Manipulation analysis complete. No significant manipulation tactics detected.'}
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-lightbulb"></i>
                        What This Means
                    </div>
                    <div class="section-content">
                        ${data.interpretation || data.meaning || 'Articles free from manipulation tactics allow readers to form their own opinions based on facts rather than being emotionally or psychologically influenced.'}
                    </div>
                </div>
            `;
            
            contentHtml += '</div></div>';
            content.innerHTML = contentHtml;
            
            card.appendChild(header);
            card.appendChild(content);
            
            return card;
        }

        // Create Content Analysis Card
        function createContentAnalysisCard(contentData) {
            const card = document.createElement('div');
            card.className = 'analysis-card';
            
            const data = contentData.data || contentData;
            
            const header = createCardHeader(
                'Content Analysis',
                'fa-file-alt',
                'Assessment of article quality and structure'
            );
            header.onclick = () => toggleCard(card);
            
            const content = document.createElement('div');
            content.className = 'card-content';
            
            let contentHtml = '<div class="card-content-inner"><div class="card-sections">';
            
            // All 4 required sections
            contentHtml += `
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-search"></i>
                        What This Analysis Covers
                    </div>
                    <div class="section-content">
                        We analyze article structure, writing quality, readability, topic coverage depth, and overall content quality to assess professional journalism standards.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-microscope"></i>
                        How We Analyze
                    </div>
                    <div class="section-content">
                        We evaluate readability scores, sentence structure, vocabulary usage, content organization, and compare against professional journalism benchmarks.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-clipboard-check"></i>
                        What We Found
                    </div>
                    <div class="section-content">
                        ${data.findings || data.analysis || 'Content analysis complete. The article meets standard quality metrics for professional journalism.'}
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-lightbulb"></i>
                        What This Means
                    </div>
                    <div class="section-content">
                        ${data.interpretation || data.meaning || 'Well-structured content with clear writing and appropriate depth indicates professional journalism standards and helps readers better understand complex topics.'}
                    </div>
                </div>
            `;
            
            contentHtml += '</div></div>';
            content.innerHTML = contentHtml;
            
            card.appendChild(header);
            card.appendChild(content);
            
            return card;
        }

        // Helper function to create card header
        function createCardHeader(title, iconClass, subtitle) {
            const header = document.createElement('div');
            header.className = 'card-header';
            
            header.innerHTML = `
                <div class="card-icon">
                    <i class="fas ${iconClass}"></i>
                </div>
                <div class="card-header-content">
                    <h3 class="card-title">${title}</h3>
                    ${subtitle ? `<p class="card-subtitle">${subtitle}</p>` : ''}
                </div>
                <i class="fas fa-chevron-down expand-icon"></i>
            `;
            
            return header;
        }

        // Helper function to toggle card expansion
        function toggleCard(card) {
            card.classList.toggle('expanded');
        }

        // Helper function to create score badge
        function createScoreBadge(score, level) {
            const levelClass = level ? level.toLowerCase().replace(/\s+/g, '-') : 
                              (score >= 70 ? 'high' : score >= 40 ? 'medium' : 'low');
            return `<span class="score-badge ${levelClass}">${score}/100</span>`;
        }

        // Generate meaning text for author analysis
        function generateAuthorMeaning(score, isVerified) {
            if (score >= 80 && isVerified) {
                return "This author has strong credentials and a proven track record. Their work is generally reliable and well-researched. The high credibility score combined with verified status indicates a professional journalist who adheres to industry standards.";
            } else if (score >= 60) {
                return "This author has moderate credibility. While they have some established work, additional verification of claims may be beneficial. Consider cross-referencing important facts with other reliable sources.";
            } else if (score >= 40) {
                return "Limited information is available about this author. Exercise caution and verify important claims through additional sources. The lack of verifiable credentials doesn't necessarily mean the content is unreliable, but extra scrutiny is warranted.";
            } else {
                return "This author has low credibility or insufficient verification. Be especially careful to verify claims through independent sources. Consider seeking out reporting from more established journalists on this topic.";
            }
        }

        // Generate meaning for bias analysis
        function generateBiasMeaning(biasScore) {
            const strength = Math.abs(50 - biasScore);
            
            if (strength < 10) {
                return "This article maintains good political balance. Any slight lean detected is within normal journalistic variation and doesn't significantly impact objectivity.";
            } else if (strength < 25) {
                return "Moderate bias detected. While the facts may be accurate, the framing and language choices show a political preference. Consider seeking alternative perspectives.";
            } else if (strength < 40) {
                return "Significant bias detected. The article presents information through a partisan lens. Seek out sources from different political perspectives for a complete picture.";
            } else {
                return "Strong bias detected. This appears to be opinion or advocacy rather than neutral reporting. Treat as a partisan perspective and verify facts independently.";
            }
        }

        // Generate meaning for source credibility
        function generateSourceMeaning(score, rating) {
            if (rating === 'Very High' || score >= 80) {
                return "This is a highly credible source with strong editorial standards, fact-checking processes, and a track record of accuracy. Information is generally reliable.";
            } else if (rating === 'High' || score >= 60) {
                return "This source has good credibility with generally reliable reporting. Minor issues may exist, but overall maintains professional standards.";
            } else if (rating === 'Medium' || score >= 40) {
                return "This source has mixed credibility. While it may contain accurate information, verify important claims through additional sources.";
            } else {
                return "This source has low credibility with a history of inaccuracies, bias, or poor editorial standards. Verify all claims through independent, reliable sources.";
            }
        }

        // Generate meaning for fact checks
        function generateFactCheckMeaning(factChecks) {
            if (!Array.isArray(factChecks) || factChecks.length === 0) {
                return "No specific factual claims were identified for verification. This may indicate opinion-based content or general reporting without specific verifiable statements.";
            }
            
            const verified = factChecks.filter(f => f.verified).length;
            const total = factChecks.length;
            const percentage = Math.round((verified / total) * 100);
            
            if (percentage >= 90) {
                return `Excellent factual accuracy with ${percentage}% of claims verified. The article demonstrates strong commitment to factual reporting.`;
            } else if (percentage >= 70) {
                return `Good factual accuracy with ${percentage}% of claims verified. Most information is accurate, though some claims couldn't be fully verified.`;
            } else if (percentage >= 50) {
                return `Mixed factual accuracy with ${percentage}% of claims verified. Several claims are questionable or unverifiable. Cross-reference important information.`;
            } else {
                return `Poor factual accuracy with only ${percentage}% of claims verified. Many statements are false or unverifiable. Treat this content with significant skepticism.`;
            }
        }

        // Create mini radar chart for source credibility
        function createMiniRadarChart(canvas, data) {
            const ctx = canvas.getContext('2d');
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Accuracy', 'Transparency', 'Standards', 'Corrections'],
                    datasets: [{
                        data: [
                            data.accuracy || 0,
                            data.transparency || 0,
                            data.standards || 0,
                            data.corrections || 0
                        ],
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(99, 102, 241, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        r: {
                            min: 0,
                            max: 100,
                            ticks: { display: false },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            pointLabels: {
                                font: { size: 10 },
                                color: '#64748b'
                            }
                        }
                    }
                }
            });
        }

        // Progress bar functions
        function showProgress() {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const progressStage = document.getElementById('progressStage');
            
            progressBar.classList.add('active');
            let currentStageIndex = 0;
            
            // Simulate progress through stages
            const progressInterval = setInterval(() => {
                if (currentStageIndex < progressStages.length) {
                    const stage = progressStages[currentStageIndex];
                    progressFill.style.width = stage.progress + '%';
                    progressStage.textContent = stage.name;
                    currentStageIndex++;
                } else {
                    clearInterval(progressInterval);
                }
            }, 800);
            
            // Store interval ID for cleanup
            progressBar.dataset.intervalId = progressInterval;
        }

        function hideProgress() {
            const progressBar = document.getElementById('progressBar');
            const intervalId = progressBar.dataset.intervalId;
            
            if (intervalId) {
                clearInterval(intervalId);
            }
            
            setTimeout(() => {
                progressBar.classList.remove('active');
                document.getElementById('progressFill').style.width = '0%';
            }, 500);
        }

        // Utility functions
        function isValidUrl(string) {
            try {
                const url = new URL(string);
                return url.protocol === 'http:' || url.protocol === 'https:';
            } catch (_) {
                return false;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            } catch (_) {
                return dateString;
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function hideResults() {
            document.getElementById('resultsSection').style.display = 'none';
        }

        // Download PDF function
        function downloadPDF() {
            if (!currentAnalysis) {
                showError('No analysis available to download');
                return;
            }
            
            // Show message that PDF download is coming soon
            showError('PDF download feature coming soon! The feature will allow you to save a complete analysis report.');
            
            // In a real implementation, this would:
            // 1. Call a backend API to generate the PDF
            // 2. Download the generated PDF file
            // For now, we'll just log the data
            console.log('PDF Download requested for:', currentAnalysis);
        }

        // Debug helper
        window.debugTruthLens = () => {
            console.log('Current Analysis:', currentAnalysis);
            console.log('Is Analyzing:', isAnalyzing);
            
            if (currentAnalysis && currentAnalysis.detailed_analysis) {
                console.log('\n=== DETAILED ANALYSIS BREAKDOWN ===');
                Object.entries(currentAnalysis.detailed_analysis).forEach(([service, data]) => {
                    console.log(`\n${service.toUpperCase()}:`);
                    console.log(data);
                });
            }
            
            return currentAnalysis;
        };
        
        // Add a function to manually refresh cards with current data
        window.refreshCards = () => {
            if (currentAnalysis && currentAnalysis.detailed_analysis) {
                displayAnalysisCards(currentAnalysis.detailed_analysis);
            } else {
                console.error('No analysis data available');
            }
        };
    </script>
</body>
</html>

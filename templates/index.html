<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruthLens AI - Professional News Verification Platform</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* Modern Design System */
        :root {
            /* Premium Color Palette */
            --primary: #6366F1;
            --primary-dark: #4F46E5;
            --primary-light: #818CF8;
            --secondary: #EC4899;
            --accent: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;
            
            /* Neutral Colors */
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            
            /* Typography */
            --font-primary: 'Inter', -apple-system, sans-serif;
            --font-display: 'Space Grotesk', sans-serif;
            
            /* Compact Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            
            /* Layout */
            --radius: 0.75rem;
            --radius-sm: 0.375rem;
            --radius-lg: 1rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            --gradient-premium: linear-gradient(135deg, #FFD93D 0%, #FFB344 100%);
            --gradient-dark: linear-gradient(180deg, #1F2937 0%, #111827 100%);
            --gradient-success: linear-gradient(135deg, #10B981 0%, #059669 100%);
            --gradient-warning: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            --gradient-danger: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            --gradient-info: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
        }

        /* Global Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-primary);
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Premium Loading Animation */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: none;
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            position: relative;
        }

        .loading-spinner::before,
        .loading-spinner::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        .loading-spinner::after {
            animation-delay: 0.3s;
            border-top-color: var(--secondary);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Premium Header - Compact */
        .header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-md) var(--space-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .logo-text h1 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-text p {
            font-size: 0.75rem;
            color: var(--gray-600);
        }

        .pro-badge {
            background: var(--gradient-premium);
            color: var(--gray-900);
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Hero Section - Compact */
        .hero-section {
            background: white;
            padding: var(--space-xl) 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .hero-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--space-lg);
            text-align: center;
        }

        .hero-title {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: var(--space-sm);
            background: var(--gradient-dark);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero-subtitle {
            font-size: 1rem;
            color: var(--gray-600);
            margin-bottom: var(--space-lg);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Service Pills - Compact */
        .service-pills {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            justify-content: center;
            margin-bottom: var(--space-lg);
        }

        .service-pill {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: 0.375rem 0.75rem;
            background: var(--gray-100);
            border-radius: 999px;
            font-size: 0.75rem;
            color: var(--gray-700);
        }

        .service-pill i {
            color: var(--primary);
            font-size: 0.875rem;
        }

        /* Input Section - Enhanced with Tabs */
        .input-container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Tab Buttons */
        .input-tabs {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }

        .tab-btn {
            flex: 1;
            padding: var(--space-sm) var(--space-md);
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            color: var(--gray-600);
        }

        .tab-btn:hover {
            border-color: var(--primary-light);
            color: var(--primary);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Help Text */
        .help-text {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            padding: var(--space-md);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-md);
            font-size: 0.875rem;
            color: var(--gray-700);
            line-height: 1.5;
        }

        .help-text i {
            color: var(--info);
            margin-right: var(--space-sm);
        }

        /* Input Wrapper */
        .input-wrapper {
            position: relative;
            display: flex;
            gap: var(--space-sm);
            align-items: center;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            padding: var(--space-xs);
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), var(--shadow-lg);
        }

        .url-input, .text-input {
            flex: 1;
            padding: var(--space-md);
            border: none;
            font-size: 1rem;
            background: transparent;
            outline: none;
            font-family: inherit;
        }

        .text-input {
            min-height: 120px;
            resize: vertical;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }

        .analyze-button, .reset-button {
            padding: var(--space-sm) var(--space-lg);
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            white-space: nowrap;
        }

        .analyze-button {
            background: var(--gradient-primary);
            color: white;
        }

        .analyze-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .analyze-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .reset-button {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .reset-button:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
        }

        /* URL Input Specific */
        .url-input-wrapper {
            display: flex;
            gap: var(--space-sm);
            align-items: stretch;
        }

        .url-input-field {
            flex: 1;
        }

        /* Text Input Specific */
        .text-input-wrapper {
            width: 100%;
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-xl) var(--space-lg);
        }

        /* Results Section */
        .results-section {
            display: none;
            animation: fadeInUp 0.6s ease;
        }

        .results-section.active {
            display: block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced Trust Score Section - Compact */
        .trust-score-section {
            background: white;
            border-radius: var(--radius);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .trust-score-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-lg);
        }

        .trust-score-content {
            display: grid;
            grid-template-columns: 220px 1fr;
            gap: var(--space-lg);
            align-items: start;
        }

        .trust-gauge-container {
            position: relative;
            width: 220px;
            height: 140px;
            background: var(--gray-50);
            border-radius: var(--radius);
            padding: var(--space-md);
            box-shadow: var(--shadow) inset;
        }

        .trust-gauge-visual {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #trustGauge {
            width: 100%;
            height: 100%;
        }

        .trust-score-value {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }

        .trust-score-number {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            display: block;
        }

        .trust-score-label {
            font-size: 0.75rem;
            color: var(--gray-600);
            margin-top: 0.25rem;
        }

        .trust-level-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-xs) var(--space-sm);
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            margin-top: var(--space-sm);
            justify-content: center;
            font-size: 0.875rem;
        }

        .trust-level-icon {
            font-size: 1rem;
        }

        .trust-level-text {
            font-weight: 600;
        }

        .trust-score-details {
            flex: 1;
        }

        .trust-score-details h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: var(--space-sm);
        }

        .trust-summary {
            color: var(--gray-600);
            line-height: 1.6;
            margin-bottom: var(--space-lg);
            font-size: 0.9rem;
        }

        .what-we-analyzed {
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            padding: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .what-we-analyzed-title {
            font-weight: 600;
            margin-bottom: var(--space-xs);
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 0.875rem;
        }

        .what-we-analyzed-title i {
            color: var(--primary);
        }

        .what-we-analyzed-content {
            color: var(--gray-600);
            line-height: 1.5;
            font-size: 0.813rem;
        }

        .trust-breakdown {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
        }

        .breakdown-item {
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            padding: var(--space-md);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .breakdown-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .breakdown-item:hover {
            background: white;
            box-shadow: var(--shadow-md);
        }

        .breakdown-item:hover::before {
            transform: scaleX(1);
        }

        .breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-xs);
        }

        .breakdown-label {
            font-weight: 600;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 0.875rem;
        }

        .breakdown-icon {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
        }

        .breakdown-value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .breakdown-explanation {
            font-size: 0.75rem;
            color: var(--gray-600);
            margin-top: var(--space-xs);
            line-height: 1.4;
        }

        .breakdown-bar {
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            margin-top: var(--space-sm);
            overflow: hidden;
            position: relative;
        }

        .breakdown-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 1s ease-out;
            position: relative;
            overflow: hidden;
        }

        .breakdown-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.3) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        .breakdown-positive { background: rgba(16, 185, 129, 0.1); }
        .breakdown-positive .breakdown-icon { background: rgba(16, 185, 129, 0.2); color: var(--accent); }
        .breakdown-positive .breakdown-fill { background: var(--gradient-success); }

        .breakdown-warning { background: rgba(245, 158, 11, 0.1); }
        .breakdown-warning .breakdown-icon { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .breakdown-warning .breakdown-fill { background: var(--gradient-warning); }

        .breakdown-negative { background: rgba(239, 68, 68, 0.1); }
        .breakdown-negative .breakdown-icon { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .breakdown-negative .breakdown-fill { background: var(--gradient-danger); }

        .breakdown-neutral { background: rgba(59, 130, 246, 0.1); }
        .breakdown-neutral .breakdown-icon { background: rgba(59, 130, 246, 0.2); color: var(--info); }
        .breakdown-neutral .breakdown-fill { background: var(--gradient-info); }

        .download-section {
            display: flex;
            gap: var(--space-sm);
        }

        .download-button {
            padding: var(--space-xs) var(--space-md);
            background: white;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-sm);
            color: var(--gray-700);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 0.875rem;
        }

        .download-button:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--gray-50);
        }

        /* Article Info Section - Compact */
        .article-info-section {
            background: white;
            border-radius: var(--radius);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-md);
        }

        .article-header {
            margin-bottom: var(--space-md);
        }

        .article-title {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: var(--space-sm);
        }

        .article-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-md);
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .meta-item i {
            color: var(--primary);
            font-size: 0.875rem;
        }

        /* Key Findings - Compact */
        .key-findings {
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            padding: var(--space-md);
            border-left: 3px solid var(--primary);
        }

        .key-findings-header {
            font-weight: 600;
            margin-bottom: var(--space-sm);
            color: var(--primary);
            font-size: 0.9rem;
        }

        .finding-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-sm);
            margin-bottom: var(--space-xs);
            line-height: 1.5;
            font-size: 0.813rem;
        }

        .finding-item i {
            margin-top: 0.125rem;
            flex-shrink: 0;
            font-size: 0.875rem;
        }

        .finding-positive i { color: var(--accent); }
        .finding-warning i { color: var(--warning); }
        .finding-negative i { color: var(--danger); }

        /* Accordion Service Container */
        .services-accordion {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        /* Service Accordion Item - Compact with Colored Borders */
        .service-accordion-item {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        /* Different colored borders for each service */
        #service-source_credibility { border-color: #6366F1; }
        #service-author_analyzer { border-color: #10B981; }
        #service-bias_detector { border-color: #F59E0B; }
        #service-fact_checker { border-color: #3B82F6; }
        #service-transparency_analyzer { border-color: #8B5CF6; }
        #service-manipulation_detector { border-color: #EF4444; }
        #service-content_analyzer { border-color: #EC4899; }
        #service-plagiarism_detector { border-color: #14B8A6; }

        .service-accordion-item:hover {
            box-shadow: var(--shadow-lg);
        }

        .service-accordion-item.active {
            box-shadow: var(--shadow-xl);
        }

        /* Prevent auto-scrolling on accordion click */
        .service-accordion-header {
            padding: var(--space-md);
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
            background: white;
            position: relative;
        }

        .service-accordion-header:hover {
            background: var(--gray-50);
        }

        .service-accordion-item.active .service-accordion-header {
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }

        .service-header-content {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .service-icon-wrapper {
            width: 48px;
            height: 48px;
            background: var(--gradient-primary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        /* Match icon wrapper colors to borders */
        #service-source_credibility .service-icon-wrapper { background: linear-gradient(135deg, #6366F1, #4F46E5); }
        #service-author_analyzer .service-icon-wrapper { background: linear-gradient(135deg, #10B981, #059669); }
        #service-bias_detector .service-icon-wrapper { background: linear-gradient(135deg, #F59E0B, #D97706); }
        #service-fact_checker .service-icon-wrapper { background: linear-gradient(135deg, #3B82F6, #2563EB); }
        #service-transparency_analyzer .service-icon-wrapper { background: linear-gradient(135deg, #8B5CF6, #7C3AED); }
        #service-manipulation_detector .service-icon-wrapper { background: linear-gradient(135deg, #EF4444, #DC2626); }
        #service-content_analyzer .service-icon-wrapper { background: linear-gradient(135deg, #EC4899, #DB2777); }
        #service-plagiarism_detector .service-icon-wrapper { background: linear-gradient(135deg, #14B8A6, #0D9488); }

        .service-accordion-item.active .service-icon-wrapper {
            transform: scale(1.05);
        }

        .service-info {
            flex: 1;
        }

        .service-name {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.125rem;
            color: var(--gray-900);
        }

        .service-description {
            font-size: 0.813rem;
            color: var(--gray-600);
            margin-bottom: var(--space-xs);
        }

        .service-preview {
            display: flex;
            gap: var(--space-md);
            align-items: center;
            margin-top: var(--space-xs);
        }

        .preview-item {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 0.75rem;
        }

        .preview-label {
            color: var(--gray-500);
        }

        .preview-value {
            font-weight: 600;
            color: var(--gray-900);
        }

        .service-expand-icon {
            position: absolute;
            right: var(--space-md);
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
            color: var(--gray-400);
            transition: all 0.3s ease;
        }

        .service-accordion-item.active .service-expand-icon {
            transform: translateY(-50%) rotate(180deg);
            color: var(--primary);
        }

        .pro-lock-badge {
            position: absolute;
            top: var(--space-sm);
            right: calc(var(--space-md) + 30px);
            background: var(--gradient-premium);
            color: var(--gray-900);
            padding: 0.125rem 0.5rem;
            border-radius: 999px;
            font-size: 0.675rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .service-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .service-accordion-item.active .service-accordion-content {
            max-height: 2000px;
        }

        .service-content-inner {
            padding: var(--space-lg);
            padding-top: 0;
        }

        /* Service Content Sections - Compact */
        .service-section {
            margin-bottom: var(--space-md);
        }

        .service-section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: var(--space-xs);
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 0.875rem;
        }

        .section-title i {
            color: var(--primary);
            font-size: 0.75rem;
        }

        /* Enhanced Service Content Sections */
        .service-analysis-section {
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
        }

        .service-analysis-section h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: var(--space-sm);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .service-analysis-section h4 i {
            font-size: 0.875rem;
        }

        .service-analysis-section p {
            font-size: 0.813rem;
            line-height: 1.5;
            color: var(--gray-700);
        }

        .service-results {
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            padding: var(--space-sm);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-xs) var(--space-sm);
            border-bottom: 1px solid var(--gray-200);
            font-size: 0.813rem;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 500;
            color: var(--gray-700);
        }

        .result-value {
            font-weight: 600;
            color: var(--gray-900);
        }

        .status-badge {
            padding: 0.125rem 0.5rem;
            border-radius: 999px;
            font-size: 0.675rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-high { background: rgba(16, 185, 129, 0.1); color: var(--accent); }
        .status-medium { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .status-low { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        /* Author Info Enhanced */
        .author-info-enhanced {
            margin-top: var(--space-md);
        }

        .author-info-enhanced h5 {
            font-size: 1rem;
            margin-bottom: var(--space-sm);
            color: var(--gray-900);
        }

        .author-details {
            display: grid;
            gap: var(--space-sm);
        }

        .author-detail-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 0.813rem;
            color: var(--gray-700);
        }

        .author-detail-item i {
            color: var(--primary);
            width: 16px;
        }

        /* Progress Bar */
        .progress-bar {
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            margin: var(--space-sm) 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Dimension Bars - Compact */
        .dimension-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .dimension-item {
            background: white;
            padding: var(--space-sm);
            border-radius: var(--radius-sm);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
        }

        .dimension-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .dimension-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-xs);
            font-size: 0.813rem;
        }

        .dimension-name {
            font-weight: 500;
            color: var(--gray-700);
        }

        .dimension-score {
            font-weight: 600;
            color: var(--gray-900);
        }

        .dimension-bar {
            height: 4px;
            background: var(--gray-200);
            border-radius: 2px;
            overflow: hidden;
        }

        .dimension-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.6s ease;
        }

        /* Claim List - Compact */
        .claims-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .claim-item {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            padding: var(--space-sm);
            transition: all 0.3s ease;
        }

        .claim-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .claim-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-xs);
        }

        .claim-text {
            flex: 1;
            font-weight: 500;
            color: var(--gray-900);
            line-height: 1.4;
            font-size: 0.813rem;
        }

        .claim-status {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: 0.125rem 0.375rem;
            border-radius: var(--radius-sm);
            font-size: 0.675rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .claim-verified { background: rgba(16, 185, 129, 0.1); color: var(--accent); }
        .claim-unverified { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .claim-false { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        .claim-details {
            margin-top: var(--space-xs);
            padding-top: var(--space-xs);
            border-top: 1px solid var(--gray-100);
            font-size: 0.75rem;
            color: var(--gray-600);
            line-height: 1.4;
        }

        /* Technique List - Compact */
        .techniques-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-sm);
        }

        .technique-card {
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            padding: var(--space-sm);
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }

        .technique-card:hover {
            border-color: var(--primary);
            background: white;
            box-shadow: var(--shadow-sm);
        }

        .technique-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-xs);
            font-size: 0.813rem;
        }

        .technique-description {
            font-size: 0.75rem;
            color: var(--gray-600);
            line-height: 1.4;
        }

        .technique-severity {
            display: inline-block;
            margin-top: var(--space-xs);
            padding: 0.0625rem 0.375rem;
            background: var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 0.675rem;
            font-weight: 600;
        }

        .severity-high { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .severity-medium { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .severity-low { background: rgba(59, 130, 246, 0.1); color: var(--info); }

        /* Info Box */
        .info-box {
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            padding: var(--space-md);
            margin-top: var(--space-md);
            border-left: 3px solid var(--info);
        }

        .info-box-title {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-xs);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-size: 0.875rem;
        }

        .info-box-title i {
            color: var(--info);
        }

        .info-box-content {
            color: var(--gray-600);
            line-height: 1.5;
            font-size: 0.813rem;
        }

        /* Visualization Container - Compact */
        .service-visualization {
            margin: var(--space-md) 0;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            padding: var(--space-md);
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }

        /* Trust Components Info */
        .trust-components-info {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.2);
            padding: var(--space-md);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-md);
            font-size: 0.813rem;
        }

        .trust-components-info p {
            margin: 0;
            color: var(--gray-700);
        }

        .missing-info {
            color: var(--warning);
            font-size: 0.813rem;
            margin-top: var(--space-xs);
        }

        .missing-info i {
            margin-right: var(--space-xs);
        }

        /* Example URLs */
        .example-urls {
            margin-top: var(--space-md);
            padding: var(--space-md);
            background: var(--gray-100);
            border-radius: var(--radius-sm);
            text-align: center;
        }

        .example-urls p {
            color: var(--gray-700);
            font-size: 0.813rem;
            margin-bottom: var(--space-sm);
        }

        .example-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
            justify-content: center;
            margin-top: var(--space-sm);
        }

        .example-btn {
            padding: 0.25rem 0.75rem;
            background: white;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .example-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--gray-50);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 1.5rem;
            }

            .trust-score-content {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .trust-gauge-container {
                margin: 0 auto;
            }

            .trust-breakdown {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                gap: var(--space-sm);
            }

            .input-wrapper {
                flex-direction: column;
                padding: var(--space-md);
            }

            .analyze-button {
                width: 100%;
                justify-content: center;
            }

            .techniques-grid {
                grid-template-columns: 1fr;
            }

            .service-preview {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-xs);
            }

            .action-buttons {
                flex-direction: column;
                width: 100%;
            }

            .reset-button {
                width: 100%;
                justify-content: center;
            }
        }

        /* Error State */
        .error-message {
            background: #FEE2E2;
            border: 1px solid #FCA5A5;
            color: #991B1B;
            padding: var(--space-md);
            border-radius: var(--radius-sm);
            margin-top: var(--space-md);
            display: none;
            animation: shake 0.5s ease;
            font-weight: 500;
            text-align: center;
            font-size: 0.875rem;
        }

        .error-message.active {
            display: block;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-xl);
            color: var(--gray-500);
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: var(--space-md);
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1rem;
            margin-bottom: var(--space-xs);
        }

        .empty-state-subtext {
            font-size: 0.813rem;
            color: var(--gray-400);
        }

        /* Data state indicator */
        .data-state-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10B981;
        }

        .data-state-indicator.no-data {
            background: #EF4444;
        }

        .data-state-indicator.partial-data {
            background: #F59E0B;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="logo-text">
                        <h1>TruthLens AI</h1>
                        <p>Professional News Verification</p>
                    </div>
                </div>
                <span class="pro-badge">PRO</span>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title">Advanced AI-Powered News Analysis</h1>
            <p class="hero-subtitle">
                Verify news articles with our comprehensive suite of 8 specialized AI services.
                Get detailed insights on credibility, bias, manipulation, and more.
            </p>

            <!-- Service Pills -->
            <div class="service-pills">
                <div class="service-pill">
                    <i class="fas fa-shield-alt"></i>
                    <span>Source Credibility</span>
                </div>
                <div class="service-pill">
                    <i class="fas fa-user-check"></i>
                    <span>Author Analysis</span>
                </div>
                <div class="service-pill">
                    <i class="fas fa-balance-scale"></i>
                    <span>Bias Detection</span>
                </div>
                <div class="service-pill">
                    <i class="fas fa-check-double"></i>
                    <span>Fact Checking</span>
                </div>
                <div class="service-pill">
                    <i class="fas fa-eye"></i>
                    <span>Transparency Analysis</span>
                </div>
                <div class="service-pill">
                    <i class="fas fa-mask"></i>
                    <span>Manipulation Detection</span>
                </div>
                <div class="service-pill">
                    <i class="fas fa-file-alt"></i>
                    <span>Content Analysis</span>
                </div>
                <div class="service-pill">
                    <i class="fas fa-copy"></i>
                    <span>Plagiarism Detection</span>
                </div>
            </div>

            <!-- Input Section with Tabs -->
            <div class="input-container">
                <!-- Tab Buttons -->
                <div class="input-tabs">
                    <button class="tab-btn active" onclick="switchTab('url')">
                        <i class="fas fa-link"></i>
                        <span>URL</span>
                    </button>
                    <button class="tab-btn" onclick="switchTab('text')">
                        <i class="fas fa-file-text"></i>
                        <span>Text</span>
                    </button>
                </div>

                <!-- URL Tab Content -->
                <div id="url-tab" class="tab-content active">
                    <div class="url-input-wrapper">
                        <div class="input-wrapper url-input-field">
                            <input 
                                type="url" 
                                id="urlInput" 
                                class="url-input" 
                                placeholder="Enter a news article URL to analyze..."
                                autocomplete="off"
                            >
                        </div>
                    </div>
                </div>

                <!-- Text Tab Content -->
                <div id="text-tab" class="tab-content">
                    <div class="help-text">
                        <i class="fas fa-info-circle"></i>
                        <strong>Tip:</strong> Try the URL option first. If the website blocks our analysis (some sites like Washington Post do this), 
                        you can copy and paste the entire article text here instead.
                    </div>
                    <div class="text-input-wrapper">
                        <div class="input-wrapper">
                            <textarea 
                                id="textInput" 
                                class="text-input" 
                                placeholder="Paste the complete article text here..."
                            ></textarea>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button id="analyzeBtn" class="analyze-button" onclick="analyzeArticle()">
                        <i class="fas fa-search"></i>
                        <span>Analyze Article</span>
                    </button>
                    <button id="resetBtn" class="reset-button" onclick="resetAnalysis()">
                        <i class="fas fa-redo"></i>
                        <span>Reset</span>
                    </button>
                </div>

                <div id="errorMessage" class="error-message"></div>
                
                <!-- Example URLs -->
                <div class="example-urls">
                    <p>
                        <strong>Note:</strong> Some sites like Washington Post block automated analysis. Try these instead:
                    </p>
                    <div class="example-buttons">
                        <button class="example-btn" onclick="tryExample('https://www.cnn.com')">CNN</button>
                        <button class="example-btn" onclick="tryExample('https://www.bbc.com/news')">BBC News</button>
                        <button class="example-btn" onclick="tryExample('https://www.reuters.com')">Reuters</button>
                        <button class="example-btn" onclick="tryExample('https://www.npr.org')">NPR</button>
                        <button class="example-btn" onclick="tryExample('https://www.theguardian.com')">The Guardian</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Results Section -->
        <div id="resultsSection" class="results-section">
            <!-- Enhanced Trust Score Section -->
            <div class="trust-score-section">
                <div class="trust-score-header">
                    <div>
                        <h2>Overall Trust Score Analysis</h2>
                    </div>
                    <div class="download-section">
                        <button class="download-button" id="downloadPdfBtn">
                            <i class="fas fa-file-pdf"></i>
                            Download Report
                        </button>
                        <button class="download-button" id="shareResultsBtn">
                            <i class="fas fa-share-alt"></i>
                            Share
                        </button>
                    </div>
                </div>
                <div class="trust-score-content">
                    <div class="trust-gauge-container">
                        <div class="trust-gauge-visual">
                            <canvas id="trustGauge"></canvas>
                        </div>
                        <div id="trustLevelIndicator" class="trust-level-indicator">
                            <i id="trustLevelIcon" class="fas fa-circle trust-level-icon"></i>
                            <span id="trustLevelText" class="trust-level-text">Analyzing...</span>
                        </div>
                    </div>
                    <div class="trust-score-details">
                        <h2>What This Score Means</h2>
                        <p id="trustSummary" class="trust-summary"></p>
                        
                        <div class="what-we-analyzed">
                            <div class="what-we-analyzed-title">
                                <i class="fas fa-search"></i>
                                What We Analyzed
                            </div>
                            <div class="what-we-analyzed-content">
                                We examined 8 critical dimensions of this article including the credibility of the source and author, 
                                potential biases, factual accuracy, transparency of information, manipulation techniques, 
                                content quality, and originality. Each component contributes to the overall trust score.
                            </div>
                        </div>

                        <div id="trustBreakdown" class="trust-breakdown"></div>
                    </div>
                </div>
            </div>

            <!-- Article Info Section -->
            <div class="article-info-section">
                <div class="article-header">
                    <h3 id="articleTitle" class="article-title"></h3>
                    <div id="articleMeta" class="article-meta"></div>
                </div>
                <div id="keyFindings" class="key-findings"></div>
            </div>

            <!-- Services Accordion -->
            <div id="servicesAccordion" class="services-accordion"></div>
        </div>
    </main>

    <script>
        // Global state
        let currentAnalysis = null;
        let isAnalyzing = false;
        let charts = {};
        let isPro = true;
        let currentTab = 'url';

        // Service definitions
        const services = [
            {
                id: 'source_credibility',
                name: 'Source Credibility',
                icon: 'fa-shield-alt',
                description: 'Evaluates the reliability and trustworthiness of the news source',
                isPro: false
            },
            {
                id: 'author_analyzer',
                name: 'Author Analysis',
                icon: 'fa-user-check',
                description: 'Analyzes author credentials and publishing history',
                isPro: false
            },
            {
                id: 'bias_detector',
                name: 'Bias Detection',
                icon: 'fa-balance-scale',
                description: 'Identifies political, ideological, and narrative biases',
                isPro: true
            },
            {
                id: 'fact_checker',
                name: 'Fact Verification',
                icon: 'fa-check-double',
                description: 'Verifies claims against trusted fact-checking databases',
                isPro: true
            },
            {
                id: 'transparency_analyzer',
                name: 'Transparency Analysis',
                icon: 'fa-eye',
                description: 'Evaluates source disclosure and funding transparency',
                isPro: true
            },
            {
                id: 'manipulation_detector',
                name: 'Manipulation Detection',
                icon: 'fa-mask',
                description: 'Detects emotional manipulation and propaganda techniques',
                isPro: true
            },
            {
                id: 'content_analyzer',
                name: 'Content Analysis',
                icon: 'fa-file-alt',
                description: 'Analyzes writing quality, structure, and coherence',
                isPro: true
            },
            {
                id: 'plagiarism_detector',
                name: 'Plagiarism Check',
                icon: 'fa-copy',
                description: 'Checks for copied content and proper attribution',
                isPro: true
            }
        ];

        // Tab switching
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.tab-btn').classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tab}-tab`).classList.add('active');
        }

        // Reset analysis
        function resetAnalysis() {
            // Clear inputs
            document.getElementById('urlInput').value = '';
            document.getElementById('textInput').value = '';
            
            // Hide results
            document.getElementById('resultsSection').classList.remove('active');
            
            // Clear error
            hideError();
            
            // Reset data
            currentAnalysis = null;
            
            // Reset to URL tab
            currentTab = 'url';
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.trim() === 'URL');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('url-tab').classList.add('active');
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Try example URL
        function tryExample(url) {
            // Switch to URL tab
            currentTab = 'url';
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.trim() === 'URL');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('url-tab').classList.add('active');
            
            // Set URL
            document.getElementById('urlInput').value = url;
            document.getElementById('urlInput').focus();
        }

        // CRITICAL FIX: Data structure mapper to handle backend inconsistencies
        class DataStructureMapper {
            static mapServiceData(rawData) {
                console.log('=== DataStructureMapper.mapServiceData called ===');
                console.log('Raw data keys:', Object.keys(rawData));
                
                // Create a normalized structure
                const mapped = {};
                
                // Map each service with fallback field names
                const serviceMappings = {
                    'source_credibility': ['source_credibility'],
                    'author_analyzer': ['author_analyzer', 'author_analysis', 'author_info'],
                    'bias_detector': ['bias_detector', 'bias_analysis', 'bias'],
                    'fact_checker': ['fact_checker', 'fact_checks', 'fact_checking'],
                    'transparency_analyzer': ['transparency_analyzer', 'transparency_analysis', 'transparency'],
                    'manipulation_detector': ['manipulation_detector', 'manipulation_analysis', 'persuasion_analysis'],
                    'content_analyzer': ['content_analyzer', 'content_analysis', 'content'],
                    'plagiarism_detector': ['plagiarism_detector', 'plagiarism_analysis', 'plagiarism']
                };
                
                // Try to find data for each service
                Object.entries(serviceMappings).forEach(([serviceId, possibleNames]) => {
                    for (const name of possibleNames) {
                        if (rawData[name]) {
                            mapped[serviceId] = this.extractServiceData(rawData[name]);
                            console.log(`Mapped ${name} to ${serviceId}`);
                            break;
                        }
                    }
                    
                    // If still not found, create empty structure
                    if (!mapped[serviceId]) {
                        mapped[serviceId] = {};
                        console.log(`No data found for ${serviceId}`);
                    }
                });
                
                return mapped;
            }
            
            static extractServiceData(serviceResult) {
                // If the service result has a 'data' field, extract it
                if (serviceResult && typeof serviceResult === 'object') {
                    if (serviceResult.data && typeof serviceResult.data === 'object') {
                        return serviceResult.data;
                    }
                    // If success is false, return empty object
                    if (serviceResult.success === false) {
                        return {};
                    }
                    // Otherwise return the whole object
                    return serviceResult;
                }
                return {};
            }
            
            static normalizeFactCheckerData(data) {
                // Normalize fact checker data structure
                if (!data) return { claims_checked: 0, verified_count: 0, claims: [] };
                
                const normalized = {
                    claims_checked: data.claims_checked || data.total_claims || 0,
                    verified_count: data.verified_count || data.verified_claims || 0,
                    claims: []
                };
                
                // Extract claims array
                if (data.claims && Array.isArray(data.claims)) {
                    normalized.claims = data.claims;
                } else if (data.results && Array.isArray(data.results)) {
                    normalized.claims = data.results;
                } else if (Array.isArray(data)) {
                    normalized.claims = data;
                }
                
                return normalized;
            }
        }

        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing TruthLens...');
            
            // Add event listener for URL input Enter key
            const urlInput = document.getElementById('urlInput');
            if (urlInput) {
                urlInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        analyzeArticle();
                    }
                });
            }
            
            // Add event listener for text input Ctrl+Enter
            const textInput = document.getElementById('textInput');
            if (textInput) {
                textInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        analyzeArticle();
                    }
                });
            }
            
            // Add click handlers for download and share buttons
            const downloadBtn = document.getElementById('downloadPdfBtn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', downloadPDF);
            }
            
            const shareBtn = document.getElementById('shareResultsBtn');
            if (shareBtn) {
                shareBtn.addEventListener('click', shareResults);
            }
        });

        // Main analysis function - FIXED with comprehensive data handling
        async function analyzeArticle() {
            console.log('analyzeArticle function called');
            
            let url = '';
            let text = '';
            let payload = {};
            
            if (currentTab === 'url') {
                url = document.getElementById('urlInput').value.trim();
                console.log('URL to analyze:', url);
                
                if (!url) {
                    showError('Please enter a URL');
                    return;
                }
                
                if (!isValidUrl(url)) {
                    showError('Please enter a valid URL');
                    return;
                }
                
                payload = { url: url };
            } else {
                text = document.getElementById('textInput').value.trim();
                console.log('Text length:', text.length);
                
                if (!text || text.length < 100) {
                    showError('Please enter at least 100 characters of article text');
                    return;
                }
                
                payload = { text: text };
            }
            
            if (isAnalyzing) {
                console.log('Already analyzing');
                return;
            }
            
            isAnalyzing = true;
            hideError();
            hideResults();
            showLoading();
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            
            console.log('Starting API call to /api/analyze with payload:', payload);
            
            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log('API response status:', response.status);
                
                if (!response.ok) {
                    let errorMessage = 'Analysis failed';
                    try {
                        const errorData = await response.json();
                        console.error('API error response:', errorData);
                        errorMessage = errorData.error || errorData.message || errorMessage;
                    } catch (e) {
                        console.error('Failed to parse error response:', e);
                    }
                    throw new Error(errorMessage);
                }
                
                const responseData = await response.json();
                console.log('=== COMPREHENSIVE API RESPONSE DEBUG ===');
                console.log('Raw API response:', responseData);
                console.log('Response type:', typeof responseData);
                console.log('Response keys:', Object.keys(responseData));
                
                // Extract data from response - handle different response structures
                let data = responseData;
                
                // If response has a data field, use that
                if (responseData.data && typeof responseData.data === 'object') {
                    data = responseData.data;
                    console.log('Extracted data from responseData.data');
                }
                
                // If response has success field and it's false, handle error
                if (responseData.success === false) {
                    throw new Error(responseData.error || 'Analysis failed');
                }
                
                // CRITICAL: Log the complete data structure
                console.log('=== COMPLETE DATA STRUCTURE ===');
                console.log(JSON.stringify(data, null, 2));
                
                // Validate the data structure
                if (!data.analysis || (!data.analysis.trust_score && data.analysis.trust_score !== 0)) {
                    console.error('Invalid response structure - missing analysis.trust_score');
                    throw new Error('Invalid response from server');
                }
                
                // CRITICAL FIX: Normalize the service data
                if (data.detailed_analysis) {
                    console.log('=== BEFORE NORMALIZATION ===');
                    console.log('detailed_analysis keys:', Object.keys(data.detailed_analysis));
                    
                    // Apply data structure mapping
                    data.detailed_analysis = DataStructureMapper.mapServiceData(data.detailed_analysis);
                    
                    console.log('=== AFTER NORMALIZATION ===');
                    console.log('detailed_analysis keys:', Object.keys(data.detailed_analysis));
                }
                
                currentAnalysis = data;
                displayResults(data);
                
            } catch (error) {
                console.error('Analysis error:', error);
                showError(error.message || 'Failed to analyze article. Please try again.');
            } finally {
                isAnalyzing = false;
                hideLoading();
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="fas fa-search"></i> <span>Analyze Article</span>';
            }
        }

        // Display results with enhanced trust score section
        function displayResults(data) {
            console.log('displayResults called with:', data);
            
            if (!data) {
                console.error('No data provided to displayResults');
                showError('No analysis data received');
                return;
            }
            
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.add('active');
            
            // Display each component
            try {
                displayEnhancedTrustScore(data.analysis, data);
            } catch (e) {
                console.error('Error displaying trust score:', e);
            }
            
            try {
                displayArticleInfo(data.article, data.analysis);
            } catch (e) {
                console.error('Error displaying article info:', e);
            }
            
            try {
                displayServiceAccordion(data);
            } catch (e) {
                console.error('Error displaying service accordion:', e);
            }
            
            // Scroll to results smoothly
            setTimeout(() => {
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // Enhanced trust score display with explanations
        function displayEnhancedTrustScore(analysis, fullData) {
            console.log('=== displayEnhancedTrustScore called ===');
            console.log('analysis:', analysis);
            console.log('fullData:', fullData);
            
            if (!analysis) {
                console.error('No analysis data provided to displayEnhancedTrustScore');
                return;
            }
            
            const score = analysis.trust_score || 0;
            const level = analysis.trust_level || 'Unknown';
            
            // Update score display
            createEnhancedTrustGauge(score);
            
            // Update level indicator
            updateTrustLevelIndicator(score, level);
            
            // Update summary with contextual explanation
            const summaryEl = document.getElementById('trustSummary');
            summaryEl.textContent = getTrustSummaryExplanation(score, level, analysis);
            
            // CRITICAL FIX: Use normalized data
            const servicesData = fullData.detailed_analysis || {};
            
            console.log('Services data for trust breakdown:', servicesData);
            
            // Create detailed breakdown with explanations
            const breakdownData = [
                {
                    id: 'source_credibility',
                    icon: 'fa-shield-alt',
                    label: 'Source Credibility',
                    value: extractScore(servicesData.source_credibility, ['credibility_score', 'score']),
                    explanation: getSourceCredibilityExplanation(servicesData.source_credibility)
                },
                {
                    id: 'author_credibility',
                    icon: 'fa-user-check',
                    label: 'Author Credibility',
                    value: extractScore(servicesData.author_analyzer, ['credibility_score', 'score']),
                    explanation: getAuthorCredibilityExplanation(servicesData.author_analyzer)
                },
                {
                    id: 'objectivity',
                    icon: 'fa-balance-scale',
                    label: 'Objectivity Score',
                    value: 100 - extractScore(servicesData.bias_detector, ['overall_bias_score', 'bias_score'], 0),
                    explanation: getObjectivityExplanation(servicesData.bias_detector)
                },
                {
                    id: 'fact_accuracy',
                    icon: 'fa-check-double',
                    label: 'Fact Accuracy',
                    value: calculateFactAccuracy(servicesData.fact_checker),
                    explanation: getFactAccuracyExplanation(servicesData.fact_checker)
                }
            ];
            
            console.log('Breakdown data:', breakdownData);
            
            // Check for missing components and recalculate if needed
            let breakdownHtml = '';
            
            // Add warning if some components failed
            const missingComponents = [];
            breakdownData.forEach(item => {
                if (item.value === 0 && !servicesData[item.id]) {
                    missingComponents.push(item.label);
                }
            });
            
            if (missingComponents.length > 0) {
                breakdownHtml += `
                    <div class="trust-components-info">
                        <p><strong>Note:</strong> The following components could not be analyzed: ${missingComponents.join(', ')}. 
                        The trust score has been calculated based on available components only.</p>
                    </div>
                `;
            }
            
            breakdownData.forEach(item => {
                const type = getBreakdownType(item.value);
                breakdownHtml += `
                    <div class="breakdown-item breakdown-${type}">
                        <div class="breakdown-header">
                            <div class="breakdown-label">
                                <div class="breakdown-icon">
                                    <i class="fas ${item.icon}"></i>
                                </div>
                                <span>${item.label}</span>
                            </div>
                            <div class="breakdown-value">${item.value}%</div>
                        </div>
                        <div class="breakdown-explanation">${item.explanation}</div>
                        <div class="breakdown-bar">
                            <div class="breakdown-fill" style="width: 0%;" data-target="${item.value}"></div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('trustBreakdown').innerHTML = breakdownHtml;
            
            // Animate breakdown bars after DOM update
            setTimeout(() => {
                document.querySelectorAll('.breakdown-fill').forEach(bar => {
                    const target = bar.getAttribute('data-target');
                    bar.style.width = target + '%';
                });
            }, 100);
        }

        // Create enhanced trust gauge that fits properly
        function createEnhancedTrustGauge(score) {
            const canvas = document.getElementById('trustGauge');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width = 220;
            const height = canvas.height = 140;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // Settings
            const centerX = width / 2;
            const centerY = height - 20;
            const radius = 80;
            const startAngle = Math.PI;
            const endAngle = 2 * Math.PI;
            
            // Draw background arc
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, startAngle, endAngle);
            ctx.lineWidth = 20;
            ctx.strokeStyle = '#E5E7EB';
            ctx.stroke();
            
            // Draw score arc
            const scoreAngle = startAngle + (score / 100) * Math.PI;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, startAngle, scoreAngle);
            ctx.lineWidth = 20;
            
            // Create gradient based on score
            const gradient = ctx.createLinearGradient(centerX - radius, 0, centerX + radius, 0);
            if (score >= 80) {
                gradient.addColorStop(0, '#10B981');
                gradient.addColorStop(1, '#059669');
            } else if (score >= 60) {
                gradient.addColorStop(0, '#3B82F6');
                gradient.addColorStop(1, '#2563EB');
            } else if (score >= 40) {
                gradient.addColorStop(0, '#F59E0B');
                gradient.addColorStop(1, '#D97706');
            } else {
                gradient.addColorStop(0, '#EF4444');
                gradient.addColorStop(1, '#DC2626');
            }
            
            ctx.strokeStyle = gradient;
            ctx.lineCap = 'round';
            ctx.stroke();
            
            // Animate the score number
            animateTrustScore(score);
        }

        // Animate trust score number
        function animateTrustScore(targetScore) {
            const scoreEl = document.querySelector('.trust-score-value');
            if (!scoreEl) return;
            
            let currentScore = 0;
            const increment = targetScore / 50;
            const interval = setInterval(() => {
                currentScore += increment;
                if (currentScore >= targetScore) {
                    currentScore = targetScore;
                    clearInterval(interval);
                }
                scoreEl.innerHTML = `
                    <span class="trust-score-number" style="color: ${getScoreColor(currentScore)}">${Math.round(currentScore)}</span>
                    <span class="trust-score-label">out of 100</span>
                `;
            }, 20);
        }

        // Helper function to extract score from nested data
        function extractScore(data, fields, defaultValue = 0) {
            if (!data) return defaultValue;
            
            for (const field of fields) {
                if (data[field] !== undefined && data[field] !== null) {
                    return Number(data[field]) || defaultValue;
                }
            }
            
            return defaultValue;
        }

        // Get contextual trust summary explanation
        function getTrustSummaryExplanation(score, level, analysis) {
            if (score >= 80) {
                return "This article demonstrates high credibility across all dimensions. The source is well-established, the author has verified credentials, minimal bias was detected, and factual claims have been verified. You can generally trust the information presented.";
            } else if (score >= 60) {
                return "This article shows moderate credibility. While some trust indicators are positive, there are areas of concern such as limited source transparency, some detected bias, or unverified claims. Read with a critical eye and cross-reference important information.";
            } else if (score >= 40) {
                return "This article has low credibility. Significant issues were found including questionable source reliability, strong bias indicators, or multiple unverified claims. Be cautious about accepting information at face value and seek additional sources.";
            } else {
                return "This article shows very low credibility. Major red flags include unverifiable sources, extreme bias, false claims, or manipulation techniques. The information presented should not be trusted without extensive verification from reliable sources.";
            }
        }

        // Get explanation for source credibility
        function getSourceCredibilityExplanation(data) {
            if (!data || Object.keys(data).length === 0) return "Unable to verify source credibility";
            
            const score = extractScore(data, ['credibility_score', 'score']);
            const sourceName = data.source_name || data.name || "Unknown source";
            
            if (score >= 80) {
                return `${sourceName} is an established, reputable news source with strong editorial standards and fact-checking processes.`;
            } else if (score >= 60) {
                return `${sourceName} is a moderately credible source with some concerns about consistency or transparency.`;
            } else if (score >= 40) {
                return `${sourceName} has questionable credibility with known issues in reporting accuracy or bias.`;
            } else if (score > 0) {
                return `${sourceName} is not a reliable news source and has a poor track record for accuracy.`;
            } else {
                return "Source could not be verified or is not in our database of known news sources.";
            }
        }

        // Get explanation for author credibility
        function getAuthorCredibilityExplanation(data) {
            if (!data || Object.keys(data).length === 0) return "Author information not available";
            
            const score = extractScore(data, ['credibility_score', 'score']);
            const authorName = data.author_name || data.name || "Unknown author";
            
            if (score >= 80) {
                return `${authorName} is a verified journalist with established credentials and expertise in this topic area.`;
            } else if (score >= 60) {
                return `${authorName} has some journalistic experience but limited verification or expertise in this specific area.`;
            } else if (score >= 40) {
                return `Limited information available about ${authorName}'s credentials or journalistic background.`;
            } else if (score > 0) {
                return `${authorName} has no verifiable journalistic credentials or has credibility concerns.`;
            } else {
                return "No author information provided or author could not be verified.";
            }
        }

        // Get explanation for objectivity
        function getObjectivityExplanation(data) {
            if (!data || Object.keys(data).length === 0) return "Bias analysis not available";
            
            const biasScore = extractScore(data, ['overall_bias_score', 'bias_score'], 0);
            const objectivityScore = 100 - biasScore;
            
            if (objectivityScore >= 80) {
                return "Minimal bias detected. The article presents information objectively with balanced viewpoints.";
            } else if (objectivityScore >= 60) {
                return "Some bias detected in language or framing, but generally maintains journalistic standards.";
            } else if (objectivityScore >= 40) {
                return "Significant bias present through selective facts, loaded language, or one-sided arguments.";
            } else {
                return "Extreme bias detected. The article heavily favors one perspective without balance.";
            }
        }

        // Get explanation for fact accuracy
        function getFactAccuracyExplanation(factCheckerData) {
            console.log('getFactAccuracyExplanation called with:', factCheckerData);
            
            if (!factCheckerData || Object.keys(factCheckerData).length === 0) return "Fact checking not performed";
            
            // Normalize the data
            const normalized = DataStructureMapper.normalizeFactCheckerData(factCheckerData);
            const { claims_checked: total, verified_count: verified } = normalized;
            
            if (total === 0) {
                return "No factual claims found to verify in this article.";
            }
            
            const accuracy = Math.round((verified / total) * 100);
            
            if (accuracy >= 80) {
                return `${verified} of ${total} factual claims verified as accurate through trusted fact-checking sources.`;
            } else if (accuracy >= 60) {
                return `${verified} of ${total} claims verified. Some claims could not be confirmed or contain inaccuracies.`;
            } else if (accuracy >= 40) {
                return `Only ${verified} of ${total} claims could be verified. Multiple unverified or disputed claims present.`;
            } else {
                return `Major factual issues: only ${verified} of ${total} claims are accurate. Contains false or misleading information.`;
            }
        }

        // Calculate fact accuracy percentage
        function calculateFactAccuracy(factCheckerData) {
            console.log('calculateFactAccuracy called with:', factCheckerData);
            
            if (!factCheckerData || Object.keys(factCheckerData).length === 0) return 0;
            
            const normalized = DataStructureMapper.normalizeFactCheckerData(factCheckerData);
            const { claims_checked: total, verified_count: verified } = normalized;
            
            if (total === 0) return 0;
            return Math.round((verified / total) * 100);
        }

        // Update trust level indicator
        function updateTrustLevelIndicator(score, level) {
            const iconEl = document.getElementById('trustLevelIcon');
            const textEl = document.getElementById('trustLevelText');
            const indicatorEl = document.getElementById('trustLevelIndicator');
            
            // Set text
            textEl.textContent = level;
            
            // Set color and icon based on score
            if (score >= 80) {
                iconEl.className = 'fas fa-check-circle trust-level-icon';
                iconEl.style.color = 'var(--accent)';
                indicatorEl.style.background = 'rgba(16, 185, 129, 0.1)';
                indicatorEl.style.border = '2px solid var(--accent)';
            } else if (score >= 60) {
                iconEl.className = 'fas fa-exclamation-circle trust-level-icon';
                iconEl.style.color = 'var(--info)';
                indicatorEl.style.background = 'rgba(59, 130, 246, 0.1)';
                indicatorEl.style.border = '2px solid var(--info)';
            } else if (score >= 40) {
                iconEl.className = 'fas fa-exclamation-triangle trust-level-icon';
                iconEl.style.color = 'var(--warning)';
                indicatorEl.style.background = 'rgba(245, 158, 11, 0.1)';
                indicatorEl.style.border = '2px solid var(--warning)';
            } else {
                iconEl.className = 'fas fa-times-circle trust-level-icon';
                iconEl.style.color = 'var(--danger)';
                indicatorEl.style.background = 'rgba(239, 68, 68, 0.1)';
                indicatorEl.style.border = '2px solid var(--danger)';
            }
        }

        // Get breakdown type based on score
        function getBreakdownType(score) {
            if (score >= 80) return 'positive';
            if (score >= 60) return 'neutral';
            if (score >= 40) return 'warning';
            return 'negative';
        }

        // Display article info
        function displayArticleInfo(article, analysis) {
            document.getElementById('articleTitle').textContent = article?.title || 'Untitled Article';
            
            const metaHtml = `
                <div class="meta-item">
                    <i class="fas fa-user"></i>
                    <span>${article?.author || 'Unknown Author'}</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-globe"></i>
                    <span>${article?.domain || 'Unknown Source'}</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-calendar"></i>
                    <span>${formatDate(article?.publish_date)}</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-clock"></i>
                    <span>${Math.ceil((article?.word_count || 0) / 200)} min read</span>
                </div>
            `;
            document.getElementById('articleMeta').innerHTML = metaHtml;
            
            // Display key findings
            const findings = analysis?.key_findings || [];
            
            if (findings.length > 0) {
                let findingsHtml = '<h4 class="key-findings-header">Key Findings</h4>';
                findings.forEach(finding => {
                    const type = finding.severity === 'positive' ? 'positive' : 
                               finding.severity === 'high' ? 'negative' : 'warning';
                    const icon = type === 'positive' ? 'fa-check-circle' : 
                               type === 'negative' ? 'fa-times-circle' : 'fa-exclamation-circle';
                    
                    findingsHtml += `
                        <div class="finding-item finding-${type}">
                            <i class="fas ${icon}"></i>
                            <span>${escapeHtml(finding.text || finding.finding)}</span>
                        </div>
                    `;
                });
                document.getElementById('keyFindings').innerHTML = findingsHtml;
            } else {
                document.getElementById('keyFindings').innerHTML = `
                    <div class="info-box">
                        <div class="info-box-title">
                            <i class="fas fa-info-circle"></i>
                            Analysis Summary
                        </div>
                        <div class="info-box-content">
                            The detailed analysis of this article is complete. Review the individual service results below for specific insights about credibility, bias, factual accuracy, and more.
                        </div>
                    </div>
                `;
            }
        }

        // Display service accordion - Enhanced with What/Found/Means structure
        function displayServiceAccordion(data) {
            console.log('=== displayServiceAccordion called ===');
            console.log('data structure:', data);
            
            const container = document.getElementById('servicesAccordion');
            container.innerHTML = '';
            
            // Use normalized data
            const servicesData = data.detailed_analysis || {};
            
            console.log('Using servicesData:', servicesData);
            
            services.forEach((service, index) => {
                const serviceData = servicesData[service.id] || {};
                
                console.log(`Creating accordion for ${service.id} with data:`, serviceData);
                
                const accordionItem = createServiceAccordionItem(service, serviceData, index);
                container.appendChild(accordionItem);
            });
        }

        // Create service accordion item with enhanced content
        function createServiceAccordionItem(service, serviceData, index) {
            const item = document.createElement('div');
            item.className = 'service-accordion-item';
            item.id = `service-${service.id}`;
            
            // Add data state indicator
            const hasData = serviceData && Object.keys(serviceData).length > 0;
            const dataStateClass = hasData ? '' : 'no-data';
            
            // Extract preview data
            const previewData = getServicePreviewData(service.id, serviceData);
            
            item.innerHTML = `
                <div class="service-accordion-header" onclick="toggleAccordion('${service.id}', event)">
                    <div class="data-state-indicator ${dataStateClass}"></div>
                    <div class="service-header-content">
                        <div class="service-icon-wrapper">
                            <i class="fas ${service.icon}"></i>
                        </div>
                        <div class="service-info">
                            <h3 class="service-name">${service.name}</h3>
                            <p class="service-description">${service.description}</p>
                            <div class="service-preview">
                                ${previewData.map(preview => `
                                    <div class="preview-item">
                                        <span class="preview-label">${preview.label}:</span>
                                        <span class="preview-value" style="color: ${preview.color || 'inherit'}">
                                            ${preview.value}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    ${service.isPro && !isPro ? '<div class="pro-lock-badge"><i class="fas fa-lock"></i> PRO</div>' : ''}
                    <i class="fas fa-chevron-down service-expand-icon"></i>
                </div>
                <div class="service-accordion-content">
                    <div class="service-content-inner">
                        ${renderEnhancedServiceContent(service, serviceData)}
                    </div>
                </div>
            `;
            
            return item;
        }

        // Get service preview data - FIXED with proper data extraction
        function getServicePreviewData(serviceId, data) {
            const hasData = data && Object.keys(data).length > 0;
            
            if (!hasData) {
                return [{ label: 'Status', value: 'No data available', color: '#6B7280' }];
            }
            
            switch (serviceId) {
                case 'source_credibility':
                    const sourceScore = extractScore(data, ['credibility_score', 'score']);
                    const sourceLevel = data.level || data.credibility_level || getCredibilityLevel(sourceScore);
                    return [
                        { label: 'Score', value: `${sourceScore}/100`, color: getScoreColor(sourceScore) },
                        { label: 'Level', value: sourceLevel }
                    ];
                    
                case 'author_analyzer':
                    const authorScore = extractScore(data, ['credibility_score', 'score']);
                    const verificationStatus = data.verification_status?.verified || 
                                            (authorScore > 0 ? 'Analyzed' : 'Unverified');
                    return [
                        { label: 'Score', value: `${authorScore}/100`, color: getScoreColor(authorScore) },
                        { label: 'Status', value: verificationStatus }
                    ];
                    
                case 'bias_detector':
                    const biasScore = extractScore(data, ['overall_bias_score', 'bias_score'], 0);
                    const biasLevel = data.bias_level || getBiasLevel(biasScore);
                    return [
                        { label: 'Bias Level', value: biasLevel },
                        { label: 'Objectivity', value: `${100 - biasScore}%`, color: getScoreColor(100 - biasScore) }
                    ];
                    
                case 'fact_checker':
                    const normalized = DataStructureMapper.normalizeFactCheckerData(data);
                    const accuracy = normalized.claims_checked > 0 ? 
                        Math.round((normalized.verified_count / normalized.claims_checked) * 100) : 0;
                    return [
                        { label: 'Claims Checked', value: normalized.claims_checked },
                        { label: 'Accuracy', value: `${accuracy}%`, color: getScoreColor(accuracy) }
                    ];
                    
                case 'transparency_analyzer':
                    const transparencyScore = extractScore(data, ['transparency_score', 'score'], 0);
                    const transparencyLevel = data.transparency_level || getTransparencyLevel(transparencyScore);
                    return [
                        { label: 'Score', value: `${transparencyScore}%`, color: getScoreColor(transparencyScore) },
                        { label: 'Level', value: transparencyLevel }
                    ];
                    
                case 'manipulation_detector':
                    const manipLevel = data.manipulation_level || data.level || 'Unknown';
                    const techniquesCount = data.techniques_count || 
                                          (data.techniques ? data.techniques.length : 0);
                    return [
                        { label: 'Risk Level', value: manipLevel },
                        { label: 'Techniques', value: techniquesCount }
                    ];
                    
                case 'content_analyzer':
                    const qualityScore = extractScore(data, ['quality_score', 'score'], 0);
                    const readabilityLevel = data.readability?.level || 
                                           data.readability_level || 
                                           'Not analyzed';
                    return [
                        { label: 'Quality', value: `${qualityScore}/100`, color: getScoreColor(qualityScore) },
                        { label: 'Readability', value: readabilityLevel }
                    ];
                    
                case 'plagiarism_detector':
                    const originalityScore = data.originality_score !== undefined ? 
                        data.originality_score : 
                        (100 - (data.similarity_score || 0));
                    return [
                        { label: 'Originality', value: `${originalityScore}%`, color: getScoreColor(originalityScore) },
                        { label: 'Status', value: originalityScore >= 80 ? 'Original' : 'Issues Found' }
                    ];
                    
                default:
                    return [{ label: 'Status', value: 'Analysis Complete' }];
            }
        }

        // Toggle accordion - FIXED to prevent auto-scrolling
        function toggleAccordion(serviceId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const item = document.getElementById(`service-${serviceId}`);
            const isActive = item.classList.contains('active');
            
            // Close all other items
            document.querySelectorAll('.service-accordion-item').forEach(el => {
                if (el.id !== `service-${serviceId}`) {
                    el.classList.remove('active');
                }
            });
            
            // Toggle current item
            item.classList.toggle('active');
            
            // Don't scroll - let user control their view
        }

        // Render enhanced service content with What/Found/Means structure
        function renderEnhancedServiceContent(service, data) {
            console.log(`Rendering enhanced content for ${service.id}:`, data);
            
            // Check if data exists
            if (!data || Object.keys(data).length === 0) {
                console.log(`No data for ${service.id}`);
                return `
                    <div class="empty-state">
                        <i class="fas fa-info-circle"></i>
                        <p class="empty-state-text">No data available</p>
                        <p class="empty-state-subtext">This analysis could not be completed</p>
                    </div>
                `;
            }
            
            // Check if service is locked
            if (service.isPro && !isPro) {
                return `
                    <div class="empty-state">
                        <i class="fas fa-lock"></i>
                        <p class="empty-state-text">Pro Feature</p>
                        <p class="empty-state-subtext">Upgrade to access ${service.name}</p>
                    </div>
                `;
            }
            
            // Get content based on service type
            const enhancedContent = getEnhancedServiceContent(service.id, data);
            
            return `
                <div class="service-analysis-section">
                    <h4><i class="fas fa-search"></i> What We're Analyzing</h4>
                    <p>${enhancedContent.whatWeAnalyze}</p>
                </div>
                
                <div class="service-analysis-section">
                    <h4><i class="fas fa-clipboard-check"></i> What We Found</h4>
                    ${enhancedContent.whatWeFound}
                </div>
                
                <div class="service-analysis-section">
                    <h4><i class="fas fa-lightbulb"></i> What This Means</h4>
                    <p>${enhancedContent.whatThisMeans}</p>
                </div>
                
                ${enhancedContent.additionalContent || ''}
            `;
        }

        // Get enhanced service content based on service type
        function getEnhancedServiceContent(serviceId, data) {
            switch (serviceId) {
                case 'source_credibility':
                    return getSourceCredibilityContent(data);
                case 'author_analyzer':
                    return getAuthorAnalysisContent(data);
                case 'bias_detector':
                    return getBiasDetectionContent(data);
                case 'fact_checker':
                    return getFactCheckerContent(data);
                case 'transparency_analyzer':
                    return getTransparencyContent(data);
                case 'manipulation_detector':
                    return getManipulationContent(data);
                case 'content_analyzer':
                    return getContentAnalysisContent(data);
                case 'plagiarism_detector':
                    return getPlagiarismContent(data);
                default:
                    return {
                        whatWeAnalyze: 'Analyzing various aspects of the article.',
                        whatWeFound: '<p>Analysis complete.</p>',
                        whatThisMeans: 'The results provide insights into the article\'s credibility.'
                    };
            }
        }

        // Enhanced content functions for each service
        function getSourceCredibilityContent(data) {
            const score = extractScore(data, ['credibility_score', 'score']);
            const sourceName = data.source_name || data.name || 'Unknown Source';
            const sourceInfo = data.source_info || data.details || {};
            
            let findingsHtml = `
                <div class="service-results">
                    <div class="result-item">
                        <span class="result-label">Source Name</span>
                        <span class="result-value">${sourceName}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Credibility Score</span>
                        <span class="result-value">${score}/100</span>
                    </div>
            `;
            
            if (sourceInfo.type) {
                findingsHtml += `
                    <div class="result-item">
                        <span class="result-label">Source Type</span>
                        <span class="result-value">${sourceInfo.type}</span>
                    </div>
                `;
            }
            
            if (sourceInfo.bias) {
                findingsHtml += `
                    <div class="result-item">
                        <span class="result-label">Known Bias</span>
                        <span class="result-value">${sourceInfo.bias}</span>
                    </div>
                `;
            }
            
            findingsHtml += '</div>';
            
            // Add technical analysis if available
            if (data.technical_analysis) {
                const tech = data.technical_analysis;
                findingsHtml += `
                    <div class="service-section">
                        <h5 class="section-title">
                            <i class="fas fa-server"></i>
                            Technical Analysis
                        </h5>
                        <div class="service-results">
                `;
                
                if (tech.age_years !== undefined) {
                    findingsHtml += `
                        <div class="result-item">
                            <span class="result-label">Domain Age</span>
                            <span class="result-value">${tech.age_years.toFixed(1)} years</span>
                        </div>
                    `;
                }
                
                if (tech.ssl && tech.ssl.valid !== undefined) {
                    findingsHtml += `
                        <div class="result-item">
                            <span class="result-label">SSL Certificate</span>
                            <span class="result-value">
                                ${tech.ssl.valid ? 
                                    '<i class="fas fa-check" style="color: var(--accent);"></i> Valid' : 
                                    '<i class="fas fa-times" style="color: var(--danger);"></i> Invalid'}
                            </span>
                        </div>
                    `;
                }
                
                findingsHtml += `
                        </div>
                    </div>
                `;
            }
            
            let meaning = '';
            if (score >= 80) {
                meaning = `${sourceName} is a highly credible news source with strong editorial standards. You can generally trust information from this publication, though it's always good to verify important claims.`;
            } else if (score >= 60) {
                meaning = `${sourceName} has moderate credibility. While they produce legitimate journalism, they may have occasional accuracy issues or slight bias. Cross-reference important claims with other sources.`;
            } else if (score >= 40) {
                meaning = `${sourceName} has questionable credibility. This source has been flagged for bias, inaccuracy, or poor editorial standards. Be very cautious and verify all claims independently.`;
            } else {
                meaning = `${sourceName} is not a reliable source for factual information. This publication has a poor track record for accuracy and may spread misinformation. Seek alternative sources.`;
            }
            
            return {
                whatWeAnalyze: 'We evaluate the publication\'s history, editorial standards, fact-checking practices, ownership transparency, and track record for accuracy. We also perform technical checks on the website\'s age, security certificates, and registration details.',
                whatWeFound: findingsHtml,
                whatThisMeans: meaning
            };
        }

        function getContentAnalysisContent(data) {
            const qualityScore = extractScore(data, ['quality_score', 'score'], 0);
            const readability = data.readability || {};
            
            let findingsHtml = `
                <div class="service-results">
                    <div class="result-item">
                        <span class="result-label">Overall Quality</span>
                        <span class="result-value">${qualityScore}/100</span>
                    </div>
            `;
            
            if (readability.score !== undefined) {
                findingsHtml += `
                    <div class="result-item">
                        <span class="result-label">Readability Score</span>
                        <span class="result-value">${readability.score}/100</span>
                    </div>
                `;
            }
            
            if (readability.level) {
                findingsHtml += `
                    <div class="result-item">
                        <span class="result-label">Reading Level</span>
                        <span class="result-value">${readability.level}</span>
                    </div>
                `;
            }
            
            if (data.word_count) {
                findingsHtml += `
                    <div class="result-item">
                        <span class="result-label">Article Length</span>
                        <span class="result-value">${data.word_count} words</span>
                    </div>
                `;
            }
            
            findingsHtml += '</div>';
            
            // Add quality indicators if available
            if (data.quality_indicators && data.quality_indicators.length > 0) {
                findingsHtml += `
                    <div class="service-section">
                        <h5 class="section-title">
                            <i class="fas fa-check-circle"></i>
                            Quality Indicators
                        </h5>
                        <div class="service-results">
                `;
                
                data.quality_indicators.forEach(indicator => {
                    findingsHtml += `
                        <div class="result-item">
                            <span class="result-label">${indicator}</span>
                            <span class="result-value">
                                <i class="fas fa-check" style="color: var(--accent);"></i>
                            </span>
                        </div>
                    `;
                });
                
                findingsHtml += `
                        </div>
                    </div>
                `;
            }
            
            let meaning = '';
            if (qualityScore >= 80) {
                meaning = 'High-quality content that meets professional journalism standards. Well-structured, clearly written, and properly sourced.';
            } else if (qualityScore >= 60) {
                meaning = 'Good content quality with minor issues. Generally well-written but may have some structural or clarity problems.';
            } else if (qualityScore >= 40) {
                meaning = 'Mediocre content quality. May have issues with structure, clarity, or depth that affect credibility.';
            } else {
                meaning = 'Poor content quality raises credibility concerns. Poorly written, structured, or lacking substance.';
            }
            
            return {
                whatWeAnalyze: 'We evaluate writing quality, readability, article structure, evidence presentation, use of sources, and adherence to journalistic standards.',
                whatWeFound: findingsHtml,
                whatThisMeans: meaning
            };
        }

        function getPlagiarismContent(data) {
            const similarity = data.similarity_score || 0;
            const originality = data.originality_score !== undefined ? 
                data.originality_score : (100 - similarity);
            const status = originality >= 80 ? 'Original' : 
                          originality >= 60 ? 'Mostly Original' : 'Potential Issues';
            
            let findingsHtml = `
                <div class="service-results">
                    <div class="result-item">
                        <span class="result-label">Originality Score</span>
                        <span class="result-value">${originality}%</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Similarity Score</span>
                        <span class="result-value">${similarity}%</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Status</span>
                        <span class="status-badge status-${originality >= 80 ? 'high' : originality >= 60 ? 'medium' : 'low'}">
                            ${status}
                        </span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${originality}%; background: var(--accent);"></div>
                </div>
            `;
            
            // Add matched sources if available
            if (data.matches && data.matches.length > 0) {
                findingsHtml += `
                    <div class="service-section">
                        <h5 class="section-title">
                            <i class="fas fa-link"></i>
                            Similar Content Found
                        </h5>
                        <div class="claims-list">
                `;
                
                data.matches.forEach(match => {
                    const matchPercentage = match.similarity || match.match_percentage || 0;
                    findingsHtml += `
                        <div class="claim-item">
                            <div class="claim-header">
                                <div class="claim-text">${match.source || match.url || 'Unknown source'}</div>
                                <div class="claim-status">
                                    ${matchPercentage}% similar
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                findingsHtml += `
                        </div>
                    </div>
                `;
            }
            
            let meaning = '';
            if (originality >= 80) {
                meaning = 'This appears to be original content. No significant copying detected, indicating proper journalistic work.';
            } else if (originality >= 60) {
                meaning = 'Mostly original with some similar content found. This could be legitimate use of sources or minor copying.';
            } else {
                meaning = 'Significant similarity to existing content detected. This may indicate plagiarism or heavy reliance on other sources without proper attribution.';
            }
            
            return {
                whatWeAnalyze: 'We check for copied content by comparing the article against millions of online sources to detect plagiarism or improper use of others\' work.',
                whatWeFound: findingsHtml,
                whatThisMeans: meaning
            };
        }

        // Helper functions for enhanced content
        function formatDimensionName(dimension) {
            const dimensionNames = {
                'political': 'Political Bias',
                'ideological': 'Ideological Bias',
                'commercial': 'Commercial Bias',
                'sensational': 'Sensationalism',
                'cultural': 'Cultural Bias',
                'nationalistic': 'Nationalistic Bias',
                'establishment': 'Establishment Bias'
            };
            return dimensionNames[dimension.toLowerCase()] || dimension.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function getBiasColor(score) {
            // Lower bias score is better
            if (score <= 20) return 'var(--accent)';
            if (score <= 50) return 'var(--warning)';
            return 'var(--danger)';
        }

        function formatStatus(status) {
            const statusNames = {
                'verified': 'Verified',
                'true': 'True',
                'false': 'False',
                'unverified': 'Unverified',
                'partially_true': 'Partially True',
                'misleading': 'Misleading'
            };
            return statusNames[status.toLowerCase()] || status;
        }

        // Utility functions
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            
            // Make error messages more user-friendly
            let displayMessage = message;
            
            if (message.includes('timed out') || message.includes('timeout')) {
                displayMessage = 'The website took too long to respond. This might be due to the site blocking automated requests. Try using the Text option instead.';
            } else if (message.includes('extraction methods failed')) {
                displayMessage = 'Unable to extract article content. The website may be blocking our service. Try copying and pasting the article text instead.';
            } else if (message.includes('Invalid URL')) {
                displayMessage = 'Please enter a valid news article URL starting with http:// or https://';
            } else if (message.includes('Analysis failed')) {
                displayMessage = 'Unable to analyze the article. Please try a different URL or use the text option.';
            }
            
            errorEl.textContent = displayMessage;
            errorEl.classList.add('active');
            
            setTimeout(() => {
                hideError();
            }, 10000);
        }

        function hideError() {
            const errorEl = document.getElementById('errorMessage');
            errorEl.classList.remove('active');
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function hideResults() {
            document.getElementById('resultsSection').classList.remove('active');
        }

        function getScoreColor(score) {
            if (score >= 80) return '#10B981';
            if (score >= 60) return '#3B82F6';
            if (score >= 40) return '#F59E0B';
            return '#EF4444';
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        // Helper functions for missing level calculations
        function getCredibilityLevel(score) {
            if (score >= 80) return 'Very High';
            if (score >= 60) return 'High';
            if (score >= 40) return 'Moderate';
            if (score >= 20) return 'Low';
            return 'Very Low';
        }

        function getBiasLevel(score) {
            if (score <= 20) return 'Minimal';
            if (score <= 40) return 'Low';
            if (score <= 60) return 'Moderate';
            if (score <= 80) return 'High';
            return 'Extreme';
        }

        function getTransparencyLevel(score) {
            if (score >= 80) return 'Highly Transparent';
            if (score >= 60) return 'Transparent';
            if (score >= 40) return 'Partially Transparent';
            return 'Low Transparency';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Enhanced PDF download
        async function downloadPDF() {
            if (!currentAnalysis || !currentAnalysis.analysis || !currentAnalysis.article) {
                showError('No analysis available to download');
                return;
            }
            
            showLoading();
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPosition = 20;
                const lineHeight = 7;
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 20;
                const contentWidth = pageWidth - (2 * margin);
                
                // Helper function to add text with page break check
                function addText(text, fontSize = 12, fontStyle = 'normal', indent = 0) {
                    doc.setFontSize(fontSize);
                    doc.setFont(undefined, fontStyle);
                    
                    const lines = doc.splitTextToSize(text, contentWidth - indent);
                    
                    lines.forEach(line => {
                        if (yPosition > pageHeight - 30) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        doc.text(line, margin + indent, yPosition);
                        yPosition += fontSize === 12 ? lineHeight : lineHeight + 2;
                    });
                }
                
                // Title Page
                doc.setFillColor(99, 102, 241);
                doc.rect(0, 0, pageWidth, 60, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.text('TruthLens AI Analysis Report', pageWidth / 2, 30, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text('Professional News Verification', pageWidth / 2, 45, { align: 'center' });
                
                doc.setTextColor(0, 0, 0);
                yPosition = 80;
                
                // Executive Summary
                addText('EXECUTIVE SUMMARY', 18, 'bold');
                yPosition += 5;
                
                addText(`URL: ${currentTab === 'url' ? document.getElementById('urlInput').value : 'Text Analysis'}`, 12);
                addText(`Analysis Date: ${new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })}`, 12);
                
                yPosition += 10;
                
                // Trust Score Box
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition, contentWidth, 40, 'F');
                
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text(`Overall Trust Score: ${currentAnalysis.analysis.trust_score}/100`, margin + 10, yPosition + 15);
                
                doc.setFontSize(14);
                doc.text(`Trust Level: ${currentAnalysis.analysis.trust_level}`, margin + 10, yPosition + 30);
                
                yPosition += 50;
                
                // Article Information
                addText('ARTICLE INFORMATION', 16, 'bold');
                yPosition += 5;
                
                addText(`Title: ${currentAnalysis.article.title || 'Unknown'}`, 12);
                addText(`Author: ${currentAnalysis.article.author || 'Unknown'}`, 12);
                addText(`Source: ${currentAnalysis.article.domain || 'Unknown'}`, 12);
                addText(`Publication Date: ${formatDate(currentAnalysis.article.publish_date)}`, 12);
                addText(`Word Count: ${currentAnalysis.article.word_count || 'Unknown'}`, 12);
                
                yPosition += 10;
                
                // Trust Score Analysis
                addText('TRUST SCORE ANALYSIS', 16, 'bold');
                yPosition += 5;
                addText(getTrustSummaryExplanation(currentAnalysis.analysis.trust_score, currentAnalysis.analysis.trust_level, currentAnalysis.analysis), 12);
                
                yPosition += 10;
                
                // Component Scores
                addText('TRUST COMPONENTS', 16, 'bold');
                yPosition += 5;
                
                const detailedAnalysis = currentAnalysis.detailed_analysis || {};
                const components = [
                    {
                        name: 'Source Credibility',
                        score: extractScore(detailedAnalysis.source_credibility, ['credibility_score', 'score']),
                        explanation: getSourceCredibilityExplanation(detailedAnalysis.source_credibility)
                    },
                    {
                        name: 'Author Credibility',
                        score: extractScore(detailedAnalysis.author_analyzer, ['credibility_score', 'score']),
                        explanation: getAuthorCredibilityExplanation(detailedAnalysis.author_analyzer)
                    },
                    {
                        name: 'Objectivity Score',
                        score: 100 - extractScore(detailedAnalysis.bias_detector, ['overall_bias_score', 'bias_score'], 0),
                        explanation: getObjectivityExplanation(detailedAnalysis.bias_detector)
                    },
                    {
                        name: 'Fact Accuracy',
                        score: calculateFactAccuracy(detailedAnalysis.fact_checker),
                        explanation: getFactAccuracyExplanation(detailedAnalysis.fact_checker)
                    }
                ];
                
                components.forEach(comp => {
                    addText(`${comp.name}: ${comp.score}%`, 12, 'bold');
                    addText(comp.explanation, 11, 'normal', 5);
                    yPosition += 3;
                });
                
                // Key Findings
                if (currentAnalysis.analysis.key_findings && currentAnalysis.analysis.key_findings.length > 0) {
                    yPosition += 10;
                    addText('KEY FINDINGS', 16, 'bold');
                    yPosition += 5;
                    
                    currentAnalysis.analysis.key_findings.forEach((finding, index) => {
                        const findingText = `${index + 1}. ${finding.text || finding.finding}`;
                        const severity = finding.severity === 'positive' ? '✓' : 
                                       finding.severity === 'high' ? '⚠' : '•';
                        addText(`${severity} ${findingText}`, 12, 'normal', 5);
                    });
                }
                
                // New page for detailed analysis
                doc.addPage();
                yPosition = 20;
                
                addText('DETAILED ANALYSIS', 18, 'bold');
                yPosition += 10;
                
                // Process each service
                services.forEach(service => {
                    const serviceData = detailedAnalysis[service.id];
                    if (!serviceData || Object.keys(serviceData).length === 0) return;
                    
                    // Add page break if needed
                    if (yPosition > pageHeight - 80) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    // Service header
                    doc.setFillColor(245, 245, 245);
                    doc.rect(margin, yPosition, contentWidth, 10, 'F');
                    addText(service.name.toUpperCase(), 14, 'bold');
                    yPosition += 5;
                    
                    // Service-specific content
                    const previewData = getServicePreviewData(service.id, serviceData);
                    previewData.forEach(item => {
                        addText(`${item.label}: ${item.value}`, 12);
                    });
                    
                    // Add service summary if available
                    if (serviceData.summary) {
                        yPosition += 3;
                        addText('Summary:', 12, 'bold');
                        addText(serviceData.summary, 11, 'normal', 5);
                    }
                    
                    yPosition += 10;
                });
                
                // Footer
                doc.setFontSize(10);
                doc.setTextColor(128, 128, 128);
                const totalPages = doc.internal.getNumberOfPages();
                
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.text(
                        `Page ${i} of ${totalPages} | Generated by TruthLens AI | ${new Date().toLocaleDateString()}`,
                        pageWidth / 2,
                        pageHeight - 10,
                        { align: 'center' }
                    );
                }
                
                // Save the PDF
                const fileName = `truthlens-analysis-${Date.now()}.pdf`;
                doc.save(fileName);
                
            } catch (error) {
                console.error('PDF generation error:', error);
                showError('Failed to generate PDF report. Please try again.');
            } finally {
                hideLoading();
            }
        }

        // Share results
        function shareResults() {
            if (!currentAnalysis || !currentAnalysis.analysis) {
                showError('No analysis available to share');
                return;
            }
            
            const trustScore = currentAnalysis.analysis.trust_score || 0;
            const articleTitle = currentAnalysis.article.title || 'Article';
            
            const shareText = `TruthLens AI Analysis: "${articleTitle}" scored ${trustScore}/100 for trustworthiness. Check out the detailed analysis:`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'TruthLens AI Analysis',
                    text: shareText,
                    url: window.location.href
                }).catch(err => {
                    console.log('Share cancelled:', err);
                });
            } else {
                // Fallback: Copy link to clipboard
                const url = window.location.href;
                navigator.clipboard.writeText(`${shareText} ${url}`).then(() => {
                    showError('Analysis link copied to clipboard!');
                    setTimeout(hideError, 3000);
                }).catch(() => {
                    showError('Sharing is not supported on this device');
                });
            }
        }

        // Make toggleAccordion function global so onclick can access it
        window.toggleAccordion = toggleAccordion;
    </script>
</body>
</html>tml,
                whatThisMeans: meaning
            };
        }

        function getAuthorAnalysisContent(data) {
            const authorName = data.author_name || data.name || 'Unknown Author';
            const score = extractScore(data, ['credibility_score', 'score']);
            const authorInfo = data.author_info || data.professional_info || {};
            
            let findingsHtml = `
                <div class="author-info-enhanced">
                    <h5>${authorName}</h5>
                    <div class="author-details">
            `;
            
            if (authorInfo.current_position || authorInfo.position) {
                findingsHtml += `
                    <div class="author-detail-item">
                        <i class="fas fa-briefcase"></i>
                        <span>${authorInfo.current_position || authorInfo.position}</span>
                    </div>
                `;
            }
            
            if (authorInfo.years_experience) {
                findingsHtml += `
                    <div class="author-detail-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span>${authorInfo.years_experience}+ years of experience</span>
                    </div>
                `;
            }
            
            if (authorInfo.outlets && authorInfo.outlets.length > 0) {
                findingsHtml += `
                    <div class="author-detail-item">
                        <i class="fas fa-newspaper"></i>
                        <span>Published in: ${authorInfo.outlets.slice(0, 3).join(', ')}</span>
                    </div>
                `;
            }
            
            if (authorInfo.expertise_areas && authorInfo.expertise_areas.length > 0) {
                findingsHtml += `
                    <div class="author-detail-item">
                        <i class="fas fa-graduation-cap"></i>
                        <span>Expertise: ${authorInfo.expertise_areas.join(', ')}</span>
                    </div>
                `;
            }
            
            if (data.verification_status?.verified) {
                findingsHtml += `
                    <div class="author-detail-item">
                        <i class="fas fa-check-circle" style="color: var(--accent);"></i>
                        <span>Verified journalist</span>
                    </div>
                `;
            }
            
            findingsHtml += `
                    </div>
                </div>
                <div class="service-results" style="margin-top: 1rem;">
                    <div class="result-item">
                        <span class="result-label">Credibility Score</span>
                        <span class="result-value">${score}/100</span>
                    </div>
                </div>
            `;
            
            let meaning = '';
            if (score >= 80) {
                meaning = 'This is a well-established journalist with verified credentials and relevant expertise. Their work is generally trustworthy and follows professional journalism standards.';
            } else if (score >= 60) {
                meaning = 'The author has some verifiable journalistic background, though information is limited. Their work appears legitimate but consider the source and topic expertise.';
            } else if (score >= 40) {
                meaning = 'Limited information is available about this author\'s credentials. This doesn\'t necessarily mean the content is unreliable, but additional verification is recommended.';
            } else {
                meaning = 'No verifiable information found about this author. This significantly reduces accountability and credibility. Be extra cautious with claims made in this article.';
            }
            
            return {
                whatWeAnalyze: 'We search for the author\'s professional history, verify their identity, check their publication record across major news outlets, identify areas of expertise, and look for any conflicts of interest or credibility concerns.',
                whatWeFound: findingsHtml,
                whatThisMeans: meaning
            };
        }

        function getBiasDetectionContent(data) {
            const overallBias = extractScore(data, ['overall_bias_score', 'bias_score'], 0);
            const biasLevel = data.bias_level || getBiasLevel(overallBias);
            const objectivityScore = 100 - overallBias;
            
            let findingsHtml = `
                <div class="service-results">
                    <div class="result-item">
                        <span class="result-label">Overall Bias Score</span>
                        <span class="result-value">${overallBias}/100</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Bias Level</span>
                        <span class="status-badge status-${overallBias <= 20 ? 'high' : overallBias <= 50 ? 'medium' : 'low'}">
                            ${biasLevel}
                        </span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Objectivity Score</span>
                        <span class="result-value">${objectivityScore}%</span>
                    </div>
                </div>
            `;
            
            // Add bias dimensions if available
            const dimensions = data.dimensions || data.bias_dimensions || {};
            if (Object.keys(dimensions).length > 0) {
                findingsHtml += `
                    <div class="service-section">
                        <h5 class="section-title">
                            <i class="fas fa-chart-bar"></i>
                            Bias Dimensions
                        </h5>
                        <div class="dimension-list">
                `;
                
                Object.entries(dimensions).forEach(([dimension, dimData]) => {
                    let score = 0;
                    let label = '';
                    
                    if (typeof dimData === 'object' && dimData !== null) {
                        score = Math.abs(dimData.score || dimData.value || 0);
                        if (score <= 1) score *= 100;
                        label = dimData.label || formatDimensionName(dimension);
                    } else {
                        score = Math.abs(Number(dimData) || 0);
                        if (score <= 1) score *= 100;
                        label = formatDimensionName(dimension);
                    }
                    
                    findingsHtml += `
                        <div class="dimension-item">
                            <div class="dimension-header">
                                <span class="dimension-name">${label}</span>
                                <span class="dimension-score">${Math.round(score)}%</span>
                            </div>
                            <div class="dimension-bar">
                                <div class="dimension-fill" style="width: ${score}%; background: ${getBiasColor(score)};"></div>
                            </div>
                        </div>
                    `;
                });
                
                findingsHtml += `
                        </div>
                    </div>
                `;
            }
            
            // Add manipulation tactics if found
            if (data.manipulation_tactics && data.manipulation_tactics.length > 0) {
                findingsHtml += `
                    <div class="service-section">
                        <h5 class="section-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            Manipulation Tactics Detected
                        </h5>
                        <div class="techniques-grid">
                `;
                
                data.manipulation_tactics.slice(0, 4).forEach(tactic => {
                    findingsHtml += `
                        <div class="technique-card">
                            <div class="technique-name">${tactic.name || tactic}</div>
                            ${tactic.description ? `<div class="technique-description">${tactic.description}</div>` : ''}
                        </div>
                    `;
                });
                
                findingsHtml += `
                        </div>
                    </div>
                `;
            }
            
            let meaning = '';
            if (objectivityScore >= 80) {
                meaning = 'This article maintains high objectivity with minimal bias. The reporting appears balanced and factual, presenting multiple perspectives fairly.';
            } else if (objectivityScore >= 60) {
                meaning = 'Some bias is present but within acceptable journalistic bounds. Be aware of the slight perspective while the core facts remain reliable.';
            } else if (objectivityScore >= 40) {
                meaning = 'Significant bias detected. The article favors a particular viewpoint through selective facts, loaded language, or one-sided arguments. Read critically.';
            } else {
                meaning = 'Extreme bias makes this more opinion/advocacy than news. The strong slant may distort facts. Seek alternative sources for balanced information.';
            }
            
            return {
                whatWeAnalyze: 'We analyze language patterns, emotional tone, source selection, story framing, and rhetorical techniques. We check for political, ideological, commercial, and sensational biases that might influence how information is presented.',
                whatWeFound: findingsHtml,
                whatThisMeans: meaning
            };
        }

        function getFactCheckerContent(data) {
            const normalized = DataStructureMapper.normalizeFactCheckerData(data);
            const { claims_checked: total, verified_count: verified, claims } = normalized;
            const accuracy = total > 0 ? Math.round((verified / total) * 100) : 0;
            
            let findingsHtml = `
                <div class="service-results">
                    <div class="result-item">
                        <span class="result-label">Claims Analyzed</span>
                        <span class="result-value">${total}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Verified Claims</span>
                        <span class="result-value">${verified}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Accuracy Rate</span>
                        <span class="result-value">${accuracy}%</span>
                    </div>
                </div>
            `;
            
            if (total > 0) {
                findingsHtml += `
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${accuracy}%"></div>
                    </div>
                `;
            }
            
            // Add individual claims if available
            if (claims && claims.length > 0) {
                findingsHtml += `
                    <div class="service-section">
                        <h5 class="section-title">
                            <i class="fas fa-list"></i>
                            Claims Analyzed
                        </h5>
                        <div class="claims-list">
                `;
                
                claims.slice(0, 5).forEach(claim => {
                    const claimText = claim.claim || claim.claim_text || claim.text || 'Unknown claim';
                    const status = claim.verdict || claim.verification_status || 'unverified';
                    const statusLower = status.toLowerCase();
                    const statusClass = statusLower.includes('true') || statusLower === 'verified' ? 'verified' : 
                                      statusLower.includes('false') ? 'false' : 'unverified';
                    const statusIcon = statusClass === 'verified' ? 'fa-check' : 
                                     statusClass === 'false' ? 'fa-times' : 'fa-question';
                    
                    findingsHtml += `
                        <div class="claim-item">
                            <div class="claim-header">
                                <div class="claim-text">"${escapeHtml(claimText)}"</div>
                                <div class="claim-status claim-${statusClass}">
                                    <i class="fas ${statusIcon}"></i>
                                    ${formatStatus(status)}
                                </div>
                            </div>
                            ${claim.explanation || claim.evidence ? `
                                <div class="claim-details">
                                    ${claim.explanation || claim.evidence}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                findingsHtml += `
                        </div>
                    </div>
                `;
            }
            
            let meaning = '';
            if (total === 0) {
                meaning = 'This article makes few specific factual claims, focusing more on opinion or analysis. This isn\'t necessarily negative but limits our ability to verify accuracy.';
            } else if (accuracy >= 80) {
                meaning = 'The vast majority of factual claims are accurate and verifiable. This indicates careful reporting and fact-checking by the author.';
            } else if (accuracy >= 60) {
                meaning = 'Most claims are accurate, but some could not be verified or contain minor inaccuracies. Cross-reference important information.';
            } else {
                meaning = 'Many claims could not be verified or appear to be inaccurate. Be very cautious about accepting information from this article without independent verification.';
            }
            
            return {
                whatWeAnalyze: 'We identify specific factual claims in the article and verify them against 21+ authoritative sources including fact-checking databases, academic sources, government data, and trusted news archives.',
                whatWeFound: findingsHtml,
                whatThisMeans: meaning
            };
        }

        function getTransparencyContent(data) {
            const score = extractScore(data, ['transparency_score', 'score'], 0);
            const level = data.transparency_level || data.level || getTransparencyLevel(score);
            
            let findingsHtml = `
                <div class="service-results">
                    <div class="result-item">
                        <span class="result-label">Transparency Score</span>
                        <span class="result-value">${score}%</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Transparency Level</span>
                        <span class="status-badge status-${score >= 70 ? 'high' : score >= 40 ? 'medium' : 'low'}">
                            ${level}
                        </span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${score}%"></div>
                </div>
            `;
            
            // Add transparency indicators
            const indicators = {
                'Author Attribution': data.has_author !== false,
                'Publication Date': data.has_date !== false,
                'Source Citations': data.has_sources !== false,
                'Corrections Policy': data.has_corrections_policy || false,
                'Funding Disclosure': data.has_funding_disclosure || false
            };
            
            findingsHtml += `
                <div class="service-section">
                    <h5 class="section-title">
                        <i class="fas fa-list-check"></i>
                        Transparency Checklist
                    </h5>
                    <div class="service-results">
            `;
            
            Object.entries(indicators).forEach(([name, present]) => {
                findingsHtml += `
                    <div class="result-item">
                        <span class="result-label">${name}</span>
                        <span class="result-value">
                            ${present ? 
                                '<i class="fas fa-check" style="color: var(--accent);"></i> Present' : 
                                '<i class="fas fa-times" style="color: var(--danger);"></i> Missing'}
                        </span>
                    </div>
                `;
            });
            
            findingsHtml += `
                    </div>
                </div>
            `;
            
            let meaning = '';
            if (score >= 80) {
                meaning = 'Excellent transparency enhances credibility. Clear attribution, proper sourcing, and disclosure policies allow readers to verify information and understand potential biases.';
            } else if (score >= 60) {
                meaning = 'Good transparency overall, though some elements could be clearer. Most important information is properly attributed and sourced.';
            } else if (score >= 40) {
                meaning = 'Limited transparency raises concerns. Missing attribution or sources make it difficult to verify claims or assess potential conflicts of interest.';
            } else {
                meaning = 'Poor transparency is a major red flag. Without proper attribution, sources, or disclosures, this content cannot be properly evaluated or verified.';
            }
            
            return {
                whatWeAnalyze: 'We check for proper author attribution, publication dates, source citations, correction policies, funding disclosures, and conflicts of interest statements that allow readers to evaluate the content.',
                whatWeFound: findingsHtml,
                whatThisMeans: meaning
            };
        }

        function getManipulationContent(data) {
            const level = data.manipulation_level || data.level || 'Unknown';
            const techniques = data.techniques || [];
            const techniquesCount = data.techniques_count || techniques.length;
            
            let findingsHtml = `
                <div class="service-results">
                    <div class="result-item">
                        <span class="result-label">Manipulation Level</span>
                        <span class="status-badge status-${
                            level.toLowerCase() === 'low' || level.toLowerCase() === 'minimal' ? 'high' : 
                            level.toLowerCase() === 'moderate' ? 'medium' : 'low'
                        }">
                            ${level}
                        </span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Techniques Detected</span>
                        <span class="result-value">${techniquesCount}</span>
                    </div>
                </div>
            `;
            
            // Add detected techniques
            if (techniques.length > 0) {
                findingsHtml += `
                    <div class="service-section">
                        <h5 class="section-title">
                            <i class="fas fa-brain"></i>
                            Manipulation Techniques Found
                        </h5>
                        <div class="techniques-grid">
                `;
                
                techniques.slice(0, 6).forEach(technique => {
                    const techName = technique.name || technique.type || technique.technique || 'Unknown';
                    const techDesc = technique.description || technique.details || '';
                    
                    findingsHtml += `
                        <div class="technique-card">
                            <div class="technique-name">${techName}</div>
                            ${techDesc ? `<div class="technique-description">${techDesc}</div>` : ''}
                            ${technique.severity ? 
                                `<span class="technique-severity severity-${technique.severity.toLowerCase()}">
                                    ${technique.severity} impact
                                </span>` : ''}
                        </div>
                    `;
                });
                
                findingsHtml += `
                        </div>
                    </div>
                `;
            }
            
            let meaning = '';
            if (techniquesCount === 0) {
                meaning = 'No significant manipulation tactics detected. The article presents information straightforwardly without attempting to unduly influence emotions or opinions.';
            } else if (techniquesCount <= 2) {
                meaning = 'Minor persuasion techniques present. While not necessarily malicious, be aware these may influence how you perceive the information.';
            } else if (techniquesCount <= 4) {
                meaning = 'Multiple manipulation tactics detected. The article actively tries to influence your emotions and opinions. Read very critically.';
            } else {
                meaning = 'Heavy manipulation detected. This content appears designed to manipulate rather than inform. Approach with extreme skepticism.';
            }
            
            return {
                whatWeAnalyze: 'We identify psychological manipulation techniques, emotional exploitation, logical fallacies, propaganda methods, and other tactics designed to influence readers beyond presenting facts.',
                whatWeFound: findingsH

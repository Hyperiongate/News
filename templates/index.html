<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruthLens AI - Professional News Verification Platform</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* Modern Design System */
        :root {
            /* Premium Color Palette */
            --primary: #6366F1;
            --primary-dark: #4F46E5;
            --primary-light: #818CF8;
            --secondary: #EC4899;
            --accent: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;
            
            /* Neutral Colors */
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            
            /* Typography */
            --font-primary: 'Inter', -apple-system, sans-serif;
            --font-display: 'Space Grotesk', sans-serif;
            
            /* Spacing */
            --space-xs: 0.5rem;
            --space-sm: 1rem;
            --space-md: 1.5rem;
            --space-lg: 2rem;
            --space-xl: 3rem;
            --space-2xl: 4rem;
            
            /* Layout */
            --radius: 1rem;
            --radius-sm: 0.5rem;
            --radius-lg: 1.5rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            --gradient-premium: linear-gradient(135deg, #FFD93D 0%, #FFB344 100%);
            --gradient-dark: linear-gradient(180deg, #1F2937 0%, #111827 100%);
            --gradient-success: linear-gradient(135deg, #10B981 0%, #059669 100%);
            --gradient-warning: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            --gradient-danger: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            --gradient-info: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
        }

        /* Global Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Premium Loading Animation */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: none;
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            position: relative;
        }

        .loading-spinner::before,
        .loading-spinner::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        .loading-spinner::after {
            animation-delay: 0.3s;
            border-top-color: var(--secondary);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Premium Header */
        .header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-md) var(--space-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--gradient-primary);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .logo-text h1 {
            font-family: var(--font-display);
            font-size: 1.875rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-text p {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .pro-badge {
            background: var(--gradient-premium);
            color: var(--gray-900);
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Hero Section */
        .hero-section {
            background: white;
            padding: var(--space-2xl) 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .hero-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--space-lg);
            text-align: center;
        }

        .hero-title {
            font-family: var(--font-display);
            font-size: 3rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: var(--space-md);
            background: var(--gradient-dark);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero-subtitle {
            font-size: 1.25rem;
            color: var(--gray-600);
            margin-bottom: var(--space-xl);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Service Pills */
        .service-pills {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            justify-content: center;
            margin-bottom: var(--space-xl);
        }

        .service-pill {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: 0.5rem 1rem;
            background: var(--gray-100);
            border-radius: 999px;
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        .service-pill i {
            color: var(--primary);
        }

        /* Input Section */
        .input-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            gap: var(--space-sm);
            align-items: center;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-xs);
            transition: all 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), var(--shadow-xl);
        }

        .url-input {
            flex: 1;
            padding: var(--space-md);
            border: none;
            font-size: 1rem;
            background: transparent;
            outline: none;
        }

        .analyze-button {
            padding: var(--space-md) var(--space-xl);
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            white-space: nowrap;
        }

        .analyze-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .analyze-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-xl) var(--space-lg);
        }

        /* Results Section */
        .results-section {
            display: none;
            animation: fadeInUp 0.6s ease;
        }

        .results-section.active {
            display: block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced Trust Score Section */
        .trust-score-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .trust-score-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-lg);
        }

        .trust-score-content {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: var(--space-xl);
            align-items: start;
        }

        .trust-gauge-container {
            position: relative;
            width: 280px;
            height: 280px;
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow) inset;
        }

        .trust-gauge-visual {
            position: relative;
            width: 100%;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .trust-score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .trust-score-number {
            font-size: 4rem;
            font-weight: 700;
            line-height: 1;
            display: block;
        }

        .trust-score-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-top: 0.5rem;
        }

        .trust-level-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            background: var(--gray-50);
            border-radius: var(--radius);
            margin-top: var(--space-md);
            justify-content: center;
        }

        .trust-level-icon {
            font-size: 1.25rem;
        }

        .trust-level-text {
            font-weight: 600;
            font-size: 1.125rem;
        }

        .trust-score-details {
            flex: 1;
        }

        .trust-score-details h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: var(--space-md);
        }

        .trust-summary {
            color: var(--gray-600);
            line-height: 1.8;
            margin-bottom: var(--space-lg);
            font-size: 1.125rem;
        }

        .what-we-analyzed {
            background: var(--gray-50);
            border-radius: var(--radius);
            padding: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .what-we-analyzed-title {
            font-weight: 600;
            margin-bottom: var(--space-sm);
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .what-we-analyzed-title i {
            color: var(--primary);
        }

        .what-we-analyzed-content {
            color: var(--gray-600);
            line-height: 1.6;
        }

        .trust-breakdown {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
        }

        .breakdown-item {
            background: var(--gray-50);
            border-radius: var(--radius);
            padding: var(--space-md);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .breakdown-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .breakdown-item:hover {
            background: white;
            box-shadow: var(--shadow-md);
        }

        .breakdown-item:hover::before {
            transform: scaleX(1);
        }

        .breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }

        .breakdown-label {
            font-weight: 600;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .breakdown-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .breakdown-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .breakdown-explanation {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-top: var(--space-xs);
        }

        .breakdown-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            margin-top: var(--space-sm);
            overflow: hidden;
            position: relative;
        }

        .breakdown-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease-out;
            position: relative;
            overflow: hidden;
        }

        .breakdown-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.3) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        .breakdown-positive { background: rgba(16, 185, 129, 0.1); }
        .breakdown-positive .breakdown-icon { background: rgba(16, 185, 129, 0.2); color: var(--accent); }
        .breakdown-positive .breakdown-fill { background: var(--gradient-success); }

        .breakdown-warning { background: rgba(245, 158, 11, 0.1); }
        .breakdown-warning .breakdown-icon { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .breakdown-warning .breakdown-fill { background: var(--gradient-warning); }

        .breakdown-negative { background: rgba(239, 68, 68, 0.1); }
        .breakdown-negative .breakdown-icon { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .breakdown-negative .breakdown-fill { background: var(--gradient-danger); }

        .breakdown-neutral { background: rgba(59, 130, 246, 0.1); }
        .breakdown-neutral .breakdown-icon { background: rgba(59, 130, 246, 0.2); color: var(--info); }
        .breakdown-neutral .breakdown-fill { background: var(--gradient-info); }

        .download-section {
            display: flex;
            gap: var(--space-sm);
        }

        .download-button {
            padding: var(--space-sm) var(--space-md);
            background: white;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius);
            color: var(--gray-700);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .download-button:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--gray-50);
        }

        /* Article Info Section */
        .article-info-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
            box-shadow: var(--shadow-md);
        }

        .article-header {
            margin-bottom: var(--space-lg);
        }

        .article-title {
            font-size: 1.875rem;
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: var(--space-md);
        }

        .article-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-lg);
            color: var(--gray-600);
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .meta-item i {
            color: var(--primary);
        }

        /* Key Findings */
        .key-findings {
            background: var(--gray-50);
            border-radius: var(--radius);
            padding: var(--space-lg);
            border-left: 4px solid var(--primary);
        }

        .key-findings-header {
            font-weight: 600;
            margin-bottom: var(--space-md);
            color: var(--primary);
        }

        .finding-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
            line-height: 1.6;
        }

        .finding-item i {
            margin-top: 0.25rem;
            flex-shrink: 0;
        }

        .finding-positive i { color: var(--accent); }
        .finding-warning i { color: var(--warning); }
        .finding-negative i { color: var(--danger); }

        /* Accordion Service Container */
        .services-accordion {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        /* Service Accordion Item - FIXED WITH COLORED BORDERS */
        .service-accordion-item {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            position: relative;
        }

        /* Different colored borders for each service */
        #service-source_credibility { border-color: #6366F1; }
        #service-author_analyzer { border-color: #10B981; }
        #service-bias_detector { border-color: #F59E0B; }
        #service-fact_checker { border-color: #3B82F6; }
        #service-transparency_analyzer { border-color: #8B5CF6; }
        #service-manipulation_detector { border-color: #EF4444; }
        #service-content_analyzer { border-color: #EC4899; }
        #service-plagiarism_detector { border-color: #14B8A6; }

        .service-accordion-item:hover {
            box-shadow: var(--shadow-lg);
        }

        .service-accordion-item.active {
            box-shadow: var(--shadow-xl);
        }

        /* FIXED: Prevent auto-scrolling on accordion click */
        .service-accordion-header {
            padding: var(--space-lg);
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
            background: white;
            position: relative;
        }

        .service-accordion-header:hover {
            background: var(--gray-50);
        }

        .service-accordion-item.active .service-accordion-header {
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }

        .service-header-content {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .service-icon-wrapper {
            width: 56px;
            height: 56px;
            background: var(--gradient-primary);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        /* Match icon wrapper colors to borders */
        #service-source_credibility .service-icon-wrapper { background: linear-gradient(135deg, #6366F1, #4F46E5); }
        #service-author_analyzer .service-icon-wrapper { background: linear-gradient(135deg, #10B981, #059669); }
        #service-bias_detector .service-icon-wrapper { background: linear-gradient(135deg, #F59E0B, #D97706); }
        #service-fact_checker .service-icon-wrapper { background: linear-gradient(135deg, #3B82F6, #2563EB); }
        #service-transparency_analyzer .service-icon-wrapper { background: linear-gradient(135deg, #8B5CF6, #7C3AED); }
        #service-manipulation_detector .service-icon-wrapper { background: linear-gradient(135deg, #EF4444, #DC2626); }
        #service-content_analyzer .service-icon-wrapper { background: linear-gradient(135deg, #EC4899, #DB2777); }
        #service-plagiarism_detector .service-icon-wrapper { background: linear-gradient(135deg, #14B8A6, #0D9488); }

        .service-accordion-item.active .service-icon-wrapper {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }

        .service-info {
            flex: 1;
        }

        .service-name {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: var(--gray-900);
        }

        .service-description {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: var(--space-sm);
        }

        .service-preview {
            display: flex;
            gap: var(--space-lg);
            align-items: center;
            margin-top: var(--space-sm);
        }

        .preview-item {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 0.875rem;
        }

        .preview-label {
            color: var(--gray-500);
        }

        .preview-value {
            font-weight: 600;
            color: var(--gray-900);
        }

        .service-expand-icon {
            position: absolute;
            right: var(--space-lg);
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.25rem;
            color: var(--gray-400);
            transition: all 0.3s ease;
        }

        .service-accordion-item.active .service-expand-icon {
            transform: translateY(-50%) rotate(180deg);
            color: var(--primary);
        }

        .pro-lock-badge {
            position: absolute;
            top: var(--space-md);
            right: calc(var(--space-lg) + 40px);
            background: var(--gradient-premium);
            color: var(--gray-900);
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .service-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: all 0.5s ease;
        }

        .service-accordion-item.active .service-accordion-content {
            max-height: 2000px;
        }

        .service-content-inner {
            padding: var(--space-xl);
            padding-top: 0;
        }

        /* Service Content Sections */
        .service-section {
            margin-bottom: var(--space-lg);
        }

        .service-section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: var(--space-sm);
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .section-title i {
            color: var(--primary);
            font-size: 0.875rem;
        }

        .service-results {
            background: var(--gray-50);
            border-radius: var(--radius);
            padding: var(--space-md);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 500;
            color: var(--gray-700);
        }

        .result-value {
            font-weight: 600;
            color: var(--gray-900);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-high { background: rgba(16, 185, 129, 0.1); color: var(--accent); }
        .status-medium { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .status-low { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            margin: var(--space-md) 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Dimension Bars */
        .dimension-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .dimension-item {
            background: white;
            padding: var(--space-md);
            border-radius: var(--radius);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
        }

        .dimension-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .dimension-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-xs);
        }

        .dimension-name {
            font-weight: 500;
            color: var(--gray-700);
        }

        .dimension-score {
            font-weight: 600;
            color: var(--gray-900);
        }

        .dimension-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .dimension-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease;
        }

        /* Claim List */
        .claims-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .claim-item {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: var(--space-md);
            transition: all 0.3s ease;
        }

        .claim-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .claim-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-sm);
        }

        .claim-text {
            flex: 1;
            font-weight: 500;
            color: var(--gray-900);
            line-height: 1.5;
        }

        .claim-status {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .claim-verified { background: rgba(16, 185, 129, 0.1); color: var(--accent); }
        .claim-unverified { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .claim-false { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        .claim-details {
            margin-top: var(--space-sm);
            padding-top: var(--space-sm);
            border-top: 1px solid var(--gray-100);
            font-size: 0.875rem;
            color: var(--gray-600);
            line-height: 1.6;
        }

        /* Technique List */
        .techniques-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-md);
        }

        .technique-card {
            background: var(--gray-50);
            border-radius: var(--radius);
            padding: var(--space-md);
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }

        .technique-card:hover {
            border-color: var(--primary);
            background: white;
            box-shadow: var(--shadow-sm);
        }

        .technique-name {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-xs);
        }

        .technique-description {
            font-size: 0.875rem;
            color: var(--gray-600);
            line-height: 1.5;
        }

        .technique-severity {
            display: inline-block;
            margin-top: var(--space-sm);
            padding: 0.125rem 0.5rem;
            background: var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .severity-high { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .severity-medium { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .severity-low { background: rgba(59, 130, 246, 0.1); color: var(--info); }

        /* Info Box */
        .info-box {
            background: var(--gray-50);
            border-radius: var(--radius);
            padding: var(--space-md);
            margin-top: var(--space-md);
            border-left: 4px solid var(--info);
        }

        .info-box-title {
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: var(--space-xs);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .info-box-title i {
            color: var(--info);
        }

        .info-box-content {
            color: var(--gray-600);
            line-height: 1.6;
        }

        /* Visualization Container */
        .service-visualization {
            margin: var(--space-lg) 0;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-50);
            border-radius: var(--radius);
            padding: var(--space-lg);
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2rem;
            }

            .trust-score-content {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .trust-gauge-container {
                margin: 0 auto;
            }

            .trust-breakdown {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                gap: var(--space-md);
            }

            .input-wrapper {
                flex-direction: column;
                padding: var(--space-md);
            }

            .analyze-button {
                width: 100%;
                justify-content: center;
            }

            .techniques-grid {
                grid-template-columns: 1fr;
            }

            .service-preview {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-sm);
            }
        }

        /* Error State */
        .error-message {
            background: #FEE2E2;
            border: 1px solid #FCA5A5;
            color: #991B1B;
            padding: var(--space-md);
            border-radius: var(--radius);
            margin-top: var(--space-md);
            display: none;
            animation: shake 0.5s ease;
            font-weight: 500;
            text-align: center;
        }

        .error-message.active {
            display: block;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-xl);
            color: var(--gray-500);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: var(--space-md);
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1.125rem;
            margin-bottom: var(--space-sm);
        }

        .empty-state-subtext {
            font-size: 0.875rem;
            color: var(--gray-400);
        }

        /* CRITICAL FIX: Ensure content is always visible */
        .card-content {
            display: block !important;
        }

        .analysis-card {
            display: block !important;
            opacity: 1 !important;
        }

        /* Data state indicator */
        .data-state-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10B981;
        }

        .data-state-indicator.no-data {
            background: #EF4444;
        }

        .data-state-indicator.partial-data {
            background: #F59E0B;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="logo-text">
                        <h1>TruthLens AI</h1>
                        <p>Professional News Verification</p>
                    </div>
                </div>
                <span class="pro-badge">PRO</span>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title">Advanced AI-Powered News Analysis</h1>
            <p class="hero-subtitle">
                Verify news articles with our comprehensive suite of 8 specialized AI services.
                Get detailed insights on credibility, bias, manipulation, and more.
            </p>

            <!-- Service Pills -->
            <div class="service-pills">
                <div class="service-pill">
                    <i class="fas fa-shield-alt"></i>
                    <span>Source Credibility</span>
                </div>
                <div class="service-pill">
                    <i class="fas fa-user-check"></i>
                    <span>Author Analysis</span>
                </div>
                <div class="service-pill">
                    <i class="fas fa-balance-scale"></i>
                    <span>Bias Detection</span>
                </div>
                <div class="service-pill">
                    <i class="fas fa-check-double"></i>
                    <span>Fact Checking</span>
                </div>
                <div class="service-pill">
                    <i class="fas fa-eye"></i>
                    <span>Transparency Analysis</span>
                </div>
                <div class="service-pill">
                    <i class="fas fa-mask"></i>
                    <span>Manipulation Detection</span>
                </div>
                <div class="service-pill">
                    <i class="fas fa-file-alt"></i>
                    <span>Content Analysis</span>
                </div>
                <div class="service-pill">
                    <i class="fas fa-copy"></i>
                    <span>Plagiarism Detection</span>
                </div>
            </div>

            <!-- Input Section -->
            <div class="input-container">
                <div class="input-wrapper">
                    <input 
                        type="url" 
                        id="urlInput" 
                        class="url-input" 
                        placeholder="Enter a news article URL to analyze..."
                        autocomplete="off"
                    >
                    <button id="analyzeBtn" class="analyze-button">
                        <i class="fas fa-search"></i>
                        Analyze Article
                    </button>
                </div>
                <div id="errorMessage" class="error-message"></div>
                
                <!-- Example URLs for testing -->
                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--gray-100); border-radius: var(--radius); text-align: center;">
                    <p style="color: var(--gray-700); font-size: 0.875rem; margin-bottom: 0.5rem;">
                        <strong>Note:</strong> Some sites like Washington Post block automated analysis. Try these instead:
                    </p>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-top: 0.5rem;">
                        <button class="example-btn" data-url="https://www.cnn.com" style="padding: 0.25rem 0.75rem; background: white; border: 1px solid var(--gray-300); border-radius: var(--radius-sm); font-size: 0.813rem; cursor: pointer; transition: all 0.2s;">CNN</button>
                        <button class="example-btn" data-url="https://www.bbc.com/news" style="padding: 0.25rem 0.75rem; background: white; border: 1px solid var(--gray-300); border-radius: var(--radius-sm); font-size: 0.813rem; cursor: pointer; transition: all 0.2s;">BBC News</button>
                        <button class="example-btn" data-url="https://www.reuters.com" style="padding: 0.25rem 0.75rem; background: white; border: 1px solid var(--gray-300); border-radius: var(--radius-sm); font-size: 0.813rem; cursor: pointer; transition: all 0.2s;">Reuters</button>
                        <button class="example-btn" data-url="https://www.npr.org" style="padding: 0.25rem 0.75rem; background: white; border: 1px solid var(--gray-300); border-radius: var(--radius-sm); font-size: 0.813rem; cursor: pointer; transition: all 0.2s;">NPR</button>
                        <button class="example-btn" data-url="https://www.theguardian.com" style="padding: 0.25rem 0.75rem; background: white; border: 1px solid var(--gray-300); border-radius: var(--radius-sm); font-size: 0.813rem; cursor: pointer; transition: all 0.2s;">The Guardian</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Results Section -->
        <div id="resultsSection" class="results-section">
            <!-- Enhanced Trust Score Section -->
            <div class="trust-score-section">
                <div class="trust-score-header">
                    <div>
                        <h2>Overall Trust Score Analysis</h2>
                    </div>
                    <div class="download-section">
                        <button class="download-button" id="downloadPdfBtn">
                            <i class="fas fa-file-pdf"></i>
                            Download Report
                        </button>
                        <button class="download-button" id="shareResultsBtn">
                            <i class="fas fa-share-alt"></i>
                            Share
                        </button>
                    </div>
                </div>
                <div class="trust-score-content">
                    <div class="trust-gauge-container">
                        <div class="trust-gauge-visual">
                            <canvas id="trustGauge"></canvas>
                            <div class="trust-score-value">
                                <span id="trustScoreNumber" class="trust-score-number">0</span>
                                <span class="trust-score-label">out of 100</span>
                            </div>
                        </div>
                        <div id="trustLevelIndicator" class="trust-level-indicator">
                            <i id="trustLevelIcon" class="fas fa-circle trust-level-icon"></i>
                            <span id="trustLevelText" class="trust-level-text">Analyzing...</span>
                        </div>
                    </div>
                    <div class="trust-score-details">
                        <h2>What This Score Means</h2>
                        <p id="trustSummary" class="trust-summary"></p>
                        
                        <div class="what-we-analyzed">
                            <div class="what-we-analyzed-title">
                                <i class="fas fa-search"></i>
                                What We Analyzed
                            </div>
                            <div class="what-we-analyzed-content">
                                We examined 8 critical dimensions of this article including the credibility of the source and author, 
                                potential biases, factual accuracy, transparency of information, manipulation techniques, 
                                content quality, and originality. Each component contributes to the overall trust score.
                            </div>
                        </div>

                        <div id="trustBreakdown" class="trust-breakdown"></div>
                    </div>
                </div>
            </div>

            <!-- Article Info Section -->
            <div class="article-info-section">
                <div class="article-header">
                    <h3 id="articleTitle" class="article-title"></h3>
                    <div id="articleMeta" class="article-meta"></div>
                </div>
                <div id="keyFindings" class="key-findings"></div>
            </div>

            <!-- Services Accordion -->
            <div id="servicesAccordion" class="services-accordion"></div>
        </div>
    </main>

    <script>
        // Global state
        let currentAnalysis = null;
        let isAnalyzing = false;
        let charts = {};
        let isPro = true; // For development, keep pro features open

        // Service definitions
        const services = [
            {
                id: 'source_credibility',
                name: 'Source Credibility',
                icon: 'fa-shield-alt',
                description: 'Evaluates the reliability and trustworthiness of the news source',
                isPro: false
            },
            {
                id: 'author_analyzer',
                name: 'Author Analysis',
                icon: 'fa-user-check',
                description: 'Analyzes author credentials and publishing history',
                isPro: false
            },
            {
                id: 'bias_detector',
                name: 'Bias Detection',
                icon: 'fa-balance-scale',
                description: 'Identifies political, ideological, and narrative biases',
                isPro: true
            },
            {
                id: 'fact_checker',
                name: 'Fact Verification',
                icon: 'fa-check-double',
                description: 'Verifies claims against trusted fact-checking databases',
                isPro: true
            },
            {
                id: 'transparency_analyzer',
                name: 'Transparency Analysis',
                icon: 'fa-eye',
                description: 'Evaluates source disclosure and funding transparency',
                isPro: true
            },
            {
                id: 'manipulation_detector',
                name: 'Manipulation Detection',
                icon: 'fa-mask',
                description: 'Detects emotional manipulation and propaganda techniques',
                isPro: true
            },
            {
                id: 'content_analyzer',
                name: 'Content Analysis',
                icon: 'fa-file-alt',
                description: 'Analyzes writing quality, structure, and coherence',
                isPro: true
            },
            {
                id: 'plagiarism_detector',
                name: 'Plagiarism Check',
                icon: 'fa-copy',
                description: 'Checks for copied content and proper attribution',
                isPro: true
            }
        ];

        // CRITICAL FIX: Enhanced Data structure mapper to handle backend inconsistencies
        class DataStructureMapper {
            static mapServiceData(rawData) {
                console.log('=== DataStructureMapper.mapServiceData called ===');
                
                if (!rawData || typeof rawData !== 'object') {
                    console.error('Invalid rawData provided to mapServiceData');
                    return {};
                }
                
                console.log('Raw data keys:', Object.keys(rawData));
                
                // Create a normalized structure
                const mapped = {};
                
                // Map each service with fallback field names
                const serviceMappings = {
                    'source_credibility': ['source_credibility', 'sourceCredibility', 'source_analysis'],
                    'author_analyzer': ['author_analyzer', 'author_analysis', 'author_info', 'authorAnalysis'],
                    'bias_detector': ['bias_detector', 'bias_analysis', 'bias', 'biasDetection'],
                    'fact_checker': ['fact_checker', 'fact_checks', 'fact_checking', 'factChecker'],
                    'transparency_analyzer': ['transparency_analyzer', 'transparency_analysis', 'transparency'],
                    'manipulation_detector': ['manipulation_detector', 'manipulation_analysis', 'persuasion_analysis'],
                    'content_analyzer': ['content_analyzer', 'content_analysis', 'content', 'contentAnalysis'],
                    'plagiarism_detector': ['plagiarism_detector', 'plagiarism_analysis', 'plagiarism']
                };
                
                // Try to find data for each service
                Object.entries(serviceMappings).forEach(([serviceId, possibleNames]) => {
                    for (const name of possibleNames) {
                        if (rawData[name] !== undefined && rawData[name] !== null) {
                            mapped[serviceId] = this.extractServiceData(rawData[name]);
                            console.log(`Mapped ${name} to ${serviceId}`);
                            break;
                        }
                    }
                    
                    // If still not found, create empty structure
                    if (!mapped[serviceId]) {
                        mapped[serviceId] = {};
                        console.log(`No data found for ${serviceId}`);
                    }
                });
                
                return mapped;
            }
            
            static extractServiceData(serviceResult) {
                // Handle null/undefined
                if (!serviceResult) return {};
                
                // If the service result has a 'data' field, extract it
                if (serviceResult && typeof serviceResult === 'object') {
                    if (serviceResult.data && typeof serviceResult.data === 'object') {
                        return serviceResult.data;
                    }
                    // If success is false, return empty object
                    if (serviceResult.success === false) {
                        return {};
                    }
                    // Otherwise return the whole object
                    return serviceResult;
                }
                return {};
            }
            
            static normalizeFactCheckerData(data) {
                // Handle null/undefined
                if (!data) return { claims_checked: 0, verified_count: 0, claims: [] };
                
                const normalized = {
                    claims_checked: 0,
                    verified_count: 0,
                    claims: []
                };
                
                // Extract claims count - check multiple possible fields
                normalized.claims_checked = data.claims_checked || 
                                          data.total_claims || 
                                          data.totalClaims ||
                                          data.claims?.length || 
                                          0;
                
                // Extract verified count
                normalized.verified_count = data.verified_count || 
                                          data.verified_claims || 
                                          data.verifiedClaims ||
                                          data.verified || 
                                          0;
                
                // Extract claims array
                if (data.claims && Array.isArray(data.claims)) {
                    normalized.claims = data.claims;
                } else if (data.results && Array.isArray(data.results)) {
                    normalized.claims = data.results;
                } else if (data.fact_checks && Array.isArray(data.fact_checks)) {
                    normalized.claims = data.fact_checks;
                } else if (Array.isArray(data)) {
                    normalized.claims = data;
                }
                
                // Ensure claims have required structure
                normalized.claims = normalized.claims.map(claim => {
                    if (typeof claim === 'string') {
                        return { claim: claim, verdict: 'unverified' };
                    }
                    return claim;
                });
                
                return normalized;
            }
        }

        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing TruthLens...');
            
            // Add event listener for URL input Enter key
            const urlInput = document.getElementById('urlInput');
            if (urlInput) {
                console.log('URL input found');
                urlInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        console.log('Enter key pressed');
                        analyzeArticle();
                    }
                });
            } else {
                console.error('URL input not found!');
            }
            
            // Add click handler for analyze button
            const analyzeBtn = document.getElementById('analyzeBtn');
            if (analyzeBtn) {
                console.log('Analyze button found, adding click handler');
                analyzeBtn.addEventListener('click', function() {
                    console.log('Analyze button clicked');
                    analyzeArticle();
                });
            } else {
                console.error('Analyze button not found!');
            }
            
            // Add click handlers for example buttons
            document.querySelectorAll('.example-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    tryExample(this.getAttribute('data-url'));
                });
            });
            
            // Add click handlers for download and share buttons
            const downloadBtn = document.getElementById('downloadPdfBtn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', downloadPDF);
            }
            
            const shareBtn = document.getElementById('shareResultsBtn');
            if (shareBtn) {
                shareBtn.addEventListener('click', shareResults);
            }
        });

        // Try example URL
        function tryExample(url) {
            document.getElementById('urlInput').value = url;
            document.getElementById('urlInput').focus();
        }

        // Performance monitoring
        function measurePerformance(operationName, operation) {
            const startTime = performance.now();
            console.log(`[PERF] Starting ${operationName}`);
            
            try {
                const result = operation();
                const duration = performance.now() - startTime;
                console.log(`[PERF] ${operationName} completed in ${duration.toFixed(2)}ms`);
                return result;
            } catch (error) {
                const duration = performance.now() - startTime;
                console.error(`[PERF] ${operationName} failed after ${duration.toFixed(2)}ms`, error);
                throw error;
            }
        }

        // Validate API response structure
        function validateApiResponse(response) {
            const required = ['analysis', 'article'];
            const missing = [];
            
            for (const field of required) {
                if (!response[field]) {
                    missing.push(field);
                }
            }
            
            if (missing.length > 0) {
                console.error('Missing required fields in API response:', missing);
                console.error('Response structure:', Object.keys(response));
                
                // Try to recover from common response structures
                if (response.data) {
                    return validateApiResponse(response.data);
                }
                
                if (response.result) {
                    return validateApiResponse(response.result);
                }
                
                throw new Error(`Invalid API response: missing ${missing.join(', ')}`);
            }
            
            // Validate analysis structure
            if (!response.analysis.trust_score && response.analysis.trust_score !== 0) {
                console.warn('Missing trust_score in analysis');
                response.analysis.trust_score = 0;
            }
            
            if (!response.analysis.trust_level) {
                response.analysis.trust_level = 'Unknown';
            }
            
            return response;
        }

        // Retry mechanism for API calls
        async function analyzeArticleWithRetry(url, maxRetries = 2) {
            let lastError;
            
            for (let attempt = 0; attempt <= maxRetries; attempt++) {
                try {
                    if (attempt > 0) {
                        console.log(`Retry attempt ${attempt} of ${maxRetries}`);
                        // Wait before retry (exponential backoff)
                        await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempt - 1)));
                    }
                    
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ url: url })
                    });
                    
                    if (response.ok) {
                        return await response.json();
                    }
                    
                    // Don't retry on client errors (4xx)
                    if (response.status >= 400 && response.status < 500) {
                        const error = await response.json();
                        throw new Error(error.error || error.message || `HTTP ${response.status}`);
                    }
                    
                    lastError = new Error(`HTTP ${response.status}`);
                    
                } catch (error) {
                    lastError = error;
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                }
            }
            
            throw lastError;
        }

        // Main analysis function - FIXED with comprehensive data handling
        async function analyzeArticle() {
            console.log('analyzeArticle function called');
            
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();
            console.log('URL to analyze:', url);
            
            if (!url) {
                console.log('No URL provided');
                showError('Please enter a URL');
                return;
            }
            
            if (!isValidUrl(url)) {
                console.log('Invalid URL format');
                showError('Please enter a valid URL');
                return;
            }
            
            if (isAnalyzing) {
                console.log('Already analyzing');
                return;
            }
            
            isAnalyzing = true;
            hideError();
            hideResults();
            showLoading();
            
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            
            console.log('Starting API call to /api/analyze');
            
            try {
                // Use retry mechanism
                const responseData = await measurePerformance('API Call', async () => {
                    return await analyzeArticleWithRetry(url);
                });
                
                console.log('=== COMPREHENSIVE API RESPONSE DEBUG ===');
                console.log('Raw API response:', responseData);
                console.log('Response type:', typeof responseData);
                console.log('Response keys:', Object.keys(responseData));
                
                // Validate and normalize response
                let data = validateApiResponse(responseData);
                
                // CRITICAL: Log the complete data structure
                console.log('=== COMPLETE DATA STRUCTURE ===');
                console.log(JSON.stringify(data, null, 2));
                
                // CRITICAL FIX: Normalize the service data
                if (data.detailed_analysis) {
                    console.log('=== BEFORE NORMALIZATION ===');
                    console.log('detailed_analysis keys:', Object.keys(data.detailed_analysis));
                    
                    // Apply data structure mapping
                    data.detailed_analysis = DataStructureMapper.mapServiceData(data.detailed_analysis);
                    
                    console.log('=== AFTER NORMALIZATION ===');
                    console.log('detailed_analysis keys:', Object.keys(data.detailed_analysis));
                }
                
                currentAnalysis = data;
                displayResults(data);
                
            } catch (error) {
                console.error('Analysis error:', error);
                showError(error.message || 'Failed to analyze article. Please try again.');
            } finally {
                isAnalyzing = false;
                hideLoading();
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="fas fa-search"></i> Analyze Article';
            }
        }

        // Display results with enhanced trust score section
        function displayResults(data) {
            console.log('displayResults called with:', data);
            
            if (!data) {
                console.error('No data provided to displayResults');
                showError('No analysis data received');
                return;
            }
            
            // CRITICAL FIX: Ensure we have the required structure
            if (!data.analysis && !data.article) {
                // Check if data is nested
                if (data.data) {
                    data = data.data;
                } else if (data.result) {
                    data = data.result;
                } else {
                    console.error('Invalid data structure - missing analysis and article');
                    showError('Invalid response format from server');
                    return;
                }
            }
            
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.add('active');
            
            // Display each component with individual error handling
            try {
                displayEnhancedTrustScore(data.analysis, data);
            } catch (e) {
                console.error('Error displaying trust score:', e);
                // Show partial results even if trust score fails
                document.getElementById('trustScoreNumber').textContent = '?';
                document.getElementById('trustSummary').textContent = 'Trust score calculation failed';
            }
            
            try {
                displayArticleInfo(data.article, data.analysis);
            } catch (e) {
                console.error('Error displaying article info:', e);
            }
            
            try {
                displayServiceAccordion(data);
            } catch (e) {
                console.error('Error displaying service accordion:', e);
            }
            
            // Scroll to results smoothly without triggering accordion auto-scroll
            setTimeout(() => {
                resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // Enhanced trust score display with explanations
        function displayEnhancedTrustScore(analysis, fullData) {
            console.log('=== displayEnhancedTrustScore called ===');
            console.log('analysis:', analysis);
            console.log('fullData:', fullData);
            
            if (!analysis) {
                console.error('No analysis data provided to displayEnhancedTrustScore');
                return;
            }
            
            const score = analysis.trust_score || 0;
            const level = analysis.trust_level || 'Unknown';
            
            // Update score number with animation
            animateTrustScore(score);
            
            // Update level indicator
            updateTrustLevelIndicator(score, level);
            
            // Update summary with contextual explanation
            const summaryEl = document.getElementById('trustSummary');
            summaryEl.textContent = getTrustSummaryExplanation(score, level, analysis);
            
            // CRITICAL FIX: Use normalized data
            const servicesData = fullData.detailed_analysis || {};
            
            console.log('Services data for trust breakdown:', servicesData);
            
            // Create detailed breakdown with explanations
            const breakdownData = [
                {
                    id: 'source_credibility',
                    icon: 'fa-shield-alt',
                    label: 'Source Credibility',
                    value: extractScore(servicesData.source_credibility, ['credibility_score', 'score']),
                    explanation: getSourceCredibilityExplanation(servicesData.source_credibility)
                },
                {
                    id: 'author_credibility',
                    icon: 'fa-user-check',
                    label: 'Author Credibility',
                    value: extractScore(servicesData.author_analyzer, ['credibility_score', 'score']),
                    explanation: getAuthorCredibilityExplanation(servicesData.author_analyzer)
                },
                {
                    id: 'objectivity',
                    icon: 'fa-balance-scale',
                    label: 'Objectivity Score',
                    value: 100 - extractScore(servicesData.bias_detector, ['overall_bias_score', 'bias_score'], 0),
                    explanation: getObjectivityExplanation(servicesData.bias_detector)
                },
                {
                    id: 'fact_accuracy',
                    icon: 'fa-check-double',
                    label: 'Fact Accuracy',
                    value: calculateFactAccuracy(servicesData.fact_checker),
                    explanation: getFactAccuracyExplanation(servicesData.fact_checker)
                }
            ];
            
            console.log('Breakdown data:', breakdownData);
            
            let breakdownHtml = '';
            breakdownData.forEach(item => {
                const type = getBreakdownType(item.value);
                breakdownHtml += `
                    <div class="breakdown-item breakdown-${type}">
                        <div class="breakdown-header">
                            <div class="breakdown-label">
                                <div class="breakdown-icon">
                                    <i class="fas ${item.icon}"></i>
                                </div>
                                <span>${item.label}</span>
                            </div>
                            <div class="breakdown-value">${item.value}%</div>
                        </div>
                        <div class="breakdown-explanation">${item.explanation}</div>
                        <div class="breakdown-bar">
                            <div class="breakdown-fill" style="width: 0%;" data-target="${item.value}"></div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('trustBreakdown').innerHTML = breakdownHtml;
            
            // Animate breakdown bars after DOM update
            setTimeout(() => {
                document.querySelectorAll('.breakdown-fill').forEach(bar => {
                    const target = bar.getAttribute('data-target');
                    bar.style.width = target + '%';
                });
            }, 100);
            
            // Create enhanced gauge chart
            createEnhancedTrustGauge(score);
        }

        // Helper function to extract score from nested data
        function extractScore(data, fields, defaultValue = 0) {
            if (!data || typeof data !== 'object') return defaultValue;
            
            for (const field of fields) {
                // Handle nested fields (e.g., "score.value")
                const fieldParts = field.split('.');
                let value = data;
                
                for (const part of fieldParts) {
                    if (value && typeof value === 'object' && part in value) {
                        value = value[part];
                    } else {
                        value = undefined;
                        break;
                    }
                }
                
                if (value !== undefined && value !== null) {
                    const numValue = Number(value);
                    if (!isNaN(numValue)) {
                        return numValue;
                    }
                }
            }
            
            return defaultValue;
        }

        // Get contextual trust summary explanation
        function getTrustSummaryExplanation(score, level, analysis) {
            if (score >= 80) {
                return "This article demonstrates high credibility across all dimensions. The source is well-established, the author has verified credentials, minimal bias was detected, and factual claims have been verified. You can generally trust the information presented.";
            } else if (score >= 60) {
                return "This article shows moderate credibility. While some trust indicators are positive, there are areas of concern such as limited source transparency, some detected bias, or unverified claims. Read with a critical eye and cross-reference important information.";
            } else if (score >= 40) {
                return "This article has low credibility. Significant issues were found including questionable source reliability, strong bias indicators, or multiple unverified claims. Be cautious about accepting information at face value and seek additional sources.";
            } else {
                return "This article shows very low credibility. Major red flags include unverifiable sources, extreme bias, false claims, or manipulation techniques. The information presented should not be trusted without extensive verification from reliable sources.";
            }
        }

        // Get explanation for source credibility
        function getSourceCredibilityExplanation(data) {
            if (!data || Object.keys(data).length === 0) return "Unable to verify source credibility";
            
            const score = extractScore(data, ['credibility_score', 'score']);
            const sourceName = data.source_name || data.name || "Unknown source";
            
            if (score >= 80) {
                return `${sourceName} is an established, reputable news source with strong editorial standards and fact-checking processes.`;
            } else if (score >= 60) {
                return `${sourceName} is a moderately credible source with some concerns about consistency or transparency.`;
            } else if (score >= 40) {
                return `${sourceName} has questionable credibility with known issues in reporting accuracy or bias.`;
            } else if (score > 0) {
                return `${sourceName} is not a reliable news source and has a poor track record for accuracy.`;
            } else {
                return "Source could not be verified or is not in our database of known news sources.";
            }
        }

        // Get explanation for author credibility
        function getAuthorCredibilityExplanation(data) {
            if (!data || Object.keys(data).length === 0) return "Author information not available";
            
            const score = extractScore(data, ['credibility_score', 'score']);
            const authorName = data.author_name || data.name || "Unknown author";
            
            if (score >= 80) {
                return `${authorName} is a verified journalist with established credentials and expertise in this topic area.`;
            } else if (score >= 60) {
                return `${authorName} has some journalistic experience but limited verification or expertise in this specific area.`;
            } else if (score >= 40) {
                return `Limited information available about ${authorName}'s credentials or journalistic background.`;
            } else if (score > 0) {
                return `${authorName} has no verifiable journalistic credentials or has credibility concerns.`;
            } else {
                return "No author information provided or author could not be verified.";
            }
        }

        // Get explanation for objectivity
        function getObjectivityExplanation(data) {
            if (!data || Object.keys(data).length === 0) return "Bias analysis not available";
            
            const biasScore = extractScore(data, ['overall_bias_score', 'bias_score'], 0);
            const objectivityScore = 100 - biasScore;
            
            if (objectivityScore >= 80) {
                return "Minimal bias detected. The article presents information objectively with balanced viewpoints.";
            } else if (objectivityScore >= 60) {
                return "Some bias detected in language or framing, but generally maintains journalistic standards.";
            } else if (objectivityScore >= 40) {
                return "Significant bias present through selective facts, loaded language, or one-sided arguments.";
            } else {
                return "Extreme bias detected. The article heavily favors one perspective without balance.";
            }
        }

        // Get explanation for fact accuracy
        function getFactAccuracyExplanation(factCheckerData) {
            console.log('getFactAccuracyExplanation called with:', factCheckerData);
            
            if (!factCheckerData || Object.keys(factCheckerData).length === 0) return "Fact checking not performed";
            
            // Normalize the data
            const normalized = DataStructureMapper.normalizeFactCheckerData(factCheckerData);
            const { claims_checked: total, verified_count: verified } = normalized;
            
            if (total === 0) {
                return "No factual claims found to verify in this article.";
            }
            
            const accuracy = Math.round((verified / total) * 100);
            
            if (accuracy >= 80) {
                return `${verified} of ${total} factual claims verified as accurate through trusted fact-checking sources.`;
            } else if (accuracy >= 60) {
                return `${verified} of ${total} claims verified. Some claims could not be confirmed or contain inaccuracies.`;
            } else if (accuracy >= 40) {
                return `Only ${verified} of ${total} claims could be verified. Multiple unverified or disputed claims present.`;
            } else {
                return `Major factual issues: only ${verified} of ${total} claims are accurate. Contains false or misleading information.`;
            }
        }

        // Calculate fact accuracy percentage
        function calculateFactAccuracy(factCheckerData) {
            console.log('calculateFactAccuracy called with:', factCheckerData);
            
            if (!factCheckerData || Object.keys(factCheckerData).length === 0) return 0;
            
            const normalized = DataStructureMapper.normalizeFactCheckerData(factCheckerData);
            const { claims_checked: total, verified_count: verified } = normalized;
            
            if (total === 0) return 0;
            return Math.round((verified / total) * 100);
        }

        // Animate trust score number
        function animateTrustScore(targetScore) {
            const scoreEl = document.getElementById('trustScoreNumber');
            let currentScore = 0;
            const increment = targetScore / 50;
            const interval = setInterval(() => {
                currentScore += increment;
                if (currentScore >= targetScore) {
                    currentScore = targetScore;
                    clearInterval(interval);
                }
                scoreEl.textContent = Math.round(currentScore);
                scoreEl.style.color = getScoreColor(currentScore);
            }, 20);
        }

        // Update trust level indicator
        function updateTrustLevelIndicator(score, level) {
            const iconEl = document.getElementById('trustLevelIcon');
            const textEl = document.getElementById('trustLevelText');
            const indicatorEl = document.getElementById('trustLevelIndicator');
            
            // Set text
            textEl.textContent = level;
            
            // Set color and icon based on score
            if (score >= 80) {
                iconEl.className = 'fas fa-check-circle trust-level-icon';
                iconEl.style.color = 'var(--accent)';
                indicatorEl.style.background = 'rgba(16, 185, 129, 0.1)';
                indicatorEl.style.border = '2px solid var(--accent)';
            } else if (score >= 60) {
                iconEl.className = 'fas fa-exclamation-circle trust-level-icon';
                iconEl.style.color = 'var(--info)';
                indicatorEl.style.background = 'rgba(59, 130, 246, 0.1)';
                indicatorEl.style.border = '2px solid var(--info)';
            } else if (score >= 40) {
                iconEl.className = 'fas fa-exclamation-triangle trust-level-icon';
                iconEl.style.color = 'var(--warning)';
                indicatorEl.style.background = 'rgba(245, 158, 11, 0.1)';
                indicatorEl.style.border = '2px solid var(--warning)';
            } else {
                iconEl.className = 'fas fa-times-circle trust-level-icon';
                iconEl.style.color = 'var(--danger)';
                indicatorEl.style.background = 'rgba(239, 68, 68, 0.1)';
                indicatorEl.style.border = '2px solid var(--danger)';
            }
        }

        // Create enhanced trust gauge
        function createEnhancedTrustGauge(score) {
            const ctx = document.getElementById('trustGauge').getContext('2d');
            
            if (charts.trustGauge) {
                charts.trustGauge.destroy();
            }
            
            // Create gradient based on score
            const gradient = ctx.createLinearGradient(0, 0, 300, 0);
            if (score >= 80) {
                gradient.addColorStop(0, '#10b981');
                gradient.addColorStop(1, '#059669');
            } else if (score >= 60) {
                gradient.addColorStop(0, '#3b82f6');
                gradient.addColorStop(1, '#2563eb');
            } else if (score >= 40) {
                gradient.addColorStop(0, '#f59e0b');
                gradient.addColorStop(1, '#d97706');
            } else {
                gradient.addColorStop(0, '#ef4444');
                gradient.addColorStop(1, '#dc2626');
            }
            
            charts.trustGauge = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [score, 100 - score],
                        backgroundColor: [gradient, '#E5E7EB'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    circumference: 180,
                    rotation: -90,
                    cutout: '85%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        }

        // Get breakdown type based on score
        function getBreakdownType(score) {
            if (score >= 80) return 'positive';
            if (score >= 60) return 'neutral';
            if (score >= 40) return 'warning';
            return 'negative';
        }

        // Display article info
        function displayArticleInfo(article, analysis) {
            document.getElementById('articleTitle').textContent = article?.title || 'Untitled Article';
            
            const metaHtml = `
                <div class="meta-item">
                    <i class="fas fa-user"></i>
                    <span>${article?.author || 'Unknown Author'}</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-globe"></i>
                    <span>${article?.domain || 'Unknown Source'}</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-calendar"></i>
                    <span>${formatDate(article?.publish_date)}</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-clock"></i>
                    <span>${Math.ceil((article?.word_count || 0) / 200)} min read</span>
                </div>
            `;
            document.getElementById('articleMeta').innerHTML = metaHtml;
            
            // Display key findings
            const findings = analysis?.key_findings || [];
            
            if (findings.length > 0) {
                let findingsHtml = '<h4 class="key-findings-header">Key Findings</h4>';
                findings.forEach(finding => {
                    const type = finding.severity === 'positive' ? 'positive' : 
                               finding.severity === 'high' ? 'negative' : 'warning';
                    const icon = type === 'positive' ? 'fa-check-circle' : 
                               type === 'negative' ? 'fa-times-circle' : 'fa-exclamation-circle';
                    
                    findingsHtml += `
                        <div class="finding-item finding-${type}">
                            <i class="fas ${icon}"></i>
                            <span>${escapeHtml(finding.text || finding.finding)}</span>
                        </div>
                    `;
                });
                document.getElementById('keyFindings').innerHTML = findingsHtml;
            } else {
                document.getElementById('keyFindings').innerHTML = `
                    <div class="info-box">
                        <div class="info-box-title">
                            <i class="fas fa-info-circle"></i>
                            Analysis Summary
                        </div>
                        <div class="info-box-content">
                            The detailed analysis of this article is complete. Review the individual service results below for specific insights about credibility, bias, factual accuracy, and more.
                        </div>
                    </div>
                `;
            }
        }

        // Display service accordion - FIXED with proper data mapping
        function displayServiceAccordion(data) {
            console.log('=== displayServiceAccordion called ===');
            console.log('data structure:', data);
            
            const container = document.getElementById('servicesAccordion');
            container.innerHTML = '';
            
            // Use normalized data
            const servicesData = data.detailed_analysis || {};
            
            console.log('Using servicesData:', servicesData);
            
            services.forEach((service, index) => {
                const serviceData = servicesData[service.id] || {};
                
                console.log(`Creating accordion for ${service.id} with data:`, serviceData);
                
                const accordionItem = createServiceAccordionItem(service, serviceData, index);
                container.appendChild(accordionItem);
            });
        }

        // Create service accordion item
        function createServiceAccordionItem(service, serviceData, index) {
            const item = document.createElement('div');
            item.className = 'service-accordion-item';
            item.id = `service-${service.id}`;
            
            // Add data state indicator
            const hasData = serviceData && Object.keys(serviceData).length > 0;
            const dataStateClass = hasData ? '' : 'no-data';
            
            // Extract preview data
            const previewData = getServicePreviewData(service.id, serviceData);
            
            item.innerHTML = `
                <div class="service-accordion-header" onclick="toggleAccordion('${service.id}', event)">
                    <div class="data-state-indicator ${dataStateClass}"></div>
                    <div class="service-header-content">
                        <div class="service-icon-wrapper">
                            <i class="fas ${service.icon}"></i>
                        </div>
                        <div class="service-info">
                            <h3 class="service-name">${service.name}</h3>
                            <p class="service-description">${service.description}</p>
                            <div class="service-preview">
                                ${previewData.map(preview => `
                                    <div class="preview-item">
                                        <span class="preview-label">${preview.label}:</span>
                                        <span class="preview-value" style="color: ${preview.color || 'inherit'}">
                                            ${preview.value}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    ${service.isPro && !isPro ? '<div class="pro-lock-badge"><i class="fas fa-lock"></i> PRO</div>' : ''}
                    <i class="fas fa-chevron-down service-expand-icon"></i>
                </div>
                <div class="service-accordion-content">
                    <div class="service-content-inner">
                        ${renderServiceContent(service, serviceData)}
                    </div>
                </div>
            `;
            
            return item;
        }

        // Get service preview data - FIXED with proper data extraction
        function getServicePreviewData(serviceId, data) {
            const hasData = data && Object.keys(data).length > 0;
            
            if (!hasData) {
                return [{ label: 'Status', value: 'No data available', color: '#6B7280' }];
            }
            
            switch (serviceId) {
                case 'source_credibility':
                    const sourceScore = extractScore(data, ['credibility_score', 'score']);
                    const sourceLevel = data.level || data.credibility_level || getCredibilityLevel(sourceScore);
                    return [
                        { label: 'Score', value: `${sourceScore}/100`, color: getScoreColor(sourceScore) },
                        { label: 'Level', value: sourceLevel }
                    ];
                    
                case 'author_analyzer':
                    const authorScore = extractScore(data, ['credibility_score', 'score']);
                    const verificationStatus = data.verification_status?.verified || 
                                            (authorScore > 0 ? 'Analyzed' : 'Unverified');
                    return [
                        { label: 'Score', value: `${authorScore}/100`, color: getScoreColor(authorScore) },
                        { label: 'Status', value: verificationStatus }
                    ];
                    
                case 'bias_detector':
                    const biasScore = extractScore(data, ['overall_bias_score', 'bias_score'], 0);
                    const biasLevel = data.bias_level || getBiasLevel(biasScore);
                    return [
                        { label: 'Bias Level', value: biasLevel },
                        { label: 'Objectivity', value: `${100 - biasScore}%`, color: getScoreColor(100 - biasScore) }
                    ];
                    
                case 'fact_checker':
                    const normalized = DataStructureMapper.normalizeFactCheckerData(data);
                    const accuracy = normalized.claims_checked > 0 ? 
                        Math.round((normalized.verified_count / normalized.claims_checked) * 100) : 0;
                    return [
                        { label: 'Claims Checked', value: normalized.claims_checked },
                        { label: 'Accuracy', value: `${accuracy}%`, color: getScoreColor(accuracy) }
                    ];
                    
                case 'transparency_analyzer':
                    const transparencyScore = extractScore(data, ['transparency_score', 'score'], 0);
                    const transparencyLevel = data.transparency_level || getTransparencyLevel(transparencyScore);
                    return [
                        { label: 'Score', value: `${transparencyScore}%`, color: getScoreColor(transparencyScore) },
                        { label: 'Level', value: transparencyLevel }
                    ];
                    
                case 'manipulation_detector':
                    const manipLevel = data.manipulation_level || data.level || 'Unknown';
                    const techniquesCount = data.techniques_count || 
                                          (data.techniques ? data.techniques.length : 0);
                    return [
                        { label: 'Risk Level', value: manipLevel },
                        { label: 'Techniques', value: techniquesCount }
                    ];
                    
                case 'content_analyzer':
                    const qualityScore = extractScore(data, ['quality_score', 'score'], 0);
                    const readabilityLevel = data.readability?.level || 
                                           data.readability_level || 
                                           'Not analyzed';
                    return [
                        { label: 'Quality', value: `${qualityScore}/100`, color: getScoreColor(qualityScore) },
                        { label: 'Readability', value: readabilityLevel }
                    ];
                    
                case 'plagiarism_detector':
                    const originalityScore = data.originality_score !== undefined ? 
                        data.originality_score : 
                        (100 - (data.similarity_score || 0));
                    return [
                        { label: 'Originality', value: `${originalityScore}%`, color: getScoreColor(originalityScore) },
                        { label: 'Status', value: originalityScore >= 80 ? 'Original' : 'Issues Found' }
                    ];
                    
                default:
                    return [{ label: 'Status', value: 'Analysis Complete' }];
            }
        }

        // Toggle accordion - FIXED to prevent auto-scrolling
        function toggleAccordion(serviceId, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // Save current scroll position
            const currentScrollY = window.scrollY;
            
            const item = document.getElementById(`service-${serviceId}`);
            const isActive = item.classList.contains('active');
            
            // Close all other items
            document.querySelectorAll('.service-accordion-item').forEach(el => {
                if (el.id !== `service-${serviceId}`) {
                    el.classList.remove('active');
                }
            });
            
            // Toggle current item
            item.classList.toggle('active');
            
            // Restore scroll position
            window.scrollTo(0, currentScrollY);
            
            // If opening, create/update visualizations after animation
            if (!isActive) {
                setTimeout(() => {
                    updateServiceVisualizations(serviceId);
                }, 300);
            }
        }

        // Update service visualizations
        function updateServiceVisualizations(serviceId) {
            const serviceData = currentAnalysis?.detailed_analysis?.[serviceId] || {};
            if (!serviceData || Object.keys(serviceData).length === 0) return;
            
            // Find all canvases in this service section
            const canvases = document.querySelectorAll(`#service-${serviceId} canvas`);
            canvases.forEach(canvas => {
                const chartType = canvas.getAttribute('data-chart-type');
                const chartData = canvas.getAttribute('data-chart-data');
                if (chartType && chartData) {
                    try {
                        createServiceChart(canvas, chartType, JSON.parse(chartData));
                    } catch (e) {
                        console.error(`Failed to create chart for ${serviceId}:`, e);
                    }
                }
            });
        }

        // Create service chart
        function createServiceChart(canvas, type, data) {
            const ctx = canvas.getContext('2d');
            const chartId = canvas.id;
            
            // Destroy existing chart
            if (charts[chartId]) {
                charts[chartId].destroy();
            }
            
            // Create new chart based on type
            let config;
            switch (type) {
                case 'radar':
                    config = createRadarChartConfig(data);
                    break;
                case 'polarArea':
                    config = createPolarAreaChartConfig(data);
                    break;
                case 'bar':
                    config = createBarChartConfig(data);
                    break;
                default:
                    return;
            }
            
            charts[chartId] = new Chart(ctx, config);
        }

        // Render service content - COMPREHENSIVE FIX
        function renderServiceContent(service, data) {
            console.log(`Rendering content for ${service.id}:`, data);
            
            // Check if data exists
            if (!data || Object.keys(data).length === 0) {
                console.log(`No data for ${service.id}`);
                return `
                    <div class="empty-state">
                        <i class="fas fa-info-circle"></i>
                        <p class="empty-state-text">No data available</p>
                        <p class="empty-state-subtext">This analysis could not be completed</p>
                    </div>
                `;
            }
            
            // Check if service is locked
            if (service.isPro && !isPro) {
                return `
                    <div class="empty-state">
                        <i class="fas fa-lock"></i>
                        <p class="empty-state-text">Pro Feature</p>
                        <p class="empty-state-subtext">Upgrade to access ${service.name}</p>
                    </div>
                `;
            }
            
            // Render based on service type
            switch (service.id) {
                case 'source_credibility':
                    return renderSourceCredibility(data);
                case 'author_analyzer':
                    return renderAuthorAnalysis(data);
                case 'bias_detector':
                    return renderBiasDetection(data);
                case 'fact_checker':
                    return renderFactChecker(data);
                case 'transparency_analyzer':
                    return renderTransparency(data);
                case 'manipulation_detector':
                    return renderManipulation(data);
                case 'content_analyzer':
                    return renderContentAnalysis(data);
                case 'plagiarism_detector':
                    return renderPlagiarism(data);
                default:
                    return '<p>Analysis complete</p>';
            }
        }

        // Service renderers - FIXED to handle various data structures
        function renderSourceCredibility(data) {
            const score = extractScore(data, ['credibility_score', 'score']);
            const level = data.credibility_level || data.level || getCredibilityLevel(score);
            const sourceName = data.source_name || data.name || 'Unknown Source';
            
            let content = `
                <div class="service-section">
                    <h4 class="section-title">
                        <i class="fas fa-chart-line"></i>
                        Credibility Assessment
                    </h4>
                    <div class="service-results">
                        <div class="result-item">
                            <span class="result-label">Overall Score</span>
                            <span class="result-value">${score}/100</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Credibility Level</span>
                            <span class="status-badge status-${score >= 70 ? 'high' : score >= 40 ? 'medium' : 'low'}">
                                ${level}
                            </span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Source Name</span>
                            <span class="result-value">${sourceName}</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Source info - handle multiple possible field names
            const sourceInfo = data.source_info || data.source_details || data.details;
            if (sourceInfo) {
                content += `
                    <div class="service-section">
                        <h4 class="section-title">
                            <i class="fas fa-building"></i>
                            Source Information
                        </h4>
                        <div class="service-results">
                            ${sourceInfo.type ? `
                                <div class="result-item">
                                    <span class="result-label">Source Type</span>
                                    <span class="result-value">${sourceInfo.type}</span>
                                </div>
                            ` : ''}
                            ${sourceInfo.bias ? `
                                <div class="result-item">
                                    <span class="result-label">Political Bias</span>
                                    <span class="result-value">${sourceInfo.bias}</span>
                                </div>
                            ` : ''}
                            ${sourceInfo.credibility_rating ? `
                                <div class="result-item">
                                    <span class="result-label">Database Rating</span>
                                    <span class="result-value">${sourceInfo.credibility_rating}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Technical analysis
            if (data.technical_analysis) {
                const tech = data.technical_analysis;
                content += `
                    <div class="service-section">
                        <h4 class="section-title">
                            <i class="fas fa-server"></i>
                            Technical Analysis
                        </h4>
                        <div class="service-results">
                            ${tech.age_years !== undefined ? `
                                <div class="result-item">
                                    <span class="result-label">Domain Age</span>
                                    <span class="result-value">${tech.age_years.toFixed(1)} years</span>
                                </div>
                            ` : ''}
                            ${tech.ssl && tech.ssl.valid !== undefined ? `
                                <div class="result-item">
                                    <span class="result-label">SSL Certificate</span>
                                    <span class="result-value">
                                        ${tech.ssl.valid ? 
                                            '<i class="fas fa-check" style="color: var(--accent);"></i> Valid' : 
                                            '<i class="fas fa-times" style="color: var(--danger);"></i> Invalid'}
                                    </span>
                                </div>
                            ` : ''}
                            ${tech.registrar ? `
                                <div class="result-item">
                                    <span class="result-label">Registrar</span>
                                    <span class="result-value">${tech.registrar}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Findings
            if (data.findings && data.findings.length > 0) {
                content += `
                    <div class="service-section">
                        <h4 class="section-title">
                            <i class="fas fa-list-check"></i>
                            Key Findings
                        </h4>
                        <div class="claims-list">
                `;
                
                data.findings.forEach(finding => {
                    const severityClass = finding.severity === 'positive' ? 'verified' : 
                                        finding.severity === 'high' ? 'false' : 'unverified';
                    const icon = finding.severity === 'positive' ? 'fa-check' : 
                               finding.severity === 'high' ? 'fa-times' : 'fa-exclamation';
                    
                    content += `
                        <div class="claim-item">
                            <div class="claim-header">
                                <div class="claim-text">${finding.text}</div>
                                <div class="claim-status claim-${severityClass}">
                                    <i class="fas ${icon}"></i>
                                    ${finding.type ? finding.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : ''}
                                </div>
                            </div>
                            ${finding.explanation ? `
                                <div class="claim-details">
                                    ${finding.explanation}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                content += `
                        </div>
                    </div>
                `;
            }
            
            // Summary
            if (data.summary) {
                content += `
                    <div class="info-box">
                        <div class="info-box-title">
                            <i class="fas fa-lightbulb"></i>
                            Analysis Summary
                        </div>
                        <div class="info-box-content">
                            ${data.summary}
                        </div>
                    </div>
                `;
            }
            
            return content;
        }

        function renderAuthorAnalysis(data) {
            const authorName = data.author_name || data.name || 'Unknown Author';
            const score = extractScore(data, ['credibility_score', 'score']);
            const level = data.credibility_level || getCredibilityLevel(score);
            
            let content = `
                <div class="service-section">
                    <h4 class="section-title">
                        <i class="fas fa-id-card"></i>
                        Author Information
                    </h4>
                    <div class="service-results">
                        <div class="result-item">
                            <span class="result-label">Name</span>
                            <span class="result-value">${authorName}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Credibility Score</span>
                            <span class="result-value">${score}/100</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Credibility Level</span>
                            <span class="status-badge status-${score >= 70 ? 'high' : score >= 40 ? 'medium' : 'low'}">
                                ${level}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            
            // Author details
            const authorInfo = data.author_info || data.details || data.profile;
            if (authorInfo) {
                if (authorInfo.position || authorInfo.bio || authorInfo.expertise_areas?.length > 0) {
                    content += `
                        <div class="service-section">
                            <h4 class="section-title">
                                <i class="fas fa-graduation-cap"></i>
                                Professional Background
                            </h4>
                            <div class="service-results">
                    `;
                    
                    if (authorInfo.position) {
                        content += `
                            <div class="result-item">
                                <span class="result-label">Position</span>
                                <span class="result-value">${authorInfo.position}</span>
                            </div>
                        `;
                    }
                    
                    if (authorInfo.expertise_areas && authorInfo.expertise_areas.length > 0) {
                        content += `
                            <div class="result-item">
                                <span class="result-label">Areas of Expertise</span>
                                <span class="result-value">${authorInfo.expertise_areas.join(', ')}</span>
                            </div>
                        `;
                    }
                    
                    if (authorInfo.article_count !== undefined) {
                        content += `
                            <div class="result-item">
                                <span class="result-label">Articles Written</span>
                                <span class="result-value">${authorInfo.article_count}</span>
                            </div>
                        `;
                    }
                    
                    content += `
                            </div>
                        </div>
                    `;
                }
            }
            
            // Verification status
            if (data.verification_status) {
                const verStatus = data.verification_status;
                content += `
                    <div class="service-section">
                        <h4 class="section-title">
                            <i class="fas fa-check-circle"></i>
                            Verification Status
                        </h4>
                        <div class="service-results">
                            <div class="result-item">
                                <span class="result-label">Verification Level</span>
                                <span class="status-badge status-${verStatus.verified ? 'high' : 'low'}">
                                    ${verStatus.verified ? 'Verified' : 'Unverified'}
                                </span>
                            </div>
                            ${verStatus.method ? `
                                <div class="result-item">
                                    <span class="result-label">Verification Method</span>
                                    <span class="result-value">${verStatus.method}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            return content;
        }

        function renderBiasDetection(data) {
            const overallBias = extractScore(data, ['overall_bias_score', 'bias_score', 'overallBias'], 0);
            const biasLevel = data.bias_level || data.level || getBiasLevel(overallBias);
            const objectivityScore = 100 - overallBias;
            
            let content = `
                <div class="service-section">
                    <h4 class="section-title">
                        <i class="fas fa-balance-scale"></i>
                        Overall Bias Assessment
                    </h4>
                    <div class="service-results">
                        <div class="result-item">
                            <span class="result-label">Bias Score</span>
                            <span class="result-value">${overallBias}/100</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Bias Level</span>
                            <span class="status-badge status-${overallBias <= 20 ? 'high' : overallBias <= 50 ? 'medium' : 'low'}">
                                ${biasLevel}
                            </span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Objectivity Score</span>
                            <span class="result-value">${objectivityScore}%</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Bias dimensions - handle multiple possible structures
            const dimensions = data.dimensions || data.bias_dimensions || data.biases || data.dimension_scores;
            if (dimensions && typeof dimensions === 'object' && Object.keys(dimensions).length > 0) {
                const chartId = `bias-chart-${Date.now()}`;
                const chartData = {
                    labels: [],
                    values: []
                };
                
                content += `
                    <div class="service-section">
                        <h4 class="section-title">
                            <i class="fas fa-chart-bar"></i>
                            Bias Dimensions Analysis
                        </h4>
                        <div class="dimension-list">
                `;
                
                // Process each dimension safely
                Object.entries(dimensions).forEach(([dimension, dimData]) => {
                    try {
                        let score, label;
                        
                        // Handle different data structures
                        if (typeof dimData === 'object' && dimData !== null) {
                            score = extractScore(dimData, ['score', 'value', 'level'], 0);
                            // Normalize score to 0-100 range
                            if (score > 0 && score <= 1) {
                                score = score * 100;
                            }
                            label = dimData.label || dimData.name || formatDimensionName(dimension);
                        } else {
                            score = Math.abs(Number(dimData) || 0);
                            if (score <= 1) score *= 100;
                            label = formatDimensionName(dimension);
                        }
                        
                        // Clamp score between 0 and 100
                        score = Math.max(0, Math.min(100, score));
                        
                        chartData.labels.push(label);
                        chartData.values.push(Math.round(score));
                        
                        content += `
                            <div class="dimension-item">
                                <div class="dimension-header">
                                    <span class="dimension-name">${label}</span>
                                    <span class="dimension-score">${Math.round(score)}%</span>
                                </div>
                                <div class="dimension-bar">
                                    <div class="dimension-fill" style="width: ${score}%; background: ${getBiasColor(score)};"></div>
                                </div>
                            </div>
                        `;
                    } catch (e) {
                        console.error(`Error processing dimension ${dimension}:`, e);
                    }
                });
                
                content += `
                        </div>
                    </div>
                `;
                
                // Add visualization only if we have valid data
                if (chartData.labels.length > 0 && chartData.values.length > 0) {
                    content += `
                        <div class="service-visualization">
                            <div class="chart-container">
                                <canvas id="${chartId}" data-chart-type="polarArea" data-chart-data='${JSON.stringify(chartData)}'></canvas>
                            </div>
                        </div>
                    `;
                }
            }
            
            return content;
        }

        function renderFactChecker(data) {
            // Normalize the data
            const normalized = DataStructureMapper.normalizeFactCheckerData(data);
            const { claims_checked: total, verified_count: verified, claims } = normalized;
            const accuracy = total > 0 ? Math.round((verified / total) * 100) : 0;
            
            let content = `
                <div class="service-section">
                    <h4 class="section-title">
                        <i class="fas fa-check-circle"></i>
                        Fact Checking Summary
                    </h4>
                    <div class="service-results">
                        <div class="result-item">
                            <span class="result-label">Claims Analyzed</span>
                            <span class="result-value">${total}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Verified Claims</span>
                            <span class="result-value">${verified}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Accuracy Rate</span>
                            <span class="result-value">${accuracy}%</span>
                        </div>
                    </div>
                    ${total > 0 ? `
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${accuracy}%"></div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Individual claims
            if (claims && claims.length > 0) {
                content += `
                    <div class="service-section">
                        <h4 class="section-title">
                            <i class="fas fa-list"></i>
                            Individual Claims Analysis
                        </h4>
                        <div class="claims-list">
                `;
                
                claims.forEach(claim => {
                    const claimText = claim.claim || claim.claim_text || claim.text || 'Unknown claim';
                    const status = claim.verdict || claim.verification_status || 'unverified';
                    const statusLower = status.toLowerCase();
                    const statusClass = statusLower.includes('true') || statusLower === 'verified' ? 'verified' : 
                                      statusLower.includes('false') ? 'false' : 'unverified';
                    const statusIcon = statusClass === 'verified' ? 'fa-check' : 
                                     statusClass === 'false' ? 'fa-times' : 'fa-question';
                    
                    content += `
                        <div class="claim-item">
                            <div class="claim-header">
                                <div class="claim-text">"${escapeHtml(claimText)}"</div>
                                <div class="claim-status claim-${statusClass}">
                                    <i class="fas ${statusIcon}"></i>
                                    ${formatStatus(status)}
                                </div>
                            </div>
                            ${claim.explanation || claim.fact_check_result || claim.verification_details ? `
                                <div class="claim-details">
                                    ${claim.explanation || claim.fact_check_result || claim.verification_details}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                content += `
                        </div>
                    </div>
                `;
            }
            
            // Summary
            if (data.summary) {
                content += `
                    <div class="info-box">
                        <div class="info-box-title">
                            <i class="fas fa-lightbulb"></i>
                            Analysis Summary
                        </div>
                        <div class="info-box-content">
                            ${data.summary}
                        </div>
                    </div>
                `;
            }
            
            return content;
        }

        function renderTransparency(data) {
            const score = extractScore(data, ['transparency_score', 'score'], 0);
            const level = data.transparency_level || data.level || getTransparencyLevel(score);
            
            let content = `
                <div class="service-section">
                    <h4 class="section-title">
                        <i class="fas fa-eye"></i>
                        Transparency Assessment
                    </h4>
                    <div class="service-results">
                        <div class="result-item">
                            <span class="result-label">Transparency Score</span>
                            <span class="result-value">${score}%</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Transparency Level</span>
                            <span class="status-badge status-${score >= 70 ? 'high' : score >= 40 ? 'medium' : 'low'}">
                                ${level}
                            </span>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${score}%"></div>
                    </div>
                </div>
            `;
            
            // Transparency indicators
            const indicators = data.transparency_indicators || data.indicators;
            if (indicators) {
                content += `
                    <div class="service-section">
                        <h4 class="section-title">
                            <i class="fas fa-list-check"></i>
                            Transparency Indicators
                        </h4>
                `;
                
                const indicatorsList = indicators.indicators || indicators.list || 
                                     (Array.isArray(indicators) ? indicators : []);
                
                if (indicatorsList.length > 0) {
                    content += `
                        <div class="service-results">
                            ${indicatorsList.map(indicator => `
                                <div class="result-item">
                                    <span class="result-label">${indicator}</span>
                                    <span class="result-value">
                                        <i class="fas fa-check" style="color: var(--accent);"></i> Present
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                if (indicators.score !== undefined) {
                    content += `
                        <div class="result-item" style="margin-top: 1rem;">
                            <span class="result-label">Indicator Score</span>
                            <span class="result-value">${indicators.score}/100</span>
                        </div>
                    `;
                }
                
                content += `</div>`;
            }
            
            // Issues or findings
            if (data.issues && data.issues.length > 0) {
                content += `
                    <div class="service-section">
                        <h4 class="section-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            Transparency Issues
                        </h4>
                        <div class="claims-list">
                            ${data.issues.map(issue => `
                                <div class="claim-item">
                                    <div class="claim-text">${issue.text || issue}</div>
                                    ${issue.severity ? `
                                        <span class="technique-severity severity-${issue.severity.toLowerCase()}">
                                            ${issue.severity} severity
                                        </span>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Summary
            if (data.summary) {
                content += `
                    <div class="info-box">
                        <div class="info-box-title">
                            <i class="fas fa-lightbulb"></i>
                            Analysis Summary
                        </div>
                        <div class="info-box-content">
                            ${data.summary}
                        </div>
                    </div>
                `;
            }
            
            return content;
        }

        function renderManipulation(data) {
            const level = data.manipulation_level || data.level || 'Unknown';
            const score = extractScore(data, ['manipulation_score', 'score'], 0);
            const techniques = data.techniques || [];
            const techniquesCount = data.techniques_count || techniques.length;
            
            let content = `
                <div class="service-section">
                    <h4 class="section-title">
                        <i class="fas fa-mask"></i>
                        Manipulation Assessment
                    </h4>
                    <div class="service-results">
                        <div class="result-item">
                            <span class="result-label">Manipulation Level</span>
                            <span class="status-badge status-${
                                level.toLowerCase() === 'low' || level.toLowerCase() === 'minimal' ? 'high' : 
                                level.toLowerCase() === 'moderate' ? 'medium' : 'low'
                            }">
                                ${level}
                            </span>
                        </div>
                        ${score !== undefined && score !== 0 ? `
                            <div class="result-item">
                                <span class="result-label">Manipulation Score</span>
                                <span class="result-value">${score}/100</span>
                            </div>
                        ` : ''}
                        <div class="result-item">
                            <span class="result-label">Techniques Detected</span>
                            <span class="result-value">${techniquesCount}</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Manipulation techniques
            if (techniques.length > 0) {
                content += `
                    <div class="service-section">
                        <h4 class="section-title">
                            <i class="fas fa-brain"></i>
                            Detected Manipulation Techniques
                        </h4>
                        <div class="techniques-grid">
                `;
                
                techniques.forEach(technique => {
                    const techName = technique.name || technique.type || technique.technique || 'Unknown';
                    const techDesc = technique.description || technique.details || 
                                   technique.evidence || technique.explanation || '';
                    
                    content += `
                        <div class="technique-card">
                            <div class="technique-name">${techName}</div>
                            <div class="technique-description">
                                ${techDesc}
                                ${technique.severity ? 
                                    `<span class="technique-severity severity-${technique.severity.toLowerCase()}">
                                        ${technique.severity} severity
                                    </span>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                content += `
                        </div>
                    </div>
                `;
            }
            
            // Emotional manipulation
            if (data.emotional_manipulation) {
                const em = data.emotional_manipulation;
                content += `
                    <div class="service-section">
                        <h4 class="section-title">
                            <i class="fas fa-heart"></i>
                            Emotional Manipulation
                        </h4>
                        <div class="service-results">
                            ${em.level ? `
                                <div class="result-item">
                                    <span class="result-label">Level</span>
                                    <span class="result-value">${em.level}</span>
                                </div>
                            ` : ''}
                            ${em.score !== undefined ? `
                                <div class="result-item">
                                    <span class="result-label">Score</span>
                                    <span class="result-value">${em.score}/100</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Summary
            if (data.summary) {
                content += `
                    <div class="info-box">
                        <div class="info-box-title">
                            <i class="fas fa-lightbulb"></i>
                            Analysis Summary
                        </div>
                        <div class="info-box-content">
                            ${data.summary}
                        </div>
                    </div>
                `;
            }
            
            return content;
        }

        function renderContentAnalysis(data) {
            let content = `
                <div class="service-section">
                    <h4 class="section-title">
                        <i class="fas fa-file-alt"></i>
                        Content Quality Metrics
                    </h4>
                    <div class="service-results">
            `;
            
            const qualityScore = extractScore(data, ['quality_score', 'score'], 0);
            if (qualityScore !== undefined) {
                content += `
                    <div class="result-item">
                        <span class="result-label">Overall Quality</span>
                        <span class="result-value">${qualityScore}/100</span>
                    </div>
                `;
            }
            
            // Readability
            const readability = data.readability || {};
            if (readability.score !== undefined) {
                content += `
                    <div class="result-item">
                        <span class="result-label">Readability Score</span>
                        <span class="result-value">${readability.score}/100</span>
                    </div>
                `;
            }
            if (readability.level) {
                content += `
                    <div class="result-item">
                        <span class="result-label">Reading Level</span>
                        <span class="result-value">${readability.level}</span>
                    </div>
                `;
            }
            if (readability.flesch_kincaid_grade !== undefined) {
                content += `
                    <div class="result-item">
                        <span class="result-label">Flesch-Kincaid Grade</span>
                        <span class="result-value">${readability.flesch_kincaid_grade.toFixed(1)}</span>
                    </div>
                `;
            }
            
            if (data.structure_quality) {
                content += `
                    <div class="result-item">
                        <span class="result-label">Structure Quality</span>
                        <span class="result-value">${data.structure_quality}</span>
                    </div>
                `;
            }
            
            if (data.evidence_quality) {
                content += `
                    <div class="result-item">
                        <span class="result-label">Evidence Quality</span>
                        <span class="result-value">${data.evidence_quality}</span>
                    </div>
                `;
            }
            
            content += `
                    </div>
                </div>
            `;
            
            // Statistical claims
            if (data.statistical_claims && data.statistical_claims.total_claims > 0) {
                const stats = data.statistical_claims;
                content += `
                    <div class="service-section">
                        <h4 class="section-title">
                            <i class="fas fa-chart-line"></i>
                            Statistical Claims Analysis
                        </h4>
                        <div class="service-results">
                            <div class="result-item">
                                <span class="result-label">Total Claims</span>
                                <span class="result-value">${stats.total_claims}</span>
                            </div>
                            ${stats.sourced_percentage !== undefined ? `
                                <div class="result-item">
                                    <span class="result-label">Sourced Claims</span>
                                    <span class="result-value">${stats.sourced_percentage.toFixed(0)}%</span>
                                </div>
                            ` : ''}
                            ${stats.verified_percentage !== undefined ? `
                                <div class="result-item">
                                    <span class="result-label">Verified Claims</span>
                                    <span class="result-value">${stats.verified_percentage.toFixed(0)}%</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Content indicators
            if (data.content_indicators) {
                const indicators = data.content_indicators;
                content += `
                    <div class="service-section">
                        <h4 class="section-title">
                            <i class="fas fa-tasks"></i>
                            Content Indicators
                        </h4>
                        <div class="service-results">
                            ${Object.entries(indicators).map(([key, value]) => `
                                <div class="result-item">
                                    <span class="result-label">${formatFactorName(key)}</span>
                                    <span class="result-value">${value}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Summary
            if (data.summary) {
                content += `
                    <div class="info-box">
                        <div class="info-box-title">
                            <i class="fas fa-lightbulb"></i>
                            Analysis Summary
                        </div>
                        <div class="info-box-content">
                            ${data.summary}
                        </div>
                    </div>
                `;
            }
            
            return content;
        }

        function renderPlagiarism(data) {
            const similarity = data.similarity_score || 0;
            const originality = data.originality_score !== undefined ? 
                data.originality_score : (100 - similarity);
            const status = originality >= 80 ? 'Original' : 
                          originality >= 60 ? 'Mostly Original' : 'Potential Issues';
            
            let content = `
                <div class="service-section">
                    <h4 class="section-title">
                        <i class="fas fa-copy"></i>
                        Plagiarism Check Results
                    </h4>
                    <div class="service-results">
                        <div class="result-item">
                            <span class="result-label">Originality Score</span>
                            <span class="result-value">${originality}%</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Similarity Score</span>
                            <span class="result-value">${similarity}%</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Status</span>
                            <span class="status-badge status-${originality >= 80 ? 'high' : originality >= 60 ? 'medium' : 'low'}">
                                ${status}
                            </span>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${originality}%; background: var(--accent);"></div>
                    </div>
                </div>
            `;
            
            // Matched sources
            if (data.matches && data.matches.length > 0) {
                content += `
                    <div class="service-section">
                        <h4 class="section-title">
                            <i class="fas fa-link"></i>
                            Matched Sources
                        </h4>
                        <div class="claims-list">
                `;
                
                data.matches.forEach(match => {
                    const matchPercentage = match.similarity || match.match_percentage || 0;
                    content += `
                        <div class="claim-item">
                            <div class="claim-header">
                                <div class="claim-text">${match.source || match.url || 'Unknown source'}</div>
                                <div class="claim-status">
                                    ${matchPercentage}% match
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                content += `
                        </div>
                    </div>
                `;
            }
            
            return content;
        }

        // Chart configuration functions
        function createRadarChartConfig(data) {
            return {
                type: 'radar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.values,
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(99, 102, 241, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    }
                }
            };
        }

        function createPolarAreaChartConfig(data) {
            return {
                type: 'polarArea',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.values,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.5)',
                            'rgba(54, 162, 235, 0.5)',
                            'rgba(255, 206, 86, 0.5)',
                            'rgba(75, 192, 192, 0.5)',
                            'rgba(153, 102, 255, 0.5)',
                            'rgba(255, 159, 64, 0.5)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            };
        }

        function createBarChartConfig(data) {
            return {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.values,
                        backgroundColor: 'rgba(99, 102, 241, 0.5)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            };
        }

        // Utility functions
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            
            // Enhanced error message mapping
            const errorMappings = {
                'timed out': 'The website took too long to respond. This might be due to the site blocking automated requests. Try a different article.',
                'timeout': 'Request timed out. The website may be slow or blocking our service.',
                'extraction methods failed': 'Unable to extract article content. The website may be blocking our service or the URL might be invalid.',
                'Invalid URL': 'Please enter a valid news article URL starting with http:// or https://',
                'Analysis failed': 'Unable to analyze the article. Please try a different URL or check your internet connection.',
                '403': 'Access denied. This website blocks automated analysis. Try a different news source.',
                '404': 'Article not found. Please check the URL and try again.',
                '500': 'Server error occurred. Please try again in a few moments.',
                'No data available': 'The analysis completed but no data was returned. This might be a temporary issue.',
                'Invalid response format': 'The server returned an unexpected response. Please try again.'
            };
            
            // Find matching error pattern
            let displayMessage = message;
            for (const [pattern, friendlyMessage] of Object.entries(errorMappings)) {
                if (message.toLowerCase().includes(pattern.toLowerCase())) {
                    displayMessage = friendlyMessage;
                    break;
                }
            }
            
            errorEl.textContent = displayMessage;
            errorEl.classList.add('active');
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                hideError();
            }, 10000);
        }

        function hideError() {
            const errorEl = document.getElementById('errorMessage');
            errorEl.classList.remove('active');
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function hideResults() {
            document.getElementById('resultsSection').classList.remove('active');
        }

        function getScoreColor(score) {
            if (score >= 80) return '#10B981';
            if (score >= 60) return '#3B82F6';
            if (score >= 40) return '#F59E0B';
            return '#EF4444';
        }

        function getDimensionColor(score) {
            if (score >= 80) return 'var(--accent)';
            if (score >= 60) return 'var(--info)';
            if (score >= 40) return 'var(--warning)';
            return 'var(--danger)';
        }

        function getBiasColor(score) {
            // Lower bias score is better
            if (score <= 20) return 'var(--accent)';
            if (score <= 50) return 'var(--warning)';
            return 'var(--danger)';
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function formatFactorName(factor) {
            return factor
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatDimensionName(dimension) {
            if (!dimension || typeof dimension !== 'string') return 'Unknown';
            
            const dimensionNames = {
                'political': 'Political Bias',
                'ideological': 'Ideological Bias',
                'commercial': 'Commercial Bias',
                'sensational': 'Sensationalism',
                'cultural': 'Cultural Bias',
                'confirmation': 'Confirmation Bias',
                'partisan': 'Partisan Bias',
                'corporate': 'Corporate Bias'
            };
            
            const key = dimension.toLowerCase().trim();
            return dimensionNames[key] || dimension
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatStatus(status) {
            const statusNames = {
                'verified': 'Verified',
                'false': 'False',
                'unverified': 'Unverified',
                'partially_true': 'Partially True',
                'misleading': 'Misleading'
            };
            return statusNames[status.toLowerCase()] || status;
        }

        // Helper functions for missing level calculations
        function getCredibilityLevel(score) {
            if (score >= 80) return 'Very High';
            if (score >= 60) return 'High';
            if (score >= 40) return 'Moderate';
            if (score >= 20) return 'Low';
            return 'Very Low';
        }

        function getBiasLevel(score) {
            if (score <= 20) return 'Minimal';
            if (score <= 40) return 'Low';
            if (score <= 60) return 'Moderate';
            if (score <= 80) return 'High';
            return 'Extreme';
        }

        function getTransparencyLevel(score) {
            if (score >= 80) return 'Highly Transparent';
            if (score >= 60) return 'Transparent';
            if (score >= 40) return 'Partially Transparent';
            return 'Low Transparency';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Enhanced PDF download
        async function downloadPDF() {
            if (!currentAnalysis || !currentAnalysis.analysis || !currentAnalysis.article) {
                showError('No analysis available to download');
                return;
            }
            
            showLoading();
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPosition = 20;
                const lineHeight = 7;
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 20;
                const contentWidth = pageWidth - (2 * margin);
                
                // Helper function to add text with page break check
                function addText(text, fontSize = 12, fontStyle = 'normal', indent = 0) {
                    doc.setFontSize(fontSize);
                    doc.setFont(undefined, fontStyle);
                    
                    const lines = doc.splitTextToSize(text, contentWidth - indent);
                    
                    lines.forEach(line => {
                        if (yPosition > pageHeight - 30) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        doc.text(line, margin + indent, yPosition);
                        yPosition += fontSize === 12 ? lineHeight : lineHeight + 2;
                    });
                }
                
                // Title Page
                doc.setFillColor(99, 102, 241);
                doc.rect(0, 0, pageWidth, 60, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.text('TruthLens AI Analysis Report', pageWidth / 2, 30, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text('Professional News Verification', pageWidth / 2, 45, { align: 'center' });
                
                doc.setTextColor(0, 0, 0);
                yPosition = 80;
                
                // Executive Summary
                addText('EXECUTIVE SUMMARY', 18, 'bold');
                yPosition += 5;
                
                addText(`URL: ${document.getElementById('urlInput').value}`, 12);
                addText(`Analysis Date: ${new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })}`, 12);
                
                yPosition += 10;
                
                // Trust Score Box
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition, contentWidth, 40, 'F');
                
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text(`Overall Trust Score: ${currentAnalysis.analysis.trust_score}/100`, margin + 10, yPosition + 15);
                
                doc.setFontSize(14);
                doc.text(`Trust Level: ${currentAnalysis.analysis.trust_level}`, margin + 10, yPosition + 30);
                
                yPosition += 50;
                
                // Article Information
                addText('ARTICLE INFORMATION', 16, 'bold');
                yPosition += 5;
                
                addText(`Title: ${currentAnalysis.article.title || 'Unknown'}`, 12);
                addText(`Author: ${currentAnalysis.article.author || 'Unknown'}`, 12);
                addText(`Source: ${currentAnalysis.article.domain || 'Unknown'}`, 12);
                addText(`Publication Date: ${formatDate(currentAnalysis.article.publish_date)}`, 12);
                addText(`Word Count: ${currentAnalysis.article.word_count || 'Unknown'}`, 12);
                
                yPosition += 10;
                
                // Trust Score Analysis
                addText('TRUST SCORE ANALYSIS', 16, 'bold');
                yPosition += 5;
                addText(getTrustSummaryExplanation(currentAnalysis.analysis.trust_score, currentAnalysis.analysis.trust_level, currentAnalysis.analysis), 12);
                
                yPosition += 10;
                
                // Component Scores
                addText('TRUST COMPONENTS', 16, 'bold');
                yPosition += 5;
                
                const detailedAnalysis = currentAnalysis.detailed_analysis || {};
                const components = [
                    {
                        name: 'Source Credibility',
                        score: extractScore(detailedAnalysis.source_credibility, ['credibility_score', 'score']),
                        explanation: getSourceCredibilityExplanation(detailedAnalysis.source_credibility)
                    },
                    {
                        name: 'Author Credibility',
                        score: extractScore(detailedAnalysis.author_analyzer, ['credibility_score', 'score']),
                        explanation: getAuthorCredibilityExplanation(detailedAnalysis.author_analyzer)
                    },
                    {
                        name: 'Objectivity Score',
                        score: 100 - extractScore(detailedAnalysis.bias_detector, ['overall_bias_score', 'bias_score'], 0),
                        explanation: getObjectivityExplanation(detailedAnalysis.bias_detector)
                    },
                    {
                        name: 'Fact Accuracy',
                        score: calculateFactAccuracy(detailedAnalysis.fact_checker),
                        explanation: getFactAccuracyExplanation(detailedAnalysis.fact_checker)
                    }
                ];
                
                components.forEach(comp => {
                    addText(`${comp.name}: ${comp.score}%`, 12, 'bold');
                    addText(comp.explanation, 11, 'normal', 5);
                    yPosition += 3;
                });
                
                // Key Findings
                if (currentAnalysis.analysis.key_findings && currentAnalysis.analysis.key_findings.length > 0) {
                    yPosition += 10;
                    addText('KEY FINDINGS', 16, 'bold');
                    yPosition += 5;
                    
                    currentAnalysis.analysis.key_findings.forEach((finding, index) => {
                        const findingText = `${index + 1}. ${finding.text || finding.finding}`;
                        const severity = finding.severity === 'positive' ? '✓' : 
                                       finding.severity === 'high' ? '⚠' : '•';
                        addText(`${severity} ${findingText}`, 12, 'normal', 5);
                    });
                }
                
                // New page for detailed analysis
                doc.addPage();
                yPosition = 20;
                
                addText('DETAILED ANALYSIS', 18, 'bold');
                yPosition += 10;
                
                // Process each service
                services.forEach(service => {
                    const serviceData = detailedAnalysis[service.id];
                    if (!serviceData || Object.keys(serviceData).length === 0) return;
                    
                    // Add page break if needed
                    if (yPosition > pageHeight - 80) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    // Service header
                    doc.setFillColor(245, 245, 245);
                    doc.rect(margin, yPosition, contentWidth, 10, 'F');
                    addText(service.name.toUpperCase(), 14, 'bold');
                    yPosition += 5;
                    
                    // Service-specific content
                    const previewData = getServicePreviewData(service.id, serviceData);
                    previewData.forEach(item => {
                        addText(`${item.label}: ${item.value}`, 12);
                    });
                    
                    // Add service summary if available
                    if (serviceData.summary) {
                        yPosition += 3;
                        addText('Summary:', 12, 'bold');
                        addText(serviceData.summary, 11, 'normal', 5);
                    }
                    
                    yPosition += 10;
                });
                
                // Footer
                doc.setFontSize(10);
                doc.setTextColor(128, 128, 128);
                const totalPages = doc.internal.getNumberOfPages();
                
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.text(
                        `Page ${i} of ${totalPages} | Generated by TruthLens AI | ${new Date().toLocaleDateString()}`,
                        pageWidth / 2,
                        pageHeight - 10,
                        { align: 'center' }
                    );
                }
                
                // Save the PDF
                const fileName = `truthlens-analysis-${Date.now()}.pdf`;
                doc.save(fileName);
                
            } catch (error) {
                console.error('PDF generation error:', error);
                showError('Failed to generate PDF report. Please try again.');
            } finally {
                hideLoading();
            }
        }

        // Share results
        function shareResults() {
            if (!currentAnalysis || !currentAnalysis.analysis) {
                showError('No analysis available to share');
                return;
            }
            
            const trustScore = currentAnalysis.analysis.trust_score || 0;
            const articleTitle = currentAnalysis.article.title || 'Article';
            
            const shareText = `TruthLens AI Analysis: "${articleTitle}" scored ${trustScore}/100 for trustworthiness. Check out the detailed analysis:`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'TruthLens AI Analysis',
                    text: shareText,
                    url: window.location.href
                }).catch(err => {
                    console.log('Share cancelled:', err);
                });
            } else {
                // Fallback: Copy link to clipboard
                const url = window.location.href;
                navigator.clipboard.writeText(`${shareText} ${url}`).then(() => {
                    showError('Analysis link copied to clipboard!');
                    setTimeout(hideError, 3000);
                }).catch(() => {
                    showError('Sharing is not supported on this device');
                });
            }
        }

        // Make toggleAccordion function global so onclick can access it
        window.toggleAccordion = toggleAccordion;
    </script>
</body>
</html>

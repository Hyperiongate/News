<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruthLens - News Credibility Analyzer</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    
    <!-- App Styles -->
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/cards.css">
    <link rel="stylesheet" href="/static/css/enhanced-ui.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    
    <style>
        /* Additional inline styles for quick fixes and enhancements */
        .author-credentials {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            margin-top: var(--space-sm);
        }

        .credential-badge {
            padding: 0.25rem 0.75rem;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--primary);
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .credential-badge i {
            font-size: 0.7rem;
        }

        .author-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark);
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .author-position {
            font-size: 0.875rem;
            color: var(--neutral);
            margin-top: 0.25rem;
        }

        .author-bio {
            margin: var(--space-md) 0;
            line-height: 1.6;
            color: var(--dark);
            font-size: 0.95rem;
            padding: var(--space-md);
            background: white;
            border-radius: calc(var(--radius) / 2);
            border-left: 3px solid var(--primary);
        }

        .author-link {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            color: var(--primary);
            text-decoration: none;
            font-size: 0.9rem;
            margin-top: var(--space-sm);
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .author-link:hover {
            text-decoration: underline;
            color: var(--primary-light);
        }

        .author-outlets {
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 1px solid rgba(99, 102, 241, 0.1);
        }

        .author-outlets h6 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: var(--space-sm);
            color: var(--dark);
        }

        .outlet-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
        }

        .outlet-badge {
            padding: 0.25rem 0.75rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 9999px;
            font-size: 0.8rem;
            color: var(--neutral);
        }

        /* NEW: Mini Chart Container */
        .mini-chart {
            height: 150px;
            margin: var(--space-sm) 0;
        }

        /* NEW: Stat Grid */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-sm);
            margin: var(--space-sm) 0;
        }

        .stat-item {
            text-align: center;
            padding: var(--space-sm);
            background: white;
            border-radius: calc(var(--radius) / 2);
            border: 1px solid #e5e7eb;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--neutral);
            display: block;
            margin-top: 0.25rem;
        }

        /* Expertise areas styling */
        .expertise-areas {
            margin-top: var(--space-sm);
        }

        .expertise-areas h6 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: var(--space-xs);
            color: var(--dark);
        }

        .expertise-tag {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--success);
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
        }

        /* Awards styling */
        .author-awards {
            margin-top: var(--space-md);
            padding: var(--space-sm);
            background: rgba(245, 158, 11, 0.05);
            border-radius: calc(var(--radius) / 2);
        }

        .author-awards h6 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: var(--space-xs);
            color: var(--warning);
        }

        .award-item {
            font-size: 0.8rem;
            color: var(--dark);
            padding-left: 1rem;
            position: relative;
        }

        .award-item:before {
            content: "üèÜ";
            position: absolute;
            left: 0;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo-section">
                    <i class="fas fa-search-location"></i>
                    <h1>TruthLens</h1>
                    <span class="tagline">AI-Powered News Credibility Analysis</span>
                </div>
                <div class="header-nav">
                    <button class="nav-btn" id="aboutBtn">
                        <i class="fas fa-info-circle"></i>
                        About
                    </button>
                    <button class="nav-btn premium" id="premiumBtn">
                        <i class="fas fa-crown"></i>
                        Premium
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Input Section -->
            <section class="input-section glass-morphism">
                <h2 class="section-title">Analyze News Credibility</h2>
                <div class="input-tabs">
                    <button class="tab-btn active" data-tab="url">
                        <i class="fas fa-link"></i>
                        URL
                    </button>
                    <button class="tab-btn" data-tab="text">
                        <i class="fas fa-file-alt"></i>
                        Text
                    </button>
                </div>
                
                <div class="tab-content" id="url-tab">
                    <div class="input-group">
                        <input 
                            type="url" 
                            id="urlInput" 
                            class="url-input" 
                            placeholder="Enter article URL to analyze..."
                            autocomplete="off"
                        >
                        <button class="analyze-btn" id="analyzeBtn">
                            <i class="fas fa-microscope"></i>
                            Analyze
                        </button>
                    </div>
                    <div class="example-links">
                        <span>Try:</span>
                        <a href="#" class="example-link" data-url="https://www.bbc.com/news">BBC News</a>
                        <a href="#" class="example-link" data-url="https://www.reuters.com/">Reuters</a>
                        <a href="#" class="example-link" data-url="https://apnews.com/">AP News</a>
                    </div>
                </div>
                
                <div class="tab-content" id="text-tab" style="display: none;">
                    <textarea 
                        id="textInput" 
                        class="text-input" 
                        placeholder="Paste article text here..."
                        rows="8"
                    ></textarea>
                    <button class="analyze-btn" id="analyzeTextBtn">
                        <i class="fas fa-microscope"></i>
                        Analyze Text
                    </button>
                </div>
            </section>

            <!-- Progress Section -->
            <section class="progress-section" id="progressSection" style="display: none;">
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="progress-status" id="progressStatus">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Initializing analysis...</span>
                </div>
            </section>

            <!-- Results Section -->
            <section class="results-section" id="resultsSection" style="display: none;">
                <!-- Summary Section -->
                <div class="summary-section glass-morphism">
                    <div class="trust-score-container">
                        <div class="trust-score-gauge" id="trustScoreGauge">
                            <svg viewBox="0 0 200 120">
                                <path d="M 30 100 A 70 70 0 0 1 170 100" fill="none" stroke="#e5e7eb" stroke-width="20" stroke-linecap="round"/>
                                <path id="scoreArc" d="M 30 100 A 70 70 0 0 1 170 100" fill="none" stroke="#10b981" stroke-width="20" stroke-linecap="round" stroke-dasharray="220" stroke-dashoffset="220"/>
                            </svg>
                            <div class="score-display">
                                <span class="score-value" id="trustScore">0</span>
                                <span class="score-label">Trust Score</span>
                            </div>
                        </div>
                        <div class="score-interpretation">
                            <h3 id="scoreLevel">Analyzing...</h3>
                            <p id="scoreDescription">Please wait while we analyze the article...</p>
                        </div>
                    </div>
                    
                    <div class="article-info" id="articleInfo">
                        <!-- Article metadata will be inserted here -->
                    </div>
                    
                    <div class="quick-insights" id="quickInsights">
                        <!-- Key findings will be inserted here -->
                    </div>
                </div>

                <!-- Detailed Analysis Grid -->
                <div class="analysis-grid" id="analysisGrid">
                    <!-- Analysis cards will be inserted here -->
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="secondary-btn" id="newAnalysisBtn">
                        <i class="fas fa-redo"></i>
                        New Analysis
                    </button>
                    <button class="primary-btn" id="downloadBtn">
                        <i class="fas fa-download"></i>
                        Download Report
                    </button>
                </div>
            </section>

            <!-- Premium Preview Section -->
            <section class="premium-section glass-morphism" id="premiumSection" style="display: none;">
                <div class="premium-header">
                    <i class="fas fa-crown"></i>
                    <h2>Unlock Premium Analysis</h2>
                    <p>Get deeper insights with our advanced AI analysis</p>
                </div>
                
                <div class="premium-features">
                    <div class="feature-card">
                        <i class="fas fa-brain"></i>
                        <h3>Advanced AI Models</h3>
                        <p>GPT-4 powered deep analysis for maximum accuracy</p>
                    </div>
                    <div class="feature-card">
                        <i class="fas fa-chart-line"></i>
                        <h3>Historical Tracking</h3>
                        <p>Track source credibility changes over time</p>
                    </div>
                    <div class="feature-card">
                        <i class="fas fa-share-alt"></i>
                        <h3>Social Media Analysis</h3>
                        <p>Analyze viral claims and misinformation patterns</p>
                    </div>
                    <div class="feature-card">
                        <i class="fas fa-file-pdf"></i>
                        <h3>Detailed Reports</h3>
                        <p>Export comprehensive PDF reports with citations</p>
                    </div>
                </div>
                
                <button class="upgrade-btn">
                    Upgrade to Premium - $9.99/month
                </button>
            </section>

            <!-- About Modal -->
            <div class="modal" id="aboutModal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>About TruthLens</h2>
                        <button class="close-btn" id="closeAboutBtn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>TruthLens is an AI-powered news credibility analyzer that helps you evaluate the trustworthiness of news articles using advanced natural language processing and fact-checking algorithms.</p>
                        
                        <h3>How It Works</h3>
                        <ul>
                            <li>Analyzes article content for bias and manipulation tactics</li>
                            <li>Verifies author credentials and publication history</li>
                            <li>Checks source credibility and transparency</li>
                            <li>Identifies potential misinformation patterns</li>
                        </ul>
                        
                        <h3>Our Mission</h3>
                        <p>In an era of information overload and misinformation, we believe everyone deserves tools to critically evaluate news sources. TruthLens empowers readers to make informed decisions about the content they consume.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script>
        // Global variables
        let currentAnalysis = null;
        let isAnalyzing = false;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Tab switching
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.dataset.tab;
                    
                    tabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    tabContents.forEach(content => {
                        content.style.display = content.id === `${targetTab}-tab` ? 'block' : 'none';
                    });
                });
            });

            // Example links
            document.querySelectorAll('.example-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('urlInput').value = link.dataset.url;
                });
            });

            // Analyze buttons
            document.getElementById('analyzeBtn').addEventListener('click', () => {
                const url = document.getElementById('urlInput').value.trim();
                if (url) {
                    analyzeContent(url, 'url');
                } else {
                    showError('Please enter a valid URL');
                }
            });

            document.getElementById('analyzeTextBtn').addEventListener('click', () => {
                const text = document.getElementById('textInput').value.trim();
                if (text && text.length > 100) {
                    analyzeContent(text, 'text');
                } else {
                    showError('Please enter at least 100 characters of text');
                }
            });

            // New analysis button
            document.getElementById('newAnalysisBtn').addEventListener('click', () => {
                resetAnalysis();
            });

            // Modal handlers
            document.getElementById('aboutBtn').addEventListener('click', () => {
                document.getElementById('aboutModal').style.display = 'flex';
            });

            document.getElementById('closeAboutBtn').addEventListener('click', () => {
                document.getElementById('aboutModal').style.display = 'none';
            });

            document.getElementById('premiumBtn').addEventListener('click', () => {
                document.getElementById('premiumSection').style.display = 
                    document.getElementById('premiumSection').style.display === 'none' ? 'block' : 'none';
            });

            // Download button
            document.getElementById('downloadBtn').addEventListener('click', downloadReport);
        });

        // Main analysis function
        async function analyzeContent(content, type) {
            if (isAnalyzing) return;
            
            isAnalyzing = true;
            currentAnalysis = null;
            
            // Show progress
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            
            // Update progress status
            updateProgress('Extracting article content...', 10);
            
            try {
                // Prepare request body based on type
                const requestBody = type === 'url' 
                    ? { url: content } 
                    : { text: content };
                
                console.log('Sending request:', requestBody);
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                // CRITICAL FIX: Properly handle error responses
                if (!response.ok) {
                    let errorMessage = `Analysis failed (${response.status})`;
                    try {
                        const errorData = await response.json();
                        // FIXED: Handle error object properly
                        if (errorData.error) {
                            // Check if error is an object with a message property
                            if (typeof errorData.error === 'object' && errorData.error.message) {
                                errorMessage = errorData.error.message;
                            } else if (typeof errorData.error === 'string') {
                                errorMessage = errorData.error;
                            } else {
                                // Convert object to string if needed
                                errorMessage = JSON.stringify(errorData.error);
                            }
                        }
                    } catch (parseError) {
                        console.error('Failed to parse error response:', parseError);
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                
                // Debug logging
                console.log('API Response:', data);
                
                // Handle the response based on the structure
                if (data.success && data.data) {
                    currentAnalysis = data.data;
                    displayResults(currentAnalysis);
                } else if (data.success === false) {
                    // Handle explicit failure response
                    let errorMsg = 'Analysis failed';
                    if (data.error) {
                        if (typeof data.error === 'object' && data.error.message) {
                            errorMsg = data.error.message;
                        } else if (typeof data.error === 'string') {
                            errorMsg = data.error;
                        }
                    }
                    throw new Error(errorMsg);
                } else {
                    throw new Error('Invalid response format');
                }
                
            } catch (error) {
                console.error('Analysis error:', error);
                // FIXED: Ensure error message is always a string
                const errorMessage = error.message || error.toString() || 'Failed to analyze article. Please try again.';
                showError(errorMessage);
            } finally {
                isAnalyzing = false;
                document.getElementById('progressSection').style.display = 'none';
            }
        }

        // Update progress bar
        function updateProgress(status, percentage) {
            const progressBar = document.getElementById('progressBar');
            const progressStatus = document.getElementById('progressStatus');
            
            progressBar.style.width = `${percentage}%`;
            progressStatus.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${status}`;
            
            // Simulate progress for better UX
            if (percentage < 90) {
                setTimeout(() => {
                    const statuses = [
                        'Analyzing article structure...',
                        'Checking author credentials...',
                        'Evaluating source credibility...',
                        'Detecting bias patterns...',
                        'Verifying facts...',
                        'Generating report...'
                    ];
                    const nextStatus = statuses[Math.floor((percentage / 100) * statuses.length)];
                    updateProgress(nextStatus, percentage + 10);
                }, 500);
            }
        }

        // Display results
        function displayResults(analysis) {
            console.log('=== DISPLAYING RESULTS ===');
            console.log('Full analysis object:', analysis);
            
            document.getElementById('resultsSection').style.display = 'block';
            
            // Update trust score
            const score = analysis.trust_score || 0;
            animateTrustScore(score);
            
            // Update score interpretation
            updateScoreInterpretation(score);
            
            // Display article info
            displayArticleInfo(analysis.article);
            
            // Display quick insights
            displayQuickInsights(analysis);
            
            // Display detailed analysis cards
            if (analysis.detailed_analysis) {
                console.log('Detailed analysis found:', Object.keys(analysis.detailed_analysis));
                displayAnalysisCards(analysis.detailed_analysis);
            } else {
                console.warn('No detailed_analysis in response');
            }
            
            // Store analysis for download
            window.currentAnalysis = analysis;
        }

        // Animate trust score gauge
        function animateTrustScore(score) {
            const scoreValue = document.getElementById('trustScore');
            const scoreArc = document.getElementById('scoreArc');
            
            // Animate number
            let currentScore = 0;
            const increment = score / 20;
            const timer = setInterval(() => {
                currentScore += increment;
                if (currentScore >= score) {
                    currentScore = score;
                    clearInterval(timer);
                }
                scoreValue.textContent = Math.round(currentScore);
            }, 50);
            
            // Animate arc
            const circumference = 220;
            const offset = circumference - (score / 100) * circumference;
            scoreArc.style.strokeDashoffset = offset;
            
            // Update color based on score
            let color;
            if (score >= 80) color = '#10b981';
            else if (score >= 60) color = '#3b82f6';
            else if (score >= 40) color = '#f59e0b';
            else color = '#ef4444';
            
            scoreArc.style.stroke = color;
        }

        // Update score interpretation
        function updateScoreInterpretation(score) {
            const level = document.getElementById('scoreLevel');
            const description = document.getElementById('scoreDescription');
            
            if (score >= 80) {
                level.textContent = 'Highly Credible';
                description.textContent = 'This article demonstrates strong credibility indicators and can be considered reliable.';
            } else if (score >= 60) {
                level.textContent = 'Generally Credible';
                description.textContent = 'This article shows good credibility with some minor concerns to be aware of.';
            } else if (score >= 40) {
                level.textContent = 'Mixed Credibility';
                description.textContent = 'This article has both credible and questionable elements. Read with caution.';
            } else {
                level.textContent = 'Low Credibility';
                description.textContent = 'This article shows significant credibility issues. Verify information from other sources.';
            }
        }

        // Display article info
        function displayArticleInfo(article) {
            const articleInfo = document.getElementById('articleInfo');
            
            const formatDate = (dateStr) => {
                if (!dateStr) return 'Unknown';
                try {
                    return new Date(dateStr).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } catch {
                    return dateStr;
                }
            };
            
            articleInfo.innerHTML = `
                <h4>${escapeHtml(article.title || 'Untitled')}</h4>
                <div class="article-meta">
                    <span><i class="fas fa-user"></i> ${escapeHtml(article.author || 'Unknown Author')}</span>
                    <span><i class="fas fa-globe"></i> ${escapeHtml(article.domain || 'Unknown Source')}</span>
                    <span><i class="fas fa-calendar"></i> ${formatDate(article.publish_date)}</span>
                    <span><i class="fas fa-file-word"></i> ${article.word_count || 0} words</span>
                </div>
            `;
        }

        // Display quick insights
        function displayQuickInsights(analysis) {
            const insights = document.getElementById('quickInsights');
            const keyFindings = [];
            
            // Extract key findings from detailed analysis
            if (analysis.detailed_analysis) {
                if (analysis.detailed_analysis.bias_analysis?.findings?.length > 0) {
                    keyFindings.push(analysis.detailed_analysis.bias_analysis.findings[0]);
                }
                if (analysis.detailed_analysis.fact_checks?.findings?.length > 0) {
                    keyFindings.push(analysis.detailed_analysis.fact_checks.findings[0]);
                }
                if (analysis.detailed_analysis.source_credibility?.summary) {
                    keyFindings.push({
                        text: analysis.detailed_analysis.source_credibility.summary,
                        severity: 'info'
                    });
                }
            }
            
            insights.innerHTML = `
                <h3>Key Findings</h3>
                <div class="findings-list">
                    ${keyFindings.slice(0, 3).map(finding => `
                        <div class="finding-item ${finding.severity || 'info'}">
                            <i class="fas ${getFindingIcon(finding.severity)}"></i>
                            <span>${escapeHtml(finding.text || finding.summary || finding)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Get icon for finding severity
        function getFindingIcon(severity) {
            switch (severity) {
                case 'high':
                case 'critical':
                    return 'fa-exclamation-triangle';
                case 'medium':
                case 'warning':
                    return 'fa-exclamation-circle';
                case 'low':
                case 'info':
                    return 'fa-info-circle';
                case 'positive':
                    return 'fa-check-circle';
                default:
                    return 'fa-circle';
            }
        }

        // Display analysis cards
        function displayAnalysisCards(detailedAnalysis) {
            console.log('=== DISPLAYING ANALYSIS CARDS ===');
            console.log('Detailed analysis keys:', Object.keys(detailedAnalysis));
            
            const gridEl = document.getElementById('analysisGrid');
            gridEl.innerHTML = ''; // Clear existing cards
            
            // Priority 1 Cards - Always show first if available
            if (detailedAnalysis.author_analysis) {
                console.log('author_analysis found:', detailedAnalysis.author_analysis);
                console.log('author_analysis type:', typeof detailedAnalysis.author_analysis);
                console.log('author_analysis is empty object?', Object.keys(detailedAnalysis.author_analysis).length === 0);
                
                // Check if author_analysis is not just an empty object
                if (Object.keys(detailedAnalysis.author_analysis).length > 0) {
                    gridEl.appendChild(createAuthorAnalysisCard(detailedAnalysis.author_analysis));
                } else {
                    console.warn('author_analysis exists but is empty - creating basic card');
                    // Create a basic author card with just the name from article data
                    let authorNameFromArticle = currentAnalysis.article.author || 'Unknown Author';
                    
                    // Handle case where author is a URL (e.g., Guardian profile URLs)
                    if (authorNameFromArticle.startsWith('http')) {
                        // Try to extract name from URL
                        const urlParts = authorNameFromArticle.split('/');
                        const lastPart = urlParts[urlParts.length - 1];
                        if (lastPart) {
                            // Convert gabrielle-canon to Gabrielle Canon
                            authorNameFromArticle = lastPart
                                .split('-')
                                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                                .join(' ');
                        }
                    }
                    
                    const basicAuthorData = {
                        author_name: authorNameFromArticle,
                        author_score: 0,
                        level: 'Analysis Unavailable',
                        author_info: {
                            bio: 'Author analysis service did not return data.',
                            verified: false,
                            website: currentAnalysis.article.author.startsWith('http') ? currentAnalysis.article.author : null
                        },
                        summary: 'Author credibility analysis was not completed.',
                        is_basic: true
                    };
                    gridEl.appendChild(createAuthorAnalysisCard(basicAuthorData));
                }
            } else {
                console.warn('No author_analysis in detailedAnalysis - creating basic card');
                // Create a basic author card with just the name from article data
                if (currentAnalysis && currentAnalysis.article) {
                    let authorNameFromArticle = currentAnalysis.article.author || 'Unknown Author';
                    
                    // Handle case where author is a URL (e.g., Guardian profile URLs)
                    if (authorNameFromArticle.startsWith('http')) {
                        // Try to extract name from URL
                        const urlParts = authorNameFromArticle.split('/');
                        const lastPart = urlParts[urlParts.length - 1];
                        if (lastPart) {
                            // Convert gabrielle-canon to Gabrielle Canon
                            authorNameFromArticle = lastPart
                                .split('-')
                                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                                .join(' ');
                        }
                    }
                    
                    const basicAuthorData = {
                        author_name: authorNameFromArticle,
                        author_score: 0,
                        level: 'Analysis Unavailable',
                        author_info: {
                            bio: 'Author analysis service is not available.',
                            verified: false,
                            website: currentAnalysis.article.author.startsWith('http') ? currentAnalysis.article.author : null
                        },
                        summary: 'Author credibility analysis was not completed.',
                        is_basic: true
                    };
                    gridEl.appendChild(createAuthorAnalysisCard(basicAuthorData));
                }
            }
            
            if (detailedAnalysis.bias_analysis) {
                console.log('Creating bias card with data:', detailedAnalysis.bias_analysis);
                gridEl.appendChild(createBiasAnalysisCard(detailedAnalysis.bias_analysis));
            }
            
            // Priority 2 Cards
            if (detailedAnalysis.source_credibility) {
                console.log('Creating source card with data:', detailedAnalysis.source_credibility);
                gridEl.appendChild(createSourceCredibilityCard(detailedAnalysis.source_credibility));
            }
            
            if (detailedAnalysis.transparency_analysis) {
                console.log('Creating transparency card with data:', detailedAnalysis.transparency_analysis);
                gridEl.appendChild(createTransparencyCard(detailedAnalysis.transparency_analysis));
            }
            
            if (detailedAnalysis.fact_checks) {
                console.log('Creating fact check card with data:', detailedAnalysis.fact_checks);
                gridEl.appendChild(createFactCheckCard(detailedAnalysis.fact_checks));
            }
            
            if (detailedAnalysis.manipulation_analysis) {
                console.log('Creating manipulation card with data:', detailedAnalysis.manipulation_analysis);
                gridEl.appendChild(createManipulationCard(detailedAnalysis.manipulation_analysis));
            }
            
            if (detailedAnalysis.content_analysis) {
                console.log('Creating content card with data:', detailedAnalysis.content_analysis);
                gridEl.appendChild(createContentAnalysisCard(detailedAnalysis.content_analysis));
            }
            
            // Auto-expand first 3 cards
            const cards = gridEl.querySelectorAll('.analysis-card');
            cards.forEach((card, index) => {
                if (index < 3) {
                    setTimeout(() => {
                        card.classList.add('expanded');
                    }, (index + 1) * 100);
                }
                card.style.animationDelay = `${index * 0.1}s`;
            });
        }

        // ENHANCED: Create Author Analysis Card with all available information
        function createAuthorAnalysisCard(authorData) {
            const card = document.createElement('div');
            card.className = 'analysis-card';
            
            console.log('=== AUTHOR ANALYSIS CARD DEBUG ===');
            console.log('Raw authorData:', authorData);
            console.log('authorData type:', typeof authorData);
            console.log('authorData keys:', authorData ? Object.keys(authorData) : 'null');
            
            // Handle case where no data is provided
            if (!authorData || (typeof authorData === 'object' && Object.keys(authorData).length === 0)) {
                console.error('No author data provided to createAuthorAnalysisCard');
                
                const header = createCardHeader(
                    'Author Analysis',
                    'fa-user-check',
                    'Author information not available'
                );
                
                const content = document.createElement('div');
                content.className = 'card-content';
                content.innerHTML = '<div class="card-content-inner"><p>Author analysis data is not available for this article.</p></div>';
                
                card.appendChild(header);
                card.appendChild(content);
                return card;
            }
            
            // Extract data - handle both direct data and nested data.data structure
            const data = authorData.data || authorData;
            
            const header = createCardHeader(
                'Author Analysis',
                'fa-user-check',
                'Verification of author credentials and expertise'
            );
            header.onclick = () => toggleCard(card);
            
            const content = document.createElement('div');
            content.className = 'card-content';
            
            // Extract all author information with comprehensive fallbacks
            let authorName = data.author_name || data.name || data.author || 'Unknown Author';
            let authorScore = data.credibility_score || data.author_score || data.score || 50;
            let authorBio = data.bio || data.description || '';
            let authorPosition = data.position || data.current_position || '';
            let authorWebsite = data.website || data.url || '';
            let authorPhoto = data.photo || data.image || data.avatar || '';
            let isVerified = data.is_verified || data.verified || false;
            let articlesCount = data.articles_count || data.article_count || data.total_articles || 0;
            let yearsExperience = data.years_experience || data.experience_years || 0;
            let expertiseAreas = data.expertise_areas || data.expertise || [];
            let outlets = data.outlets || [];
            let awards = data.awards || [];
            let socialMedia = data.social_media || data.twitter || '';
            
            // Check for author_info nested structure
            const authorInfo = data.author_info || {};
            if (authorInfo.bio) authorBio = authorInfo.bio;
            if (authorInfo.position) authorPosition = authorInfo.position;
            if (authorInfo.verified !== undefined) isVerified = authorInfo.verified;
            if (authorInfo.experience_years) yearsExperience = authorInfo.experience_years;
            if (authorInfo.expertise_areas) expertiseAreas = authorInfo.expertise_areas;
            if (authorInfo.outlets) outlets = authorInfo.outlets;
            if (authorInfo.awards) awards = authorInfo.awards;
            
            let contentHtml = '';
            
            // Handle basic/fallback case
            if (data.is_basic) {
                contentHtml = '<div class="card-content-inner">';
                contentHtml += `
                    <div class="author-info-section">
                        <div class="author-header">
                            <div class="author-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="author-details">
                                <h5>${escapeHtml(authorName)}</h5>
                                <p><i class="fas fa-exclamation-triangle" style="color: var(--warning)"></i> Analysis Not Available</p>
                            </div>
                        </div>
                        <div class="author-bio" style="color: var(--neutral); font-style: italic;">
                            The author analysis service did not return data for this article. 
                            This may be due to service unavailability or processing errors.
                        </div>
                        ${authorWebsite ? `<a href="${escapeHtml(authorWebsite)}" target="_blank" class="author-link"><i class="fas fa-external-link-alt"></i> View Author Profile</a>` : ''}
                    </div>
                    <div class="card-sections">
                        <div class="card-section">
                            <div class="section-label">
                                <i class="fas fa-info-circle"></i>
                                What We Know
                            </div>
                            <div class="section-content">
                                Author Name: ${escapeHtml(authorName)}
                                ${authorName === 'Unknown Author' ? 
                                    '<br>This article does not have author attribution, which significantly reduces credibility.' :
                                    '<br>We were unable to verify additional information about this author.'
                                }
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Enhanced display with all available information
                contentHtml = '<div class="card-content-inner">';
                contentHtml += `
                    <div class="author-info-section">
                        <div class="author-header">
                            <div class="author-avatar">
                                ${authorPhoto ? 
                                    `<img src="${escapeHtml(authorPhoto)}" alt="${escapeHtml(authorName)}" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\"fas fa-user\"></i>';">` : 
                                    '<i class="fas fa-user"></i>'
                                }
                            </div>
                            <div class="author-details">
                                <h5 class="author-name">${escapeHtml(authorName)}
                                    ${isVerified ? '<i class="fas fa-check-circle" style="color: var(--success); margin-left: 0.5rem;" title="Verified Journalist"></i>' : ''}
                                </h5>
                                ${authorPosition ? `<p class="author-position">${escapeHtml(authorPosition)}</p>` : ''}
                                <div class="author-credentials">
                                    ${isVerified ? '<span class="credential-badge"><i class="fas fa-check"></i> Verified</span>' : ''}
                                    ${yearsExperience > 0 ? `<span class="credential-badge"><i class="fas fa-calendar-alt"></i> ${yearsExperience}+ years</span>` : ''}
                                    ${articlesCount > 0 ? `<span class="credential-badge"><i class="fas fa-newspaper"></i> ${articlesCount} articles</span>` : ''}
                                </div>
                            </div>
                        </div>
                        
                        ${authorBio ? `<div class="author-bio">${escapeHtml(authorBio)}</div>` : ''}
                        
                        ${authorWebsite ? `<a href="${escapeHtml(authorWebsite)}" target="_blank" class="author-link"><i class="fas fa-external-link-alt"></i> View Author Profile</a>` : ''}
                        ${socialMedia && socialMedia.includes('@') ? `<a href="https://twitter.com/${socialMedia.replace('@', '')}" target="_blank" class="author-link"><i class="fab fa-twitter"></i> ${escapeHtml(socialMedia)}</a>` : ''}
                    `;
            
                // Add outlets if available
                if (outlets.length > 0) {
                    contentHtml += `
                        <div class="author-outlets">
                            <h6>Published In:</h6>
                            <div class="outlet-list">
                                ${outlets.map(outlet => `<span class="outlet-badge">${escapeHtml(outlet)}</span>`).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Add expertise areas if available
                if (expertiseAreas.length > 0) {
                    contentHtml += `
                        <div class="expertise-areas">
                            <h6>Areas of Expertise:</h6>
                            ${expertiseAreas.map(area => `<span class="expertise-tag">${escapeHtml(area)}</span>`).join('')}
                        </div>
                    `;
                }
                
                // Add awards if available
                if (awards.length > 0) {
                    contentHtml += `
                        <div class="author-awards">
                            <h6>Awards & Recognition:</h6>
                            ${awards.map(award => `<div class="award-item">${escapeHtml(award)}</div>`).join('')}
                        </div>
                    `;
                }
                
                contentHtml += '</div>';
                
                // Enhanced credibility metrics
                contentHtml += `
                    <div class="visual-element">
                        <div class="stat-grid">
                            <div class="stat-item">
                                <span class="stat-value">${authorScore}</span>
                                <span class="stat-label">Credibility Score</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${articlesCount || 'N/A'}</span>
                                <span class="stat-label">Articles Published</span>
                            </div>
                            ${yearsExperience > 0 ? `
                                <div class="stat-item">
                                    <span class="stat-value">${yearsExperience}+</span>
                                    <span class="stat-label">Years Experience</span>
                                </div>
                            ` : ''}
                            ${awards.length > 0 ? `
                                <div class="stat-item">
                                    <span class="stat-value">${awards.length}</span>
                                    <span class="stat-label">Awards</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                // Add the standard 4 sections
                contentHtml += `
                    <div class="card-sections">
                        <div class="card-section">
                            <div class="section-label">
                                <i class="fas fa-search"></i>
                                What This Analysis Covers
                            </div>
                            <div class="section-content">
                                We verify author identity, check professional credentials, analyze publication history, assess expertise areas, and evaluate overall journalistic credibility.
                            </div>
                        </div>
                        
                        <div class="card-section">
                            <div class="section-label">
                                <i class="fas fa-microscope"></i>
                                How We Analyze
                            </div>
                            <div class="section-content">
                                Our system searches multiple journalist databases, cross-references bylines across publications, verifies social media profiles, and analyzes the author's previous work for consistency and expertise.
                            </div>
                        </div>
                        
                        <div class="card-section">
                            <div class="section-label">
                                <i class="fas fa-clipboard-check"></i>
                                What We Found
                            </div>
                            <div class="section-content">
                                ${generateAuthorFindings(data, authorScore, isVerified, articlesCount, yearsExperience, authorPosition, outlets)}
                            </div>
                        </div>
                        
                        <div class="card-section">
                            <div class="section-label">
                                <i class="fas fa-lightbulb"></i>
                                What This Means
                            </div>
                            <div class="section-content">
                                ${data.interpretation || data.meaning || generateAuthorMeaning(authorScore, isVerified)}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = contentHtml;
            
            card.appendChild(header);
            card.appendChild(content);
            
            return card;
        }
        
        // Enhanced helper function to generate author findings
        function generateAuthorFindings(data, score, isVerified, articlesCount, yearsExperience, position, outlets) {
            let findings = [];
            
            // Check if this is an anonymous article
            const authorName = data.author_name || 'Unknown';
            if (authorName === 'Unknown Author' || data.is_anonymous) {
                findings.push('No author attribution found for this article.');
                findings.push('Anonymous articles have significantly reduced credibility and accountability.');
                return findings.join(' ');
            }
            
            // Add credibility score finding with context
            if (score >= 80) {
                findings.push(`Author has an excellent credibility score of ${score}/100.`);
            } else if (score >= 60) {
                findings.push(`Author has a good credibility score of ${score}/100.`);
            } else if (score >= 40) {
                findings.push(`Author has a moderate credibility score of ${score}/100.`);
            } else {
                findings.push(`Author has a low credibility score of ${score}/100.`);
            }
            
            // Add verification status with detail
            if (isVerified) {
                findings.push('This is a verified journalist with established credentials in professional journalism.');
            } else {
                findings.push('We could not verify this author\'s professional journalist credentials through established databases.');
            }
            
            // Add experience findings
            if (yearsExperience > 0) {
                findings.push(`The author has ${yearsExperience}+ years of journalism experience.`);
            }
            
            // Add position findings
            if (position) {
                findings.push(`Currently holds the position of ${position}.`);
            }
            
            // Add publication history
            if (articlesCount > 0) {
                findings.push(`Has published ${articlesCount} articles across various topics.`);
            }
            
            // Add outlet information
            if (outlets && outlets.length > 0) {
                findings.push(`Has been published in ${outlets.length} different news outlets including ${outlets.slice(0, 3).join(', ')}.`);
            }
            
            // Add any specific findings from the data
            if (data.findings && Array.isArray(data.findings)) {
                data.findings.forEach(finding => {
                    if (finding.text) {
                        findings.push(finding.text);
                    }
                });
            }
            
            return findings.join(' ');
        }
        
        // Helper function to generate author meaning
        function generateAuthorMeaning(score, isVerified) {
            if (score >= 80 && isVerified) {
                return 'This article is written by a highly credible, verified journalist with established expertise. You can have high confidence in the author\'s credibility and professional standards.';
            } else if (score >= 60) {
                return 'The author shows good credibility indicators. While some verification details may be limited, the available information suggests reliable journalism practices.';
            } else if (score >= 40) {
                return 'The author has mixed credibility indicators. Consider the content carefully and cross-reference important claims with other sources.';
            } else {
                return 'Limited information is available about this author\'s credibility. Exercise caution and verify key claims independently.';
            }
        }

        // Create other analysis cards...
        function createBiasAnalysisCard(biasData) {
            const card = document.createElement('div');
            card.className = 'analysis-card';
            
            const data = biasData.data || biasData;
            
            const header = createCardHeader(
                'Bias Analysis',
                'fa-balance-scale',
                'Detection of political, ideological, or editorial bias'
            );
            header.onclick = () => toggleCard(card);
            
            const content = document.createElement('div');
            content.className = 'card-content';
            
            const biasLevel = data.bias_level || data.level || 'Unknown';
            const biasScore = data.bias_score || data.score || 50;
            
            let contentHtml = '<div class="card-content-inner"><div class="card-sections">';
            
            // All 4 required sections
            contentHtml += `
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-search"></i>
                        What This Analysis Covers
                    </div>
                    <div class="section-content">
                        We analyze language patterns, word choices, framing techniques, source selection, and narrative structure to identify potential biases in news reporting.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-microscope"></i>
                        How We Analyze
                    </div>
                    <div class="section-content">
                        Our AI examines emotional language, loaded terms, one-sided arguments, cherry-picked facts, and missing context to determine bias levels across multiple dimensions.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-clipboard-check"></i>
                        What We Found
                    </div>
                    <div class="section-content">
                        ${data.summary || `This article shows ${biasLevel.toLowerCase()} bias with a score of ${biasScore}/100. ${data.findings && data.findings.length > 0 ? data.findings[0].text : ''}`}
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-lightbulb"></i>
                        What This Means
                    </div>
                    <div class="section-content">
                        ${data.interpretation || data.meaning || 'Understanding bias helps you read critically and form balanced opinions. Consider seeking multiple perspectives on this topic.'}
                    </div>
                </div>
            `;
            
            contentHtml += '</div></div>';
            content.innerHTML = contentHtml;
            
            card.appendChild(header);
            card.appendChild(content);
            
            return card;
        }

        // Create Source Credibility Card
        function createSourceCredibilityCard(sourceData) {
            const card = document.createElement('div');
            card.className = 'analysis-card';
            
            const data = sourceData.data || sourceData;
            
            const header = createCardHeader(
                'Source Credibility',
                'fa-newspaper',
                'Assessment of the publication\'s reliability and track record'
            );
            header.onclick = () => toggleCard(card);
            
            const content = document.createElement('div');
            content.className = 'card-content';
            
            let contentHtml = '<div class="card-content-inner"><div class="card-sections">';
            
            // All 4 required sections
            contentHtml += `
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-search"></i>
                        What This Analysis Covers
                    </div>
                    <div class="section-content">
                        We evaluate the news source's reputation, fact-checking record, editorial standards, transparency policies, and historical accuracy.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-microscope"></i>
                        How We Analyze
                    </div>
                    <div class="section-content">
                        We reference trusted media bias databases, analyze the outlet's track record, check for corrections policies, and assess their journalistic standards.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-clipboard-check"></i>
                        What We Found
                    </div>
                    <div class="section-content">
                        ${data.summary || `This source has a ${data.credibility_level || 'moderate'} credibility rating with a score of ${data.credibility_score || data.score || 50}/100.`}
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-lightbulb"></i>
                        What This Means
                    </div>
                    <div class="section-content">
                        ${data.interpretation || data.meaning || 'Source credibility indicates the general reliability of the publication. Higher scores suggest more trustworthy reporting practices.'}
                    </div>
                </div>
            `;
            
            contentHtml += '</div></div>';
            content.innerHTML = contentHtml;
            
            card.appendChild(header);
            card.appendChild(content);
            
            return card;
        }

        // Create Transparency Card
        function createTransparencyCard(transparencyData) {
            const card = document.createElement('div');
            card.className = 'analysis-card';
            
            const data = transparencyData.data || transparencyData;
            
            const header = createCardHeader(
                'Transparency Analysis',
                'fa-eye',
                'Evaluation of disclosure and attribution practices'
            );
            header.onclick = () => toggleCard(card);
            
            const content = document.createElement('div');
            content.className = 'card-content';
            
            let contentHtml = '<div class="card-content-inner"><div class="card-sections">';
            
            // All 4 required sections
            contentHtml += `
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-search"></i>
                        What This Analysis Covers
                    </div>
                    <div class="section-content">
                        We check for author attribution, source citations, conflict of interest disclosures, correction policies, and funding transparency.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-microscope"></i>
                        How We Analyze
                    </div>
                    <div class="section-content">
                        We scan for bylines, quoted sources, disclosure statements, update notices, and other transparency indicators that demonstrate journalistic accountability.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-clipboard-check"></i>
                        What We Found
                    </div>
                    <div class="section-content">
                        ${data.summary || `This article has a transparency score of ${data.transparency_score || data.score || 50}%. ${data.findings && data.findings.length > 0 ? data.findings[0].text : ''}`}
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-lightbulb"></i>
                        What This Means
                    </div>
                    <div class="section-content">
                        ${data.interpretation || data.meaning || 'Transparent journalism practices allow readers to verify information and understand potential conflicts of interest.'}
                    </div>
                </div>
            `;
            
            contentHtml += '</div></div>';
            content.innerHTML = contentHtml;
            
            card.appendChild(header);
            card.appendChild(content);
            
            return card;
        }

        // Create Fact Check Card
        function createFactCheckCard(factCheckData) {
            const card = document.createElement('div');
            card.className = 'analysis-card';
            
            const data = factCheckData.data || factCheckData;
            
            const header = createCardHeader(
                'Fact Verification',
                'fa-check-double',
                'Verification of claims and factual accuracy'
            );
            header.onclick = () => toggleCard(card);
            
            const content = document.createElement('div');
            content.className = 'card-content';
            
            let contentHtml = '<div class="card-content-inner"><div class="card-sections">';
            
            // All 4 required sections
            contentHtml += `
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-search"></i>
                        What This Analysis Covers
                    </div>
                    <div class="section-content">
                        We identify key claims, verify statistics, check quotes, validate sources, and cross-reference facts with authoritative databases.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-microscope"></i>
                        How We Analyze
                    </div>
                    <div class="section-content">
                        Our system extracts factual claims, searches trusted databases, compares with official sources, and identifies potential misinformation patterns.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-clipboard-check"></i>
                        What We Found
                    </div>
                    <div class="section-content">
                        ${data.summary || `Fact verification score: ${data.fact_score || data.score || 50}/100. ${data.verified_claims || 0} claims verified, ${data.unverified_claims || 0} unverified.`}
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-lightbulb"></i>
                        What This Means
                    </div>
                    <div class="section-content">
                        ${data.interpretation || data.meaning || 'Fact verification helps identify accurate reporting. Higher scores indicate more verifiable claims and reliable information.'}
                    </div>
                </div>
            `;
            
            contentHtml += '</div></div>';
            content.innerHTML = contentHtml;
            
            card.appendChild(header);
            card.appendChild(content);
            
            return card;
        }

        // Create Manipulation Detection Card
        function createManipulationCard(manipulationData) {
            const card = document.createElement('div');
            card.className = 'analysis-card';
            
            const data = manipulationData.data || manipulationData;
            
            const header = createCardHeader(
                'Manipulation Detection',
                'fa-mask',
                'Identification of misleading tactics and emotional manipulation'
            );
            header.onclick = () => toggleCard(card);
            
            const content = document.createElement('div');
            content.className = 'card-content';
            
            let contentHtml = '<div class="card-content-inner"><div class="card-sections">';
            
            // All 4 required sections
            contentHtml += `
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-search"></i>
                        What This Analysis Covers
                    </div>
                    <div class="section-content">
                        We detect emotional manipulation, misleading headlines, cherry-picked data, false equivalencies, and other persuasion tactics.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-microscope"></i>
                        How We Analyze
                    </div>
                    <div class="section-content">
                        We analyze headline accuracy, emotional language intensity, logical fallacies, data presentation, and narrative framing techniques.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-clipboard-check"></i>
                        What We Found
                    </div>
                    <div class="section-content">
                        ${data.summary || `Manipulation level: ${data.manipulation_level || data.level || 'Low'}. ${data.tactics_found || 0} manipulation tactics detected.`}
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-lightbulb"></i>
                        What This Means
                    </div>
                    <div class="section-content">
                        ${data.interpretation || data.meaning || 'Articles free from manipulation tactics allow readers to form their own opinions based on facts rather than being emotionally or psychologically influenced.'}
                    </div>
                </div>
            `;
            
            contentHtml += '</div></div>';
            content.innerHTML = contentHtml;
            
            card.appendChild(header);
            card.appendChild(content);
            
            return card;
        }

        // Create Content Analysis Card
        function createContentAnalysisCard(contentData) {
            const card = document.createElement('div');
            card.className = 'analysis-card';
            
            const data = contentData.data || contentData;
            
            const header = createCardHeader(
                'Content Analysis',
                'fa-file-alt',
                'Assessment of article quality and structure'
            );
            header.onclick = () => toggleCard(card);
            
            const content = document.createElement('div');
            content.className = 'card-content';
            
            let contentHtml = '<div class="card-content-inner"><div class="card-sections">';
            
            // All 4 required sections
            contentHtml += `
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-search"></i>
                        What This Analysis Covers
                    </div>
                    <div class="section-content">
                        We analyze article structure, writing quality, readability, topic coverage depth, and overall content quality to assess professional journalism standards.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-microscope"></i>
                        How We Analyze
                    </div>
                    <div class="section-content">
                        We evaluate readability scores, sentence structure, vocabulary usage, content organization, and compare against professional journalism benchmarks.
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-clipboard-check"></i>
                        What We Found
                    </div>
                    <div class="section-content">
                        ${data.summary || `Content quality score: ${data.quality_score || data.score || 50}/100. Readability: ${data.readability_level || 'College level'}.`}
                    </div>
                </div>
                
                <div class="card-section">
                    <div class="section-label">
                        <i class="fas fa-lightbulb"></i>
                        What This Means
                    </div>
                    <div class="section-content">
                        ${data.interpretation || data.meaning || 'Well-structured articles with appropriate complexity indicate professional journalism. Quality content helps readers understand complex topics clearly.'}
                    </div>
                </div>
            `;
            
            contentHtml += '</div></div>';
            content.innerHTML = contentHtml;
            
            card.appendChild(header);
            card.appendChild(content);
            
            return card;
        }

        // Helper function to create card header
        function createCardHeader(title, icon, description) {
            const header = document.createElement('div');
            header.className = 'card-header';
            header.innerHTML = `
                <div class="card-title">
                    <i class="fas ${icon}"></i>
                    <h3>${title}</h3>
                </div>
                <div class="card-description">${description}</div>
                <i class="fas fa-chevron-down card-toggle"></i>
            `;
            return header;
        }

        // Toggle card expansion
        function toggleCard(card) {
            card.classList.toggle('expanded');
        }

        // Reset analysis
        function resetAnalysis() {
            document.getElementById('urlInput').value = '';
            document.getElementById('textInput').value = '';
            document.getElementById('resultsSection').style.display = 'none';
            currentAnalysis = null;
        }

        // Show error message
        function showError(message) {
            // Create or update error element
            let errorEl = document.getElementById('errorMessage');
            if (!errorEl) {
                errorEl = document.createElement('div');
                errorEl.id = 'errorMessage';
                errorEl.className = 'error-message';
                document.querySelector('.input-section').appendChild(errorEl);
            }
            
            errorEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            errorEl.style.display = 'block';
            
            // Hide after 5 seconds
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, m => map[m]);
        }

        // Download report
        function downloadReport() {
            if (!currentAnalysis) {
                showError('No analysis available to download');
                return;
            }
            
            // For now, just show a message
            // In production, this would generate and download a PDF
            alert('PDF download feature coming soon! This will allow you to save a complete analysis report.');
            
            // In a real implementation, this would:
            // 1. Call a backend API to generate the PDF
            // 2. Download the generated PDF file
            // For now, we'll just log the data
            console.log('PDF Download requested for:', currentAnalysis);
        }

        // Debug helper
        window.debugTruthLens = () => {
            console.log('Current Analysis:', currentAnalysis);
            console.log('Is Analyzing:', isAnalyzing);
            
            if (currentAnalysis && currentAnalysis.detailed_analysis) {
                console.log('\n=== DETAILED ANALYSIS BREAKDOWN ===');
                Object.entries(currentAnalysis.detailed_analysis).forEach(([service, data]) => {
                    console.log(`\n${service.toUpperCase()}:`);
                    console.log(data);
                });
            }
            
            return currentAnalysis;
        };
        
        // Add a function to manually refresh cards with current data
        window.refreshCards = () => {
            if (currentAnalysis && currentAnalysis.detailed_analysis) {
                displayAnalysisCards(currentAnalysis.detailed_analysis);
            } else {
                console.error('No analysis data available');
            }
        };
    </script>
</body>
</html>

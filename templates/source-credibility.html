<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Source Credibility Analysis - TruthLens</title>
    
    <!-- Icons & Fonts -->
    <link rel="icon" type="image/png" href="/static/images/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/service-page-shared.css">
    <link rel="stylesheet" href="/static/css/source-credibility.css">
</head>
<body>
    <!-- Header -->
    <header class="service-header">
        <div class="header-content">
            <a href="/" class="back-button">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Analysis</span>
            </a>
            
            <div class="service-title">
                <h1>
                    <i class="fas fa-shield-alt service-icon"></i>
                    <span>Source Credibility</span>
                </h1>
            </div>
            
            <div style="width: 180px;"></div> <!-- Spacer for balance -->
        </div>
    </header>

    <!-- Analysis Summary Section -->
    <section class="analysis-summary" id="analysisSummary">
        <div class="summary-content">
            <div class="summary-score">
                <div class="score-circle">
                    <div>
                        <div class="score-value" id="summaryScore">--</div>
                        <div class="score-label">Credibility Score</div>
                    </div>
                </div>
            </div>
            
            <div class="summary-details">
                <h2>Analysis Summary</h2>
                
                <div class="summary-item">
                    <h3><i class="fas fa-file-alt"></i> What We Analyzed</h3>
                    <p id="analyzedContent">Loading article information...</p>
                </div>
                
                <div class="summary-item">
                    <h3><i class="fas fa-search"></i> What We Found</h3>
                    <p id="keyFindings">Analyzing content...</p>
                </div>
                
                <div class="summary-item">
                    <h3><i class="fas fa-lightbulb"></i> What This Means</h3>
                    <p id="interpretation">Processing results...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content Area -->
    <main class="service-content" id="serviceContent">
        <div class="loading-container" id="loadingState">
            <div class="loading-spinner"></div>
            <p>Loading source credibility analysis...</p>
        </div>
        
        <div class="error-container" id="errorState" style="display: none;">
            <i class="fas fa-exclamation-circle error-icon"></i>
            <h2>Analysis Not Available</h2>
            <p id="errorMessage">Source credibility analysis was not performed for this article.</p>
            <a href="/" class="return-button" style="margin-top: 1.5rem; display: inline-flex;">
                <i class="fas fa-arrow-left"></i>
                <span>Return to Main Analysis</span>
            </a>
        </div>
        
        <!-- Service-specific content will be inserted here -->
        <div id="analysisContent" style="display: none;">
            <!-- Dynamic content -->
        </div>
    </main>

    <!-- Scripts -->
    <!-- CRITICAL: Define SERVICE_CONFIG before loading other scripts -->
    <script>
        // Service-specific configuration - MUST be defined before service-navigation.js loads
        window.SERVICE_CONFIG = {
            id: 'source_credibility',
            name: 'Source Credibility',
            icon: 'fa-shield-alt'
        };
        console.log('SERVICE_CONFIG defined at script load:', window.SERVICE_CONFIG);
    </script>
    
    <!-- Load scripts in proper order -->
    <script src="/static/js/config.js"></script>
    <script src="/static/js/truthlens-services.js"></script>
    <script src="/static/js/service-navigation.js"></script>
    
    <!-- Service-specific functions -->
    <script>
        // FIXED: These functions will be used by service-navigation.js
        
        function populateSummary(fullData, serviceData) {
            // Article information
            const article = fullData.article || {};
            const articleInfo = `"${article.title || 'Untitled Article'}" from ${article.source || article.domain || 'Unknown Source'}`;
            document.getElementById('analyzedContent').textContent = articleInfo;

            // Service-specific score and findings
            const scoreInfo = getServiceScoreInfo(serviceData);
            document.getElementById('summaryScore').textContent = scoreInfo.score;
            
            // Key findings
            document.getElementById('keyFindings').textContent = getServiceKeyFindings(serviceData);
            
            // Interpretation
            document.getElementById('interpretation').textContent = getServiceInterpretation(serviceData);
        }

        function getServiceScoreInfo(data) {
            // Extract credibility score from service data
            const score = data.credibility_score || data.score || 0;
            return {
                score: Math.round(score),
                label: 'Credibility Score'
            };
        }

        function getServiceKeyFindings(data) {
            const score = data.credibility_score || data.score || 0;
            const level = data.credibility_level || data.level || 'Unknown';
            const sourceName = data.source_name || 'This source';
            
            let findings = `${sourceName} has ${level.toLowerCase()} credibility. `;
            
            if (data.in_database) {
                findings += `Listed in credibility database. `;
                if (data.bias && data.bias !== 'Unknown') {
                    findings += `Known bias: ${data.bias}. `;
                }
            } else {
                findings += `Not in credibility database. `;
            }
            
            if (data.domain_age_years) {
                findings += `Domain age: ${Math.round(data.domain_age_years)} years.`;
            }
            
            return findings;
        }

        function getServiceInterpretation(data) {
            const score = data.credibility_score || data.score || 0;
            const sourceName = data.source_name || 'This source';
            
            if (score >= 80) {
                return `${sourceName} is a highly credible news source with strong journalistic standards, transparent practices, and a solid reputation. Information from this source is generally reliable and well-vetted.`;
            } else if (score >= 60) {
                return `${sourceName} demonstrates reasonable credibility with generally good journalistic practices. While mostly reliable, some caution is advised when consuming content from this source.`;
            } else if (score >= 40) {
                return `${sourceName} shows moderate credibility concerns. The source may lack transparency or have occasional issues with accuracy. Verify important information through additional sources.`;
            } else if (score >= 20) {
                return `${sourceName} has significant credibility issues including poor transparency, questionable practices, or a history of misinformation. Exercise caution and seek alternative sources.`;
            } else {
                return `${sourceName} lacks basic credibility indicators and fails to meet journalistic standards. Content from this source should not be considered reliable without extensive verification.`;
            }
        }

        function displayServiceAnalysis(data) {
            // Hide loading, show content
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('analysisContent').style.display = 'block';
            
            // FIXED: Use the renderer from truthlens-services.js
            if (window.truthLensApp && window.truthLensApp.services) {
                const content = window.truthLensApp.services.renderSourceCredibility(data);
                document.getElementById('analysisContent').innerHTML = content;
            } else {
                // Fallback if services not loaded
                const services = new TruthLensServices({ 
                    utils: { 
                        getScoreColor: (s) => s >= 60 ? '#10b981' : '#ef4444' 
                    }
                });
                const content = services.renderSourceCredibility(data);
                document.getElementById('analysisContent').innerHTML = content;
            }
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        // Note: The DOMContentLoaded listener is no longer needed here
        // service-navigation.js will handle initialization
    </script>
</body>
</html>
